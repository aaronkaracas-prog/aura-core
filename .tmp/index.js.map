{
  "version": 3,
  "sources": ["../src/index.js"],
  "sourceRoot": ".tmp",
  "sourcesContent": ["\uFEFF/**\n * aura-core \u2014 Cloudflare Worker (single-file)\n *\n * FILE: C:\\Users\\Aaron Karacas\\aura-worker\\aura\\src\\index.js\n *\n * Guarantees:\n * - Keeps /core, /chat, /image, /__version working\n * - Adds generic self-publishing sites: GET /site/<slug>\n * - Adds legacy convenience route: GET /malibu -> /site/malibu\n * - Adds protected admin endpoints (X-Core-Pass must equal CORE_PASS secret):\n *     POST /admin/ui\n *     POST /admin/ui/reset\n *     POST /admin/dir/seed\n *     POST /admin/dir/get\n *     POST /admin/site/set\n *     POST /admin/site/reset\n *     POST /admin/site/list\n *\n * Storage:\n * - Uses ONE KV binding: env.AURA_KV\n * - Keys:\n *     AURA_CORE_UI              (HTML string override for /core)\n *     AURA_DIRECTORY            (directory JSON)\n *     SITE_HTML:<slug>          (HTML string for /site/<slug>)\n *\n * Notes:\n * - This file does NOT redesign /core beyond a minimal, clickable, functional UI\n *   with typing + upload (+) + mic button placeholder, and image rendering.\n * - If you already have OpenAI wired, set env.OPENAI_API_KEY and optional models:\n *     env.CHAT_MODEL (default: \"gpt-4.1-mini\")\n *     env.IMAGE_MODEL (default: \"gpt-image-1\")\n */\n\nconst VERSION = \"aura-core-2026-01-13\";\nconst BUILD_ID = \"site-publisher-v1\";\nconst JSON_HEADERS = {\n  \"Content-Type\": \"application/json; charset=utf-8\",\n};\n\nfunction json(data, status = 200, extraHeaders = {}) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { ...JSON_HEADERS, ...extraHeaders },\n  });\n}\n\nfunction text(str, status = 200, extraHeaders = {}) {\n  return new Response(str, {\n    status,\n    headers: { \"Content-Type\": \"text/plain; charset=utf-8\", ...extraHeaders },\n  });\n}\n\nfunction html(str, status = 200, extraHeaders = {}) {\n  return new Response(str, {\n    status,\n    headers: { \"Content-Type\": \"text/html; charset=utf-8\", ...extraHeaders },\n  });\n}\n\nfunction badRequest(msg = \"bad_request\", detail) {\n  return json({ ok: false, error: msg, detail }, 400);\n}\n\nfunction unauthorized(msg = \"unauthorized\") {\n  return json({ ok: false, error: msg }, 401);\n}\n\nfunction notFound() {\n  return text(\"Not found\", 404);\n}\n\nfunction methodNotAllowed() {\n  return text(\"Method Not Allowed\", 405);\n}\n\nfunction getHeader(request, name) {\n  return request.headers.get(name) || request.headers.get(name.toLowerCase()) || \"\";\n}\n\nfunction safeSlug(input) {\n  const s = String(input || \"\")\n    .trim()\n    .toLowerCase()\n    .replace(/[^a-z0-9\\-_.]/g, \"-\")\n    .replace(/-+/g, \"-\")\n    .replace(/^[-.]+|[-.]+$/g, \"\");\n  if (!s) return null;\n  // keep it sane\n  if (s.length > 80) return s.slice(0, 80);\n  return s;\n}\n\nasync function readBodyText(request) {\n  // Works for text/plain, text/html, application/json (raw)\n  return await request.text();\n}\n\nasync function readBodyJson(request) {\n  try {\n    const clone = request.clone();\n    const t = await clone.text();\n    if (!t || !t.trim()) return null;\n    return JSON.parse(t);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction requireAdmin(request, env) {\n  const pass = getHeader(request, \"X-Core-Pass\");\n  if (!env || typeof env.CORE_PASS !== \"string\" || !env.CORE_PASS) return false;\n  return pass && pass === env.CORE_PASS;\n}\n\nasync function kvGet(env, key) {\n  if (!env?.AURA_KV) throw new Error(\"missing_kv_binding_AURA_KV\");\n  return await env.AURA_KV.get(key);\n}\n\nasync function kvPut(env, key, value) {\n  if (!env?.AURA_KV) throw new Error(\"missing_kv_binding_AURA_KV\");\n  await env.AURA_KV.put(key, value);\n}\n\nasync function kvDel(env, key) {\n  if (!env?.AURA_KV) throw new Error(\"missing_kv_binding_AURA_KV\");\n  await env.AURA_KV.delete(key);\n}\n\nfunction defaultCoreUI() {\n  // Minimal, clickable, self-contained.\n  // Keeps typing + upload (+) + mic button placeholder + image rendering.\n  // Does NOT attempt to embed any city guide here.\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>\n  <title>Aura Core</title>\n  <style>\n    :root { --bg:#0b0f14; --panel:#0f1620; --muted:#8aa0b5; --text:#e8f0f7; --line:rgba(255,255,255,.10); }\n    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}\n    .wrap{height:100%; display:flex;}\n    .left{width:260px; border-right:1px solid var(--line); background:linear-gradient(180deg,#0e1621,#0b0f14); padding:14px; box-sizing:border-box;}\n    .brand{font-weight:800; letter-spacing:.6px; margin-bottom:10px;}\n    .small{font-size:12px; color:var(--muted); line-height:1.35;}\n    .link{display:block; margin-top:12px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; color:var(--text); text-decoration:none;}\n    .link:hover{border-color:rgba(255,255,255,.22)}\n    .main{flex:1; display:flex; flex-direction:column; min-width:0;}\n    .top{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; gap:10px; align-items:center;}\n    .pill{font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px;}\n    .msgs{flex:1; overflow:auto; padding:14px; box-sizing:border-box;}\n    .msg{max-width:920px; margin:0 auto 12px auto; padding:12px 12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03);}\n    .msg .role{font-weight:700; font-size:12px; color:var(--muted); margin-bottom:6px; letter-spacing:.3px;}\n    .msg .body{white-space:pre-wrap; line-height:1.35;}\n    .msg img{max-width:100%; border-radius:12px; display:block; margin-top:10px; border:1px solid var(--line);}\n    .composer{border-top:1px solid var(--line); padding:12px 14px; display:flex; gap:10px; align-items:flex-end;}\n    .btn{border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); border-radius:12px; padding:10px 12px; cursor:pointer;}\n    .btn:hover{border-color:rgba(255,255,255,.22)}\n    textarea{flex:1; resize:none; min-height:46px; max-height:180px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:10px 12px; outline:none; font-size:14px; line-height:1.35;}\n    input[type=file]{display:none;}\n  </style>\n</head>\n<body>\n<div class=\"wrap\">\n  <aside class=\"left\">\n    <div class=\"brand\">AURA</div>\n    <div class=\"small\">Core console</div>\n    <a class=\"link\" href=\"/site/malibu\" target=\"_blank\" rel=\"noopener\">Open Malibu City Guide</a>\n    <a class=\"link\" href=\"/__version\" target=\"_blank\" rel=\"noopener\">Version</a>\n    <div class=\"small\" style=\"margin-top:12px;\">Note: City Guide pages live under <b>/site/&lt;slug&gt;</b>.</div>\n  </aside>\n\n  <main class=\"main\">\n    <div class=\"top\">\n      <div class=\"pill\">/core</div>\n      <div class=\"pill\" id=\"statusPill\">ready</div>\n    </div>\n\n    <div class=\"msgs\" id=\"msgs\"></div>\n\n    <div class=\"composer\">\n      <label class=\"btn\" for=\"filePick\" title=\"Upload\">+</label>\n      <input id=\"filePick\" type=\"file\" />\n      <button class=\"btn\" id=\"micBtn\" title=\"Mic\">\uD83C\uDFA4</button>\n      <textarea id=\"inp\" placeholder=\"Message Aura\u2026\"></textarea>\n      <button class=\"btn\" id=\"sendBtn\">Send</button>\n    </div>\n  </main>\n</div>\n\n<script>\n(() => {\n  const $msgs = document.getElementById('msgs');\n  const $inp = document.getElementById('inp');\n  const $send = document.getElementById('sendBtn');\n  const $status = document.getElementById('statusPill');\n  const $file = document.getElementById('filePick');\n  const $mic = document.getElementById('micBtn');\n\n  const log = (role, body, imageUrl) => {\n    const wrap = document.createElement('div');\n    wrap.className = 'msg';\n    const r = document.createElement('div'); r.className='role'; r.textContent=role;\n    const b = document.createElement('div'); b.className='body'; b.textContent=body || '';\n    wrap.appendChild(r); wrap.appendChild(b);\n    if (imageUrl) {\n      const img = document.createElement('img');\n      img.src = imageUrl;\n      img.alt = \"image\";\n      wrap.appendChild(img);\n    }\n    $msgs.appendChild(wrap);\n    $msgs.scrollTop = $msgs.scrollHeight;\n  };\n\n  log('YOU', 'Aura Core UI loaded.');\n\n  async function sendText(text) {\n    $status.textContent = 'thinking\u2026';\n    try {\n      const res = await fetch('/chat', {\n        method:'POST',\n        headers:{'Content-Type':'application/json'},\n        body: JSON.stringify({ type:'text', input: text })\n      });\n      const data = await res.json().catch(() => null);\n      if (!res.ok || !data) {\n        log('AU', 'Error: ' + (data?.error || res.status));\n      } else if (data.type === 'image' && data.url) {\n        log('AU', data.caption || '(image)', data.url);\n      } else {\n        log('AU', data.output || data.text || JSON.stringify(data));\n      }\n    } catch (e) {\n      log('AU', 'Network error.');\n    } finally {\n      $status.textContent = 'ready';\n    }\n  }\n\n  $send.addEventListener('click', () => {\n    const t = ($inp.value || '').trim();\n    if (!t) return;\n    log('YOU', t);\n    $inp.value = '';\n    sendText(t);\n  });\n\n  $inp.addEventListener('keydown', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      $send.click();\n    }\n  });\n\n  $file.addEventListener('change', async () => {\n    const f = $file.files && $file.files[0];\n    if (!f) return;\n    log('YOU', 'Uploading: ' + f.name);\n\n    const fd = new FormData();\n    fd.append('file', f, f.name);\n\n    try {\n      const res = await fetch('/upload', { method:'POST', body: fd });\n      const data = await res.json().catch(() => null);\n      if (!res.ok || !data?.ok) {\n        log('AU', 'Upload failed.');\n      } else {\n        log('AU', 'Upload OK: ' + data.url);\n      }\n    } catch (e) {\n      log('AU', 'Upload error.');\n    } finally {\n      $file.value = '';\n    }\n  });\n\n  // Mic placeholder (UI must remain ON; actual speech-to-text can be wired later)\n  $mic.addEventListener('click', () => {\n    log('AU', 'Mic is present. If speech capture is not wired, this will be updated later.');\n  });\n})();\n</script>\n</body>\n</html>`;\n}\n\n/** City Guide HTML (standalone) */\nfunction renderCityGuideHTML(slug, directoryJson) {\n  const title = `${slug}.city`.replace(/^\\./, \"\");\n  const safeTitle = title.toUpperCase();\n  // directoryJson is expected to be either:\n  // - { categories:[ {name, items:[{name,description,image_url,location,...}]} ] }\n  // OR\n  // - { Dining:[...], Shopping:[...], ... }  (legacy)\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"/>\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>\n  <title>${safeTitle} \u2014 City Guide</title>\n  <style>\n    :root {\n      --bg:#f4fbff;\n      --card:#ffffff;\n      --text:#153046;\n      --muted:#4f6b80;\n      --line:rgba(21,48,70,.15);\n      --accent:#0077be;\n    }\n    html,body{margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg);}\n    header{position:sticky; top:0; z-index:10; background:rgba(244,251,255,.92); backdrop-filter: blur(10px); border-bottom:1px solid var(--line);}\n    .bar{max-width:1100px; margin:0 auto; padding:14px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between;}\n    .brand{font-weight:900; letter-spacing:.8px;}\n    .sub{font-size:12px; color:var(--muted);}\n    .tabs{max-width:1100px; margin:0 auto; padding:10px 14px 14px; display:flex; gap:10px; flex-wrap:wrap;}\n    .tab{border:1px solid var(--line); background:rgba(255,255,255,.7); padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:700; font-size:13px;}\n    .tab.active{background:var(--accent); border-color:var(--accent); color:white;}\n    main{max-width:1100px; margin:0 auto; padding:14px;}\n    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:14px;}\n    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,.04); display:flex; flex-direction:column;}\n    .card img{width:100%; height:150px; object-fit:cover; background:#e9f3fb;}\n    .c{padding:12px 12px 14px;}\n    .name{font-weight:900; margin:0 0 6px 0; color:var(--accent);}\n    .desc{margin:0 0 10px 0; color:var(--muted); font-size:13px; line-height:1.35;}\n    .meta{font-size:12px; color:var(--muted);}\n    .empty{padding:18px; color:var(--muted);}\n    a.back{color:var(--accent); text-decoration:none; font-weight:800;}\n  </style>\n</head>\n<body>\n<header>\n  <div class=\"bar\">\n    <div>\n      <div class=\"brand\">${safeTitle}</div>\n      <div class=\"sub\">Local guide \u2014 categories & listings</div>\n    </div>\n    <div class=\"sub\"><a class=\"back\" href=\"/core\">Back to Aura Core</a></div>\n  </div>\n  <div class=\"tabs\" id=\"tabs\"></div>\n</header>\n\n<main>\n  <div id=\"grid\" class=\"grid\"></div>\n  <div id=\"empty\" class=\"empty\" style=\"display:none;\"></div>\n</main>\n\n<script>\n(() => {\n  const raw = ${JSON.stringify(directoryJson || {})};\n\n  function normalize(dir) {\n    // If already categories array, use it.\n    if (dir && Array.isArray(dir.categories)) return dir.categories;\n\n    // Else treat object keys as categories with array items.\n    const keys = Object.keys(dir || {});\n    const out = [];\n    for (const k of keys) {\n      if (Array.isArray(dir[k])) out.push({ name: k, items: dir[k] });\n    }\n    return out;\n  }\n\n  const cats = normalize(raw);\n  const tabs = document.getElementById('tabs');\n  const grid = document.getElementById('grid');\n  const empty = document.getElementById('empty');\n\n  if (!cats.length) {\n    empty.style.display = 'block';\n    empty.textContent = 'No directory data found yet.';\n    return;\n  }\n\n  let active = cats[0].name;\n\n  function setActive(name) {\n    active = name;\n    renderTabs();\n    renderCards();\n  }\n\n  function renderTabs() {\n    tabs.innerHTML = '';\n    for (const c of cats) {\n      const b = document.createElement('div');\n      b.className = 'tab' + (c.name === active ? ' active' : '');\n      b.textContent = c.name;\n      b.addEventListener('click', () => setActive(c.name));\n      tabs.appendChild(b);\n    }\n  }\n\n  function renderCards() {\n    grid.innerHTML = '';\n    empty.style.display = 'none';\n\n    const cat = cats.find(x => x.name === active);\n    const items = (cat && Array.isArray(cat.items)) ? cat.items : [];\n\n    if (!items.length) {\n      empty.style.display = 'block';\n      empty.textContent = 'No listings in ' + active + '.';\n      return;\n    }\n\n    for (const it of items) {\n      const card = document.createElement('div');\n      card.className = 'card';\n\n      if (it.image_url) {\n        const img = document.createElement('img');\n        img.src = it.image_url;\n        img.alt = it.name || 'image';\n        card.appendChild(img);\n      }\n\n      const c = document.createElement('div');\n      c.className = 'c';\n\n      const name = document.createElement('div');\n      name.className = 'name';\n      name.textContent = it.name || 'Untitled';\n      c.appendChild(name);\n\n      const desc = document.createElement('div');\n      desc.className = 'desc';\n      desc.textContent = it.description || it.short_description || '';\n      c.appendChild(desc);\n\n      const meta = document.createElement('div');\n      meta.className = 'meta';\n      meta.textContent = it.location || 'Malibu, CA';\n      c.appendChild(meta);\n\n      card.appendChild(c);\n      grid.appendChild(card);\n    }\n  }\n\n  renderTabs();\n  renderCards();\n})();\n</script>\n</body>\n</html>`;\n}\n\n/** Admin: seed directory (writes AURA_DIRECTORY) */\nasync function adminSeedDirectory(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n\n  // Accept:\n  // - raw JSON body\n  // - { AURA_DIRECTORY: {...} }\n  // - { directory: {...} }\n  const body = await readBodyJson(request);\n  if (!body) return badRequest(\"invalid_json\");\n\n  let dir = body;\n  if (body.AURA_DIRECTORY) dir = body.AURA_DIRECTORY;\n  if (body.directory) dir = body.directory;\n\n  // Minimal validation: must be object\n  if (!dir || typeof dir !== \"object\") return badRequest(\"invalid_directory\");\n\n  await kvPut(env, \"AURA_DIRECTORY\", JSON.stringify(dir));\n  return json({ ok: true, wrote: \"AURA_DIRECTORY\" });\n}\n\n/** Admin: get directory (reads AURA_DIRECTORY) */\nasync function adminGetDirectory(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n  const raw = await kvGet(env, \"AURA_DIRECTORY\");\n  if (!raw) return json({ ok: true, exists: false, directory: null });\n  let parsed = null;\n  try { parsed = JSON.parse(raw); } catch {}\n  return json({ ok: true, exists: true, directory: parsed ?? raw });\n}\n\n/** Admin: set UI override (writes AURA_CORE_UI) */\nasync function adminSetUI(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n  const body = await readBodyText(request);\n  if (!body || body.trim().length < 10) return badRequest(\"ui_too_small\");\n  await kvPut(env, \"AURA_CORE_UI\", body);\n  return json({ ok: true, wrote: \"AURA_CORE_UI\", bytes: body.length });\n}\n\n/** Admin: reset UI override */\nasync function adminResetUI(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n  await kvDel(env, \"AURA_CORE_UI\");\n  return json({ ok: true, deleted: \"AURA_CORE_UI\" });\n}\n\n/** Admin: set site HTML for slug (writes SITE_HTML:<slug>) */\nasync function adminSetSite(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n\n  // Accept JSON: { slug, html } or { site:{slug, html} }\n  const body = await readBodyJson(request);\n  if (!body) return badRequest(\"invalid_json\");\n\n  const obj = body.site ? body.site : body;\n  const slug = safeSlug(obj.slug);\n  const htmlStr = typeof obj.html === \"string\" ? obj.html : null;\n\n  if (!slug) return badRequest(\"invalid_slug\");\n  if (!htmlStr || htmlStr.trim().length < 10) return badRequest(\"invalid_html\");\n\n  const key = `SITE_HTML:${slug}`;\n  await kvPut(env, key, htmlStr);\n  return json({ ok: true, wrote: key, slug, bytes: htmlStr.length });\n}\n\n/** Admin: reset site HTML */\nasync function adminResetSite(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n  const body = await readBodyJson(request);\n  if (!body) return badRequest(\"invalid_json\");\n  const slug = safeSlug(body.slug);\n  if (!slug) return badRequest(\"invalid_slug\");\n  const key = `SITE_HTML:${slug}`;\n  await kvDel(env, key);\n  return json({ ok: true, deleted: key, slug });\n}\n\n/** Admin: list site keys (prefix scan if supported) */\nasync function adminListSites(request, env) {\n  if (!requireAdmin(request, env)) return unauthorized();\n\n  // KV list is supported. Return slugs.\n  const listed = await env.AURA_KV.list({ prefix: \"SITE_HTML:\" });\n  const slugs = (listed.keys || [])\n    .map(k => (k.name || \"\").replace(/^SITE_HTML:/, \"\"))\n    .filter(Boolean);\n\n  return json({ ok: true, count: slugs.length, slugs });\n}\n\n/** Serve /core \u2014 from KV override or default */\nasync function handleCore(request, env) {\n  const override = await kvGet(env, \"AURA_CORE_UI\");\n  if (override && override.trim()) return html(override);\n  return html(defaultCoreUI());\n}\n\n/** Serve /site/<slug> from KV, fallback message */\nasync function handleSite(request, env, slug) {\n  const key = `SITE_HTML:${slug}`;\n  const page = await kvGet(env, key);\n  if (page && page.trim()) return html(page);\n  return html(`<!doctype html><html><head><meta charset=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><title>${slug}.city</title></head><body style=\"font-family:system-ui,Segoe UI,Arial,sans-serif;padding:18px;\">\n  <h2 style=\"margin:0 0 8px 0;\">${slug}.city not yet published</h2>\n  <p style=\"margin:0 0 14px 0;\">KV key missing: <code>${key}</code></p>\n  <p><a href=\"/core\">Back to Aura Core</a></p>\n</body></html>`);\n}\n\n/** Serve /malibu legacy (redirect to /site/malibu) */\nfunction handleMalibuRedirect() {\n  return new Response(null, {\n    status: 302,\n    headers: { Location: \"/site/malibu\" },\n  });\n}\n\n/**\n * /chat \u2014 text in, text out (and supports returning image via /image)\n * Input JSON:\n *   { \"type\":\"text\", \"input\":\"...\" }\n *   { \"type\":\"image\", \"prompt\":\"...\" }   (optional: direct)\n */\nasync function handleChat(request, env) {\n  if (request.method !== \"POST\") return methodNotAllowed();\n\n  const payload = await readBodyJson(request);\n  if (!payload || typeof payload !== \"object\") return badRequest(\"invalid_json\");\n\n  // Direct image intent\n  if (payload.type === \"image\") {\n    const prompt = String(payload.prompt || payload.input || \"\").trim();\n    if (!prompt) return badRequest(\"missing_prompt\");\n    return await handleImageInternal(env, prompt);\n  }\n\n  const input = String(payload.input || \"\").trim();\n  if (!input) return badRequest(\"missing_input\");\n\n  // Simple heuristic: if user explicitly prefixes \"image:\" then route to /image\n  if (/^\\s*image\\s*:/i.test(input)) {\n    const prompt = input.replace(/^\\s*image\\s*:/i, \"\").trim();\n    if (!prompt) return badRequest(\"missing_prompt\");\n    return await handleImageInternal(env, prompt);\n  }\n\n  // If OpenAI is not configured, provide a deterministic echo response.\n  if (!env?.OPENAI_API_KEY) {\n    return json({\n      ok: true,\n      type: \"text\",\n      output: `OPENAI_API_KEY not configured. Echo: ${input}`,\n    });\n  }\n\n  const model = env.CHAT_MODEL || \"gpt-4.1-mini\";\n\n  // Use Responses API (works for modern OpenAI) \u2014 best-effort.\n  try {\n    const resp = await fetch(\"https://api.openai.com/v1/responses\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${env.OPENAI_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        model,\n        input,\n      }),\n    });\n\n    const data = await resp.json().catch(() => null);\n\n    if (!resp.ok || !data) {\n      return json(\n        {\n          ok: false,\n          error: \"openai_error\",\n          status: resp.status,\n          detail: data || null,\n        },\n        500\n      );\n    }\n\n    // Try to extract output text\n    let outText = \"\";\n    if (typeof data.output_text === \"string\") outText = data.output_text;\n\n    // Fallback extraction\n    if (!outText && Array.isArray(data.output)) {\n      for (const item of data.output) {\n        if (item && item.type === \"message\" && Array.isArray(item.content)) {\n          for (const c of item.content) {\n            if (c && c.type === \"output_text\" && typeof c.text === \"string\") {\n              outText += c.text;\n            }\n          }\n        }\n      }\n    }\n\n    outText = outText || \"(no output_text)\";\n\n    return json({ ok: true, type: \"text\", output: outText });\n  } catch (e) {\n    return json({ ok: false, error: \"chat_failed\" }, 500);\n  }\n}\n\n/**\n * /image \u2014 returns {type:\"image\", url}\n * Input JSON:\n *   { \"prompt\":\"...\" } OR { \"type\":\"image\", \"prompt\":\"...\" }\n */\nasync function handleImage(request, env) {\n  if (request.method !== \"POST\") return methodNotAllowed();\n  const payload = await readBodyJson(request);\n  if (!payload) return badRequest(\"invalid_json\");\n  const prompt = String(payload.prompt || payload.input || \"\").trim();\n  if (!prompt) return badRequest(\"missing_prompt\");\n  return await handleImageInternal(env, prompt);\n}\n\nasync function handleImageInternal(env, prompt) {\n  if (!env?.OPENAI_API_KEY) {\n    return json({\n      ok: false,\n      error: \"OPENAI_API_KEY_not_configured\",\n    }, 500);\n  }\n\n  const model = env.IMAGE_MODEL || \"gpt-image-1\";\n\n  try {\n    // Use Images API \u2014 best-effort.\n    const resp = await fetch(\"https://api.openai.com/v1/images\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${env.OPENAI_API_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        model,\n        prompt,\n        size: \"1024x1024\",\n      }),\n    });\n\n    const data = await resp.json().catch(() => null);\n\n    if (!resp.ok || !data) {\n      return json(\n        {\n          ok: false,\n          error: \"openai_image_error\",\n          status: resp.status,\n          detail: data || null,\n        },\n        500\n      );\n    }\n\n    // Common shapes:\n    // - {data:[{url:\"...\"}]}\n    // - {data:[{b64_json:\"...\"}]}\n    const first = Array.isArray(data.data) ? data.data[0] : null;\n    if (!first) return json({ ok: false, error: \"no_image_returned\" }, 500);\n\n    if (first.url) {\n      return json({ ok: true, type: \"image\", url: first.url, caption: prompt });\n    }\n\n    if (first.b64_json) {\n      // Return as data URL\n      return json({\n        ok: true,\n        type: \"image\",\n        url: `data:image/png;base64,${first.b64_json}`,\n        caption: prompt,\n      });\n    }\n\n    return json({ ok: false, error: \"unknown_image_shape\" }, 500);\n  } catch (e) {\n    return json({ ok: false, error: \"image_failed\" }, 500);\n  }\n}\n\n/**\n * /upload \u2014 minimal file upload to KV (keeps + functional)\n * - Stores as base64 under key UPLOAD:<id>\n * - Serves at /uploads/<id>\n */\nasync function handleUpload(request, env) {\n  if (request.method !== \"POST\") return methodNotAllowed();\n\n  const ct = request.headers.get(\"content-type\") || \"\";\n  if (!ct.toLowerCase().includes(\"multipart/form-data\")) {\n    return badRequest(\"expected_multipart_form_data\");\n  }\n\n  const form = await request.formData();\n  const file = form.get(\"file\");\n  if (!file || typeof file === \"string\") return badRequest(\"missing_file\");\n\n  const arrBuf = await file.arrayBuffer();\n  const bytes = new Uint8Array(arrBuf);\n  let bin = \"\";\n  // Base64 encode (small/medium files; fine for now)\n  for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);\n  const b64 = btoa(bin);\n\n  const id = crypto.randomUUID();\n  const key = `UPLOAD:${id}`;\n  const meta = {\n    name: file.name || \"upload\",\n    type: file.type || \"application/octet-stream\",\n    size: bytes.length,\n    b64,\n  };\n\n  await kvPut(env, key, JSON.stringify(meta));\n  return json({\n    ok: true,\n    file_id: id,\n    url: `/uploads/${id}`,\n    name: meta.name,\n    type: meta.type,\n    size: meta.size,\n  });\n}\n\nasync function handleUploadsServe(request, env, id) {\n  const key = `UPLOAD:${id}`;\n  const raw = await kvGet(env, key);\n  if (!raw) return notFound();\n\n  let meta;\n  try { meta = JSON.parse(raw); } catch { return notFound(); }\n\n  if (!meta?.b64) return notFound();\n\n  const bytes = Uint8Array.from(atob(meta.b64), c => c.charCodeAt(0));\n  return new Response(bytes, {\n    status: 200,\n    headers: {\n      \"Content-Type\": meta.type || \"application/octet-stream\",\n      \"Content-Disposition\": `inline; filename=\"${(meta.name || id).replace(/\"/g, \"\")}\"`,\n      \"Cache-Control\": \"public, max-age=31536000, immutable\",\n    },\n  });\n}\n\n/** /__version */\nasync function handleVersion() {\n  return json({\n    ok: true,\n    version: VERSION,\n    build: BUILD_ID,\n    timestamp: new Date().toISOString(),\n  });\n}\n\n/** /admin router */\nasync function handleAdmin(request, env, pathname) {\n  if (!pathname.startsWith(\"/admin/\")) return notFound();\n\n  // Must be protected\n  if (!requireAdmin(request, env)) return unauthorized();\n\n  // Route map:\n  // UI\n  if (pathname === \"/admin/ui\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminSetUI(request, env);\n  }\n  if (pathname === \"/admin/ui/reset\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminResetUI(request, env);\n  }\n\n  // Directory\n  if (pathname === \"/admin/dir/seed\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminSeedDirectory(request, env);\n  }\n  if (pathname === \"/admin/dir/get\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminGetDirectory(request, env);\n  }\n\n  // Site publishing (generic)\n  if (pathname === \"/admin/site/set\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminSetSite(request, env);\n  }\n  if (pathname === \"/admin/site/reset\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminResetSite(request, env);\n  }\n  if (pathname === \"/admin/site/list\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    return await adminListSites(request, env);\n  }\n  // Self-deploy (backend-only)\n  if (pathname === \"/admin/self_deploy/prepare\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    if (!env?.AURA_DEPLOYER) return json({ ok: false, error: \"missing_deployer_binding\" }, 500);\n    return json({ ok: true });\n  }\n\n  if (pathname === \"/admin/self_deploy/commit\") {\n    if (request.method !== \"POST\") return methodNotAllowed();\n    if (!env?.AURA_DEPLOYER) return json({ ok: false, error: \"missing_deployer_binding\" }, 500);\n    const token = env?.DEPLOY_SECRET || env?.DEPLOY_KEY;\n    if (!token) return json({ ok: false, error: \"missing_deploy_token\" }, 500);\n\n    try {\n      const incoming = await readBodyJson(request);\n      const payload = (incoming && typeof incoming === \"object\") ? incoming : {};\n\n      const script_name = payload.script_name;\n\n      // Accept either:\n      //  - bundle_b64: base64-encoded module bundle text (preferred from core)\n      //  - bundle: raw module bundle text (advanced / direct)\n      const bundle_b64 = payload.bundle_b64;\n      const bundle_raw = payload.bundle;\n\n      if (!script_name || (!bundle_b64 && !bundle_raw)) {\n        return json({ ok: false, error: \"missing_required_fields\" }, 400);\n      }\n\n      let bundle = null;\n\n      if (typeof bundle_raw === \"string\" && bundle_raw.length) {\n        bundle = bundle_raw;\n      } else {\n        // Decode base64 -> text\n        try {\n          bundle = atob(String(bundle_b64));\n        } catch (e) {\n          return json({ ok: false, error: \"invalid_bundle_b64\" }, 400);\n        }\n      }\n\n      // Forward payload in the shape the deployer requires\n      const forward = {\n        script_name,\n        bundle,\n      };\n\n      if (payload.compatibility_date) forward.compatibility_date = payload.compatibility_date;\n      if (payload.promote_phrase) forward.promote_phrase = payload.promote_phrase;\n\n      const res = await env.AURA_DEPLOYER.fetch(\"https://aura-deployer/deploy\", {\n        method: \"POST\",\n        headers: {\n          \"Authorization\": \"Bearer \" + token,\n          \"X-Deploy-Key\": token,\n          \"Content-Type\": \"application/json; charset=utf-8\",\n        },\n        body: JSON.stringify(forward),\n      });\n\n      const bodyText = await res.text();\n\n      // Pass through deployer response (even if non-200) so we can see the real error.\n      return new Response(bodyText, {\n        status: res.status,\n        headers: { \"Content-Type\": \"application/json; charset=utf-8\" },\n      });\n    } catch (e) {\n      return json({ ok: false, error: \"deployer_fetch_failed\", detail: String(e && e.message ? e.message : e) }, 500);\n    }\n  }\n\n\n\n  return notFound();\n}\n\n/** main router */\nexport default {\n  async fetch(request, env, ctx) {\n    try {\n      const url = new URL(request.url);\n      const path = url.pathname;\n\n      // Version\n      if (path === \"/__version\") return await handleVersion();\n\n      // Core UI\n      if (path === \"/core\" || path === \"/\") return await handleCore(request, env);\n\n      // Chat + Image\n      if (path === \"/chat\") return await handleChat(request, env);\n      if (path === \"/image\") return await handleImage(request, env);\n\n      // Uploads\n      if (path === \"/upload\") return await handleUpload(request, env);\n      if (path.startsWith(\"/uploads/\")) {\n        const id = path.slice(\"/uploads/\".length).trim();\n        if (!id) return notFound();\n        return await handleUploadsServe(request, env, id);\n      }\n\n      // Admin\n      if (path.startsWith(\"/admin/\")) {\n        return await handleAdmin(request, env, path);\n      }\n\n      // Legacy Malibu redirect\n      if (path === \"/malibu\") return handleMalibuRedirect();\n\n      // Generic site route: /site/<slug>\n      if (path.startsWith(\"/site/\")) {\n        const slug = safeSlug(path.slice(\"/site/\".length));\n        if (!slug) return notFound();\n        return await handleSite(request, env, slug);\n      }\n\n      // Optional: convenience city route /city/<slug> -> /site/<slug>\n      if (path.startsWith(\"/city/\")) {\n        const slug = safeSlug(path.slice(\"/city/\".length));\n        if (!slug) return notFound();\n        return new Response(null, { status: 302, headers: { Location: `/site/${slug}` } });\n      }\n\n      return notFound();\n    } catch (e) {\n      return json({ ok: false, error: \"internal_error\", detail: String(e && e.message ? e.message : e) }, 500);\n    }\n  },\n};\n\n/**\n * QUICK NOTE FOR AURA (not shown to users):\n * - To publish Malibu:\n *   1) POST /admin/dir/seed (AURA_DIRECTORY)\n *   2) Generate HTML using renderCityGuideHTML(\"malibu\", directory)\n *   3) POST /admin/site/set {slug:\"malibu\", html:\"...\"}  -> serves at /site/malibu\n *\n * You can also store a fully custom HTML string per site.\n */\n"],
  "mappings": "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",
  "names": []
}
