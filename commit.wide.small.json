{
    "worker_name":  "aura-core-staging",
    "bundle_b64":  "LyoqCiAqIGF1cmEtY29yZSDigJQgQ2xvdWRmbGFyZSBXb3JrZXIgKHNpbmdsZS1maWxlKQogKgogKiBGSUxFOiBDOlxVc2Vyc1xBYXJvbiBLYXJhY2FzXGF1cmEtd29ya2VyXGF1cmFcc3JjXGluZGV4LmpzCiAqCiAqIEd1YXJhbnRlZXM6CiAqIC0gS2VlcHMgL2NvcmUsIC9jaGF0LCAvaW1hZ2UsIC9fX3ZlcnNpb24gd29ya2luZwogKiAtIEFkZHMgZ2VuZXJpYyBzZWxmLXB1Ymxpc2hpbmcgc2l0ZXM6IEdFVCAvc2l0ZS88c2x1Zz4KICogLSBBZGRzIGxlZ2FjeSBjb252ZW5pZW5jZSByb3V0ZTogR0VUIC9tYWxpYnUgLT4gL3NpdGUvbWFsaWJ1CiAqIC0gQWRkcyBwcm90ZWN0ZWQgYWRtaW4gZW5kcG9pbnRzIChYLUNvcmUtUGFzcyBtdXN0IGVxdWFsIENPUkVfUEFTUyBzZWNyZXQpOgogKiAgICAgUE9TVCAvYWRtaW4vdWkKICogICAgIFBPU1QgL2FkbWluL3VpL3Jlc2V0CiAqICAgICBQT1NUIC9hZG1pbi9kaXIvc2VlZAogKiAgICAgUE9TVCAvYWRtaW4vZGlyL2dldAogKiAgICAgUE9TVCAvYWRtaW4vc2l0ZS9zZXQKICogICAgIFBPU1QgL2FkbWluL3NpdGUvcmVzZXQKICogICAgIFBPU1QgL2FkbWluL3NpdGUvbGlzdAogKgogKiBTdG9yYWdlOgogKiAtIFVzZXMgT05FIEtWIGJpbmRpbmc6IGVudi5BVVJBX0tWCiAqIC0gS2V5czoKICogICAgIEFVUkFfQ09SRV9VSSAgICAgICAgICAgICAgKEhUTUwgc3RyaW5nIG92ZXJyaWRlIGZvciAvY29yZSkKICogICAgIEFVUkFfRElSRUNUT1JZICAgICAgICAgICAgKGRpcmVjdG9yeSBKU09OKQogKiAgICAgU0lURV9IVE1MOjxzbHVnPiAgICAgICAgICAoSFRNTCBzdHJpbmcgZm9yIC9zaXRlLzxzbHVnPikKICoKICogTm90ZXM6CiAqIC0gVGhpcyBmaWxlIGRvZXMgTk9UIHJlZGVzaWduIC9jb3JlIGJleW9uZCBhIG1pbmltYWwsIGNsaWNrYWJsZSwgZnVuY3Rpb25hbCBVSQogKiAgIHdpdGggdHlwaW5nICsgdXBsb2FkICgrKSArIG1pYyBidXR0b24gcGxhY2Vob2xkZXIsIGFuZCBpbWFnZSByZW5kZXJpbmcuCiAqIC0gSWYgeW91IGFscmVhZHkgaGF2ZSBPcGVuQUkgd2lyZWQsIHNldCBlbnYuT1BFTkFJX0FQSV9LRVkgYW5kIG9wdGlvbmFsIG1vZGVsczoKICogICAgIGVudi5DSEFUX01PREVMIChkZWZhdWx0OiAiZ3B0LTQuMS1taW5pIikKICogICAgIGVudi5JTUFHRV9NT0RFTCAoZGVmYXVsdDogImdwdC1pbWFnZS0xIikKICovCgpjb25zdCBWRVJTSU9OID0gImF1cmEtY29yZS0yMDI2LTAxLTEzIjsKY29uc3QgQlVJTERfSUQgPSAic2l0ZS1wdWJsaXNoZXItdjEiOwpjb25zdCBKU09OX0hFQURFUlMgPSB7CiAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04IiwKfTsKCmZ1bmN0aW9uIGpzb24oZGF0YSwgc3RhdHVzID0gMjAwLCBleHRyYUhlYWRlcnMgPSB7fSkgewogIHJldHVybiBuZXcgUmVzcG9uc2UoSlNPTi5zdHJpbmdpZnkoZGF0YSksIHsKICAgIHN0YXR1cywKICAgIGhlYWRlcnM6IHsgLi4uSlNPTl9IRUFERVJTLCAuLi5leHRyYUhlYWRlcnMgfSwKICB9KTsKfQoKZnVuY3Rpb24gdGV4dChzdHIsIHN0YXR1cyA9IDIwMCwgZXh0cmFIZWFkZXJzID0ge30pIHsKICByZXR1cm4gbmV3IFJlc3BvbnNlKHN0ciwgewogICAgc3RhdHVzLAogICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogInRleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgiLCAuLi5leHRyYUhlYWRlcnMgfSwKICB9KTsKfQoKZnVuY3Rpb24gaHRtbChzdHIsIHN0YXR1cyA9IDIwMCwgZXh0cmFIZWFkZXJzID0ge30pIHsKICByZXR1cm4gbmV3IFJlc3BvbnNlKHN0ciwgewogICAgc3RhdHVzLAogICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogInRleHQvaHRtbDsgY2hhcnNldD11dGYtOCIsIC4uLmV4dHJhSGVhZGVycyB9LAogIH0pOwp9CgpmdW5jdGlvbiBiYWRSZXF1ZXN0KG1zZyA9ICJiYWRfcmVxdWVzdCIsIGRldGFpbCkgewogIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogbXNnLCBkZXRhaWwgfSwgNDAwKTsKfQoKZnVuY3Rpb24gdW5hdXRob3JpemVkKG1zZyA9ICJ1bmF1dGhvcml6ZWQiKSB7CiAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiBtc2cgfSwgNDAxKTsKfQoKZnVuY3Rpb24gbm90Rm91bmQoKSB7CiAgcmV0dXJuIHRleHQoIk5vdCBmb3VuZCIsIDQwNCk7Cn0KCmZ1bmN0aW9uIG1ldGhvZE5vdEFsbG93ZWQoKSB7CiAgcmV0dXJuIHRleHQoIk1ldGhvZCBOb3QgQWxsb3dlZCIsIDQwNSk7Cn0KCmZ1bmN0aW9uIGdldEhlYWRlcihyZXF1ZXN0LCBuYW1lKSB7CiAgcmV0dXJuIHJlcXVlc3QuaGVhZGVycy5nZXQobmFtZSkgfHwgcmVxdWVzdC5oZWFkZXJzLmdldChuYW1lLnRvTG93ZXJDYXNlKCkpIHx8ICIiOwp9CgpmdW5jdGlvbiBzYWZlU2x1ZyhpbnB1dCkgewogIGNvbnN0IHMgPSBTdHJpbmcoaW5wdXQgfHwgIiIpCiAgICAudHJpbSgpCiAgICAudG9Mb3dlckNhc2UoKQogICAgLnJlcGxhY2UoL1teYS16MC05XC1fLl0vZywgIi0iKQogICAgLnJlcGxhY2UoLy0rL2csICItIikKICAgIC5yZXBsYWNlKC9eWy0uXSt8Wy0uXSskL2csICIiKTsKICBpZiAoIXMpIHJldHVybiBudWxsOwogIC8vIGtlZXAgaXQgc2FuZQogIGlmIChzLmxlbmd0aCA+IDgwKSByZXR1cm4gcy5zbGljZSgwLCA4MCk7CiAgcmV0dXJuIHM7Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRCb2R5VGV4dChyZXF1ZXN0KSB7CiAgLy8gV29ya3MgZm9yIHRleHQvcGxhaW4sIHRleHQvaHRtbCwgYXBwbGljYXRpb24vanNvbiAocmF3KQogIHJldHVybiBhd2FpdCByZXF1ZXN0LnRleHQoKTsKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZEJvZHlKc29uKHJlcXVlc3QpIHsKICB0cnkgewogICAgY29uc3QgY2xvbmUgPSByZXF1ZXN0LmNsb25lKCk7CiAgICBjb25zdCB0ID0gYXdhaXQgY2xvbmUudGV4dCgpOwogICAgaWYgKCF0IHx8ICF0LnRyaW0oKSkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh0KTsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCmZ1bmN0aW9uIGJhc2U2NEVuY29kZVV0Zjgoc3RyKSB7CiAgLy8gYnRvYSBleHBlY3RzIExhdGluLTE7IGNvbnZlcnQgVVRGLTggYnl0ZXMgdG8gYSBiaW5hcnkgc3RyaW5nIGZpcnN0LgogIGNvbnN0IGJ5dGVzID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKFN0cmluZyhzdHIgPz8gIiIpKTsKICBsZXQgYmluID0gIiI7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkrKykgYmluICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0pOwogIHJldHVybiBidG9hKGJpbik7Cn0KCmZ1bmN0aW9uIHBhcnNlQmVhcmVyKGF1dGhIZWFkZXIpIHsKICBjb25zdCB2ID0gU3RyaW5nKGF1dGhIZWFkZXIgfHwgIiIpLnRyaW0oKTsKICBpZiAoIXYpIHJldHVybiAiIjsKICBjb25zdCBtID0gdi5tYXRjaCgvXkJlYXJlclxzKyguKykkL2kpOwogIHJldHVybiBtID8gU3RyaW5nKG1bMV0gfHwgIiIpLnRyaW0oKSA6ICIiOwp9CgpmdW5jdGlvbiBzYWZlVHJpbVRva2VuKHMpIHsKICByZXR1cm4gU3RyaW5nKHMgfHwgIiIpLnJlcGxhY2UoL1tcclxuXHRdL2csICIiKS50cmltKCk7Cn0KCmZ1bmN0aW9uIHJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpIHsKICBjb25zdCBjb3JlID0gc2FmZVRyaW1Ub2tlbihlbnY/LkNPUkVfUEFTUyB8fCAiIik7CiAgaWYgKCFjb3JlKSByZXR1cm4gZmFsc2U7CgogIGNvbnN0IHBhc3NYID0gc2FmZVRyaW1Ub2tlbihnZXRIZWFkZXIocmVxdWVzdCwgIlgtQ29yZS1QYXNzIikpOwogIGlmIChwYXNzWCAmJiBwYXNzWCA9PT0gY29yZSkgcmV0dXJuIHRydWU7CgogIGNvbnN0IGJlYXJlciA9IHNhZmVUcmltVG9rZW4ocGFyc2VCZWFyZXIoZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIikpKTsKICBpZiAoYmVhcmVyICYmIGJlYXJlciA9PT0gY29yZSkgcmV0dXJuIHRydWU7CgogIHJldHVybiBmYWxzZTsKfQoKYXN5bmMgZnVuY3Rpb24gYWRtaW5Qcm9iZShyZXF1ZXN0LCBlbnYpIHsKICAvLyBOTyBzZWNyZXRzIHJldHVybmVkLiBCb29sZWFuLW9ubHkgZGlhZ25vc3RpY3MuCiAgY29uc3QgY29yZSA9IHNhZmVUcmltVG9rZW4oZW52Py5DT1JFX1BBU1MgfHwgIiIpOwogIGNvbnN0IHBhc3NYID0gc2FmZVRyaW1Ub2tlbihnZXRIZWFkZXIocmVxdWVzdCwgIlgtQ29yZS1QYXNzIikpOwogIGNvbnN0IGJlYXJlciA9IHNhZmVUcmltVG9rZW4ocGFyc2VCZWFyZXIoZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIikpKTsKCiAgcmV0dXJuIGpzb24oewogICAgb2s6IHRydWUsCiAgICBoYXNfZW52OiAhIWVudiwKICAgIGhhc19jb3JlX3Bhc3M6ICEhY29yZSwKICAgIGNvcmVfcGFzc19sZW46IGNvcmUgPyBjb3JlLmxlbmd0aCA6IDAsCiAgICBoZWFkZXJfeF9wcmVzZW50OiAhIXBhc3NYLAogICAgaGVhZGVyX3hfbGVuOiBwYXNzWCA/IHBhc3NYLmxlbmd0aCA6IDAsCiAgICBhdXRoX3ByZXNlbnQ6ICEhZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIiksCiAgICBiZWFyZXJfcHJlc2VudDogISFiZWFyZXIsCiAgICBiZWFyZXJfbGVuOiBiZWFyZXIgPyBiZWFyZXIubGVuZ3RoIDogMCwKICAgIHBhc3NfbWF0Y2hlZF94OiAhIShwYXNzWCAmJiBjb3JlICYmIHBhc3NYID09PSBjb3JlKSwKICAgIHBhc3NfbWF0Y2hlZF9iZWFyZXI6ICEhKGJlYXJlciAmJiBjb3JlICYmIGJlYXJlciA9PT0gY29yZSksCiAgICByZXF1aXJlX2FkbWluOiByZXF1aXJlQWRtaW4ocmVxdWVzdCwgZW52KSwKICB9KTsKfQoKYXN5bmMgZnVuY3Rpb24ga3ZHZXQoZW52LCBrZXkpIHsKICBpZiAoIWVudj8uQVVSQV9LVikgdGhyb3cgbmV3IEVycm9yKCJtaXNzaW5nX2t2X2JpbmRpbmdfQVVSQV9LViIpOwogIHJldHVybiBhd2FpdCBlbnYuQVVSQV9LVi5nZXQoa2V5KTsKfQoKYXN5bmMgZnVuY3Rpb24ga3ZQdXQoZW52LCBrZXksIHZhbHVlKSB7CiAgaWYgKCFlbnY/LkFVUkFfS1YpIHRocm93IG5ldyBFcnJvcigibWlzc2luZ19rdl9iaW5kaW5nX0FVUkFfS1YiKTsKICBhd2FpdCBlbnYuQVVSQV9LVi5wdXQoa2V5LCB2YWx1ZSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGt2RGVsKGVudiwga2V5KSB7CiAgaWYgKCFlbnY/LkFVUkFfS1YpIHRocm93IG5ldyBFcnJvcigibWlzc2luZ19rdl9iaW5kaW5nX0FVUkFfS1YiKTsKICBhd2FpdCBlbnYuQVVSQV9LVi5kZWxldGUoa2V5KTsKfQoKZnVuY3Rpb24gZGVmYXVsdENvcmVVSSgpIHsKICAvLyBNaW5pbWFsLCBjbGlja2FibGUsIHNlbGYtY29udGFpbmVkLgogIC8vIEtlZXBzIHR5cGluZyArIHVwbG9hZCAoKykgKyBtaWMgYnV0dG9uIHBsYWNlaG9sZGVyICsgaW1hZ2UgcmVuZGVyaW5nLgogIC8vIERvZXMgTk9UIGF0dGVtcHQgdG8gZW1iZWQgYW55IGNpdHkgZ3VpZGUgaGVyZS4KICByZXR1cm4gYDwhZG9jdHlwZSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ii8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIi8+CiAgPHRpdGxlPkF1cmEgQ29yZTwvdGl0bGU+CiAgPHN0eWxlPgogICAgOnJvb3QgeyAtLWJnOiMwYjBmMTQ7IC0tcGFuZWw6IzBmMTYyMDsgLS1tdXRlZDojOGFhMGI1OyAtLXRleHQ6I2U4ZjBmNzsgLS1saW5lOnJnYmEoMjU1LDI1NSwyNTUsLjEwKTsgfQogICAgaHRtbCxib2R5e2hlaWdodDoxMDAlOyBtYXJnaW46MDsgYmFja2dyb3VuZDp2YXIoLS1iZyk7IGNvbG9yOnZhcigtLXRleHQpOyBmb250LWZhbWlseTpzeXN0ZW0tdWksLWFwcGxlLXN5c3RlbSxTZWdvZSBVSSxSb2JvdG8sQXJpYWwsc2Fucy1zZXJpZjt9CiAgICAud3JhcHtoZWlnaHQ6MTAwJTsgZGlzcGxheTpmbGV4O30KICAgIC5sZWZ0e3dpZHRoOjI2MHB4OyBib3JkZXItcmlnaHQ6MXB4IHNvbGlkIHZhcigtLWxpbmUpOyBiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIzBlMTYyMSwjMGIwZjE0KTsgcGFkZGluZzoxNHB4OyBib3gtc2l6aW5nOmJvcmRlci1ib3g7fQogICAgLmJyYW5ke2ZvbnQtd2VpZ2h0OjgwMDsgbGV0dGVyLXNwYWNpbmc6LjZweDsgbWFyZ2luLWJvdHRvbToxMHB4O30KICAgIC5zbWFsbHtmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyBsaW5lLWhlaWdodDoxLjM1O30KICAgIC5saW5re2Rpc3BsYXk6YmxvY2s7IG1hcmdpbi10b3A6MTJweDsgcGFkZGluZzoxMHB4IDEycHg7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJvcmRlci1yYWRpdXM6MTBweDsgY29sb3I6dmFyKC0tdGV4dCk7IHRleHQtZGVjb3JhdGlvbjpub25lO30KICAgIC5saW5rOmhvdmVye2JvcmRlci1jb2xvcjpyZ2JhKDI1NSwyNTUsMjU1LC4yMil9CiAgICAubWFpbntmbGV4OjE7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBtaW4td2lkdGg6MDt9CiAgICAudG9we3BhZGRpbmc6MTJweCAxNHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1saW5lKTsgZGlzcGxheTpmbGV4OyBnYXA6MTBweDsgYWxpZ24taXRlbXM6Y2VudGVyO30KICAgIC5waWxse2ZvbnQtc2l6ZToxMnB4OyBjb2xvcjp2YXIoLS1tdXRlZCk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IHBhZGRpbmc6NnB4IDEwcHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7fQogICAgLm1zZ3N7ZmxleDoxOyBvdmVyZmxvdzphdXRvOyBwYWRkaW5nOjE0cHg7IGJveC1zaXppbmc6Ym9yZGVyLWJveDt9CiAgICAubXNne21heC13aWR0aDo5MjBweDsgbWFyZ2luOjAgYXV0byAxMnB4IGF1dG87IHBhZGRpbmc6MTJweCAxMnB4OyBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOyBib3JkZXItcmFkaXVzOjEycHg7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpO30KICAgIC5tc2cgLnJvbGV7Zm9udC13ZWlnaHQ6NzAwOyBmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyBtYXJnaW4tYm90dG9tOjZweDsgbGV0dGVyLXNwYWNpbmc6LjNweDt9CiAgICAubXNnIC5ib2R5e3doaXRlLXNwYWNlOnByZS13cmFwOyBsaW5lLWhlaWdodDoxLjM1O30KICAgIC5tc2cgaW1ne21heC13aWR0aDoxMDAlOyBib3JkZXItcmFkaXVzOjEycHg7IGRpc3BsYXk6YmxvY2s7IG1hcmdpbi10b3A6MTBweDsgYm9yZGVyOjFweCBzb2xpZCB2YXIoLS1saW5lKTt9CiAgICAuY29tcG9zZXJ7Ym9yZGVyLXRvcDoxcHggc29saWQgdmFyKC0tbGluZSk7IHBhZGRpbmc6MTJweCAxNHB4OyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpmbGV4LWVuZDt9CiAgICAuYnRue2JvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpOyBjb2xvcjp2YXIoLS10ZXh0KTsgYm9yZGVyLXJhZGl1czoxMnB4OyBwYWRkaW5nOjEwcHggMTJweDsgY3Vyc29yOnBvaW50ZXI7fQogICAgLmJ0bjpob3Zlcntib3JkZXItY29sb3I6cmdiYSgyNTUsMjU1LDI1NSwuMjIpfQogICAgdGV4dGFyZWF7ZmxleDoxOyByZXNpemU6bm9uZTsgbWluLWhlaWdodDo0NnB4OyBtYXgtaGVpZ2h0OjE4MHB4OyBib3JkZXItcmFkaXVzOjEycHg7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpOyBjb2xvcjp2YXIoLS10ZXh0KTsgcGFkZGluZzoxMHB4IDEycHg7IG91dGxpbmU6bm9uZTsgZm9udC1zaXplOjE0cHg7IGxpbmUtaGVpZ2h0OjEuMzU7fQogICAgaW5wdXRbdHlwZT1maWxlXXtkaXNwbGF5Om5vbmU7fQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxkaXYgY2xhc3M9IndyYXAiPgogIDxhc2lkZSBjbGFzcz0ibGVmdCI+CiAgICA8ZGl2IGNsYXNzPSJicmFuZCI+QVVSQTwvZGl2PgogICAgPGRpdiBjbGFzcz0ic21hbGwiPkNvcmUgY29uc29sZTwvZGl2PgogICAgPGEgY2xhc3M9ImxpbmsiIGhyZWY9Ii9zaXRlL21hbGlidSIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPk9wZW4gTWFsaWJ1IENpdHkgR3VpZGU8L2E+CiAgICA8YSBjbGFzcz0ibGluayIgaHJlZj0iL19fdmVyc2lvbiIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPlZlcnNpb248L2E+CiAgICA8ZGl2IGNsYXNzPSJzbWFsbCIgc3R5bGU9Im1hcmdpbi10b3A6MTJweDsiPk5vdGU6IENpdHkgR3VpZGUgcGFnZXMgbGl2ZSB1bmRlciA8Yj4vc2l0ZS8mbHQ7c2x1ZyZndDs8L2I+LjwvZGl2PgogIDwvYXNpZGU+CgogIDxtYWluIGNsYXNzPSJtYWluIj4KICAgIDxkaXYgY2xhc3M9InRvcCI+CiAgICAgIDxkaXYgY2xhc3M9InBpbGwiPi9jb3JlPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InBpbGwiIGlkPSJzdGF0dXNQaWxsIj5yZWFkeTwvZGl2PgogICAgPC9kaXY+CgogICAgPGRpdiBjbGFzcz0ibXNncyIgaWQ9Im1zZ3MiPjwvZGl2PgoKICAgIDxkaXYgY2xhc3M9ImNvbXBvc2VyIj4KICAgICAgPGxhYmVsIGNsYXNzPSJidG4iIGZvcj0iZmlsZVBpY2siIHRpdGxlPSJVcGxvYWQiPis8L2xhYmVsPgogICAgICA8aW5wdXQgaWQ9ImZpbGVQaWNrIiB0eXBlPSJmaWxlIiAvPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJtaWNCdG4iIHRpdGxlPSJNaWMiPvCfjqQ8L2J1dHRvbj4KICAgICAgPHRleHRhcmVhIGlkPSJpbnAiIHBsYWNlaG9sZGVyPSJNZXNzYWdlIEF1cmHigKYiPjwvdGV4dGFyZWE+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9InNlbmRCdG4iPlNlbmQ8L2J1dHRvbj4KICAgIDwvZGl2PgogIDwvbWFpbj4KPC9kaXY+Cgo8c2NyaXB0PgooKCkgPT4gewogIGNvbnN0ICRtc2dzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21zZ3MnKTsKICBjb25zdCAkaW5wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2lucCcpOwogIGNvbnN0ICRzZW5kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbmRCdG4nKTsKICBjb25zdCAkc3RhdHVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1c1BpbGwnKTsKICBjb25zdCAkZmlsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWxlUGljaycpOwogIGNvbnN0ICRtaWMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWljQnRuJyk7CgogIGNvbnN0IGxvZyA9IChyb2xlLCBib2R5LCBpbWFnZVVybCkgPT4gewogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgd3JhcC5jbGFzc05hbWUgPSAnbXNnJzsKICAgIGNvbnN0IHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgci5jbGFzc05hbWU9J3JvbGUnOyByLnRleHRDb250ZW50PXJvbGU7CiAgICBjb25zdCBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGIuY2xhc3NOYW1lPSdib2R5JzsgYi50ZXh0Q29udGVudD1ib2R5IHx8ICcnOwogICAgd3JhcC5hcHBlbmRDaGlsZChyKTsgd3JhcC5hcHBlbmRDaGlsZChiKTsKICAgIGlmIChpbWFnZVVybCkgewogICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgaW1nLnNyYyA9IGltYWdlVXJsOwogICAgICBpbWcuYWx0ID0gImltYWdlIjsKICAgICAgd3JhcC5hcHBlbmRDaGlsZChpbWcpOwogICAgfQogICAgJG1zZ3MuYXBwZW5kQ2hpbGQod3JhcCk7CiAgICAkbXNncy5zY3JvbGxUb3AgPSAkbXNncy5zY3JvbGxIZWlnaHQ7CiAgfTsKCiAgbG9nKCdZT1UnLCAnQXVyYSBDb3JlIFVJIGxvYWRlZC4nKTsKCiAgYXN5bmMgZnVuY3Rpb24gc2VuZFRleHQodGV4dCkgewogICAgJHN0YXR1cy50ZXh0Q29udGVudCA9ICd0aGlua2luZ+KApic7CiAgICB0cnkgewogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCgnL2NoYXQnLCB7CiAgICAgICAgbWV0aG9kOidQT1NUJywKICAgICAgICBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbid9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdHlwZTondGV4dCcsIGlucHV0OiB0ZXh0IH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKS5jYXRjaCgoKSA9PiBudWxsKTsKICAgICAgaWYgKCFyZXMub2sgfHwgIWRhdGEpIHsKICAgICAgICBsb2coJ0FVJywgJ0Vycm9yOiAnICsgKGRhdGE/LmVycm9yIHx8IHJlcy5zdGF0dXMpKTsKICAgICAgfSBlbHNlIGlmIChkYXRhLnR5cGUgPT09ICdpbWFnZScgJiYgZGF0YS51cmwpIHsKICAgICAgICBsb2coJ0FVJywgZGF0YS5jYXB0aW9uIHx8ICcoaW1hZ2UpJywgZGF0YS51cmwpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvZygnQVUnLCBkYXRhLm91dHB1dCB8fCBkYXRhLnRleHQgfHwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZygnQVUnLCAnTmV0d29yayBlcnJvci4nKTsKICAgIH0gZmluYWxseSB7CiAgICAgICRzdGF0dXMudGV4dENvbnRlbnQgPSAncmVhZHknOwogICAgfQogIH0KCiAgJHNlbmQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICBjb25zdCB0ID0gKCRpbnAudmFsdWUgfHwgJycpLnRyaW0oKTsKICAgIGlmICghdCkgcmV0dXJuOwogICAgbG9nKCdZT1UnLCB0KTsKICAgICRpbnAudmFsdWUgPSAnJzsKICAgIHNlbmRUZXh0KHQpOwogIH0pOwoKICAkaW5wLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgaWYgKGUua2V5ID09PSAnRW50ZXInICYmICFlLnNoaWZ0S2V5KSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgJHNlbmQuY2xpY2soKTsKICAgIH0KICB9KTsKCiAgJGZpbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgYXN5bmMgKCkgPT4gewogICAgY29uc3QgZiA9ICRmaWxlLmZpbGVzICYmICRmaWxlLmZpbGVzWzBdOwogICAgaWYgKCFmKSByZXR1cm47CiAgICBsb2coJ1lPVScsICdVcGxvYWRpbmc6ICcgKyBmLm5hbWUpOwoKICAgIGNvbnN0IGZkID0gbmV3IEZvcm1EYXRhKCk7CiAgICBmZC5hcHBlbmQoJ2ZpbGUnLCBmLCBmLm5hbWUpOwoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCcvdXBsb2FkJywgeyBtZXRob2Q6J1BPU1QnLCBib2R5OiBmZCB9KTsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCkuY2F0Y2goKCkgPT4gbnVsbCk7CiAgICAgIGlmICghcmVzLm9rIHx8ICFkYXRhPy5vaykgewogICAgICAgIGxvZygnQVUnLCAnVXBsb2FkIGZhaWxlZC4nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2coJ0FVJywgJ1VwbG9hZCBPSzogJyArIGRhdGEudXJsKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2coJ0FVJywgJ1VwbG9hZCBlcnJvci4nKTsKICAgIH0gZmluYWxseSB7CiAgICAgICRmaWxlLnZhbHVlID0gJyc7CiAgICB9CiAgfSk7CgogIC8vIE1pYyBwbGFjZWhvbGRlciAoVUkgbXVzdCByZW1haW4gT047IGFjdHVhbCBzcGVlY2gtdG8tdGV4dCBjYW4gYmUgd2lyZWQgbGF0ZXIpCiAgJG1pYy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgIGxvZygnQVUnLCAnTWljIGlzIHByZXNlbnQuIElmIHNwZWVjaCBjYXB0dXJlIGlzIG5vdCB3aXJlZCwgdGhpcyB3aWxsIGJlIHVwZGF0ZWQgbGF0ZXIuJyk7CiAgfSk7Cn0pKCk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD5gOwp9CgovKiogQ2l0eSBHdWlkZSBIVE1MIChzdGFuZGFsb25lKSAqLwpmdW5jdGlvbiByZW5kZXJDaXR5R3VpZGVIVE1MKHNsdWcsIGRpcmVjdG9yeUpzb24pIHsKICBjb25zdCB0aXRsZSA9IGAke3NsdWd9LmNpdHlgLnJlcGxhY2UoL15cLi8sICIiKTsKICBjb25zdCBzYWZlVGl0bGUgPSB0aXRsZS50b1VwcGVyQ2FzZSgpOwogIC8vIGRpcmVjdG9yeUpzb24gaXMgZXhwZWN0ZWQgdG8gYmUgZWl0aGVyOgogIC8vIC0geyBjYXRlZ29yaWVzOlsge25hbWUsIGl0ZW1zOlt7bmFtZSxkZXNjcmlwdGlvbixpbWFnZV91cmwsbG9jYXRpb24sLi4ufV19IF0gfQogIC8vIE9SCiAgLy8gLSB7IERpbmluZzpbLi4uXSwgU2hvcHBpbmc6Wy4uLl0sIC4uLiB9ICAobGVnYWN5KQogIHJldHVybiBgPCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiLz4KICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiLz4KICA8dGl0bGU+JHtzYWZlVGl0bGV9IOKAlCBDaXR5IEd1aWRlPC90aXRsZT4KICA8c3R5bGU+CiAgICA6cm9vdCB7CiAgICAgIC0tYmc6I2Y0ZmJmZjsKICAgICAgLS1jYXJkOiNmZmZmZmY7CiAgICAgIC0tdGV4dDojMTUzMDQ2OwogICAgICAtLW11dGVkOiM0ZjZiODA7CiAgICAgIC0tbGluZTpyZ2JhKDIxLDQ4LDcwLC4xNSk7CiAgICAgIC0tYWNjZW50OiMwMDc3YmU7CiAgICB9CiAgICBodG1sLGJvZHl7bWFyZ2luOjA7IHBhZGRpbmc6MDsgZm9udC1mYW1pbHk6c3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLEFyaWFsLHNhbnMtc2VyaWY7IGNvbG9yOnZhcigtLXRleHQpOyBiYWNrZ3JvdW5kOnZhcigtLWJnKTt9CiAgICBoZWFkZXJ7cG9zaXRpb246c3RpY2t5OyB0b3A6MDsgei1pbmRleDoxMDsgYmFja2dyb3VuZDpyZ2JhKDI0NCwyNTEsMjU1LC45Mik7IGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tbGluZSk7fQogICAgLmJhcnttYXgtd2lkdGg6MTEwMHB4OyBtYXJnaW46MCBhdXRvOyBwYWRkaW5nOjE0cHggMTRweDsgZGlzcGxheTpmbGV4OyBnYXA6MTJweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2Vlbjt9CiAgICAuYnJhbmR7Zm9udC13ZWlnaHQ6OTAwOyBsZXR0ZXItc3BhY2luZzouOHB4O30KICAgIC5zdWJ7Zm9udC1zaXplOjEycHg7IGNvbG9yOnZhcigtLW11dGVkKTt9CiAgICAudGFic3ttYXgtd2lkdGg6MTEwMHB4OyBtYXJnaW46MCBhdXRvOyBwYWRkaW5nOjEwcHggMTRweCAxNHB4OyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBmbGV4LXdyYXA6d3JhcDt9CiAgICAudGFie2JvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuNyk7IHBhZGRpbmc6OHB4IDEycHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7IGN1cnNvcjpwb2ludGVyOyB1c2VyLXNlbGVjdDpub25lOyBmb250LXdlaWdodDo3MDA7IGZvbnQtc2l6ZToxM3B4O30KICAgIC50YWIuYWN0aXZle2JhY2tncm91bmQ6dmFyKC0tYWNjZW50KTsgYm9yZGVyLWNvbG9yOnZhcigtLWFjY2VudCk7IGNvbG9yOndoaXRlO30KICAgIG1haW57bWF4LXdpZHRoOjExMDBweDsgbWFyZ2luOjAgYXV0bzsgcGFkZGluZzoxNHB4O30KICAgIC5ncmlke2Rpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdChhdXRvLWZpbGwsIG1pbm1heCgyNjBweCwgMWZyKSk7IGdhcDoxNHB4O30KICAgIC5jYXJke2JhY2tncm91bmQ6dmFyKC0tY2FyZCk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJvcmRlci1yYWRpdXM6MTRweDsgb3ZlcmZsb3c6aGlkZGVuOyBib3gtc2hhZG93OjAgOHB4IDIwcHggcmdiYSgwLDAsMCwuMDQpOyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjt9CiAgICAuY2FyZCBpbWd7d2lkdGg6MTAwJTsgaGVpZ2h0OjE1MHB4OyBvYmplY3QtZml0OmNvdmVyOyBiYWNrZ3JvdW5kOiNlOWYzZmI7fQogICAgLmN7cGFkZGluZzoxMnB4IDEycHggMTRweDt9CiAgICAubmFtZXtmb250LXdlaWdodDo5MDA7IG1hcmdpbjowIDAgNnB4IDA7IGNvbG9yOnZhcigtLWFjY2VudCk7fQogICAgLmRlc2N7bWFyZ2luOjAgMCAxMHB4IDA7IGNvbG9yOnZhcigtLW11dGVkKTsgZm9udC1zaXplOjEzcHg7IGxpbmUtaGVpZ2h0OjEuMzU7fQogICAgLm1ldGF7Zm9udC1zaXplOjEycHg7IGNvbG9yOnZhcigtLW11dGVkKTt9CiAgICAuZW1wdHl7cGFkZGluZzoxOHB4OyBjb2xvcjp2YXIoLS1tdXRlZCk7fQogICAgYS5iYWNre2NvbG9yOnZhcigtLWFjY2VudCk7IHRleHQtZGVjb3JhdGlvbjpub25lOyBmb250LXdlaWdodDo4MDA7fQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxoZWFkZXI+CiAgPGRpdiBjbGFzcz0iYmFyIj4KICAgIDxkaXY+CiAgICAgIDxkaXYgY2xhc3M9ImJyYW5kIj4ke3NhZmVUaXRsZX08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ic3ViIj5Mb2NhbCBndWlkZSDigJQgY2F0ZWdvcmllcyAmIGxpc3RpbmdzPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InN1YiI+PGEgY2xhc3M9ImJhY2siIGhyZWY9Ii9jb3JlIj5CYWNrIHRvIEF1cmEgQ29yZTwvYT48L2Rpdj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJ0YWJzIiBpZD0idGFicyI+PC9kaXY+CjwvaGVhZGVyPgoKPG1haW4+CiAgPGRpdiBpZD0iZ3JpZCIgY2xhc3M9ImdyaWQiPjwvZGl2PgogIDxkaXYgaWQ9ImVtcHR5IiBjbGFzcz0iZW1wdHkiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48L2Rpdj4KPC9tYWluPgoKPHNjcmlwdD4KKCgpID0+IHsKICBjb25zdCByYXcgPSAke0pTT04uc3RyaW5naWZ5KGRpcmVjdG9yeUpzb24gfHwge30pfTsKCiAgZnVuY3Rpb24gbm9ybWFsaXplKGRpcikgewogICAgLy8gSWYgYWxyZWFkeSBjYXRlZ29yaWVzIGFycmF5LCB1c2UgaXQuCiAgICBpZiAoZGlyICYmIEFycmF5LmlzQXJyYXkoZGlyLmNhdGVnb3JpZXMpKSByZXR1cm4gZGlyLmNhdGVnb3JpZXM7CgogICAgLy8gRWxzZSB0cmVhdCBvYmplY3Qga2V5cyBhcyBjYXRlZ29yaWVzIHdpdGggYXJyYXkgaXRlbXMuCiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGlyIHx8IHt9KTsKICAgIGNvbnN0IG91dCA9IFtdOwogICAgZm9yIChjb25zdCBrIG9mIGtleXMpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGlyW2tdKSkgb3V0LnB1c2goeyBuYW1lOiBrLCBpdGVtczogZGlyW2tdIH0pOwogICAgfQogICAgcmV0dXJuIG91dDsKICB9CgogIGNvbnN0IGNhdHMgPSBub3JtYWxpemUocmF3KTsKICBjb25zdCB0YWJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhYnMnKTsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dyaWQnKTsKICBjb25zdCBlbXB0eSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbXB0eScpOwoKICBpZiAoIWNhdHMubGVuZ3RoKSB7CiAgICBlbXB0eS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgIGVtcHR5LnRleHRDb250ZW50ID0gJ05vIGRpcmVjdG9yeSBkYXRhIGZvdW5kIHlldC4nOwogICAgcmV0dXJuOwogIH0KCiAgbGV0IGFjdGl2ZSA9IGNhdHNbMF0ubmFtZTsKCiAgZnVuY3Rpb24gc2V0QWN0aXZlKG5hbWUpIHsKICAgIGFjdGl2ZSA9IG5hbWU7CiAgICByZW5kZXJUYWJzKCk7CiAgICByZW5kZXJDYXJkcygpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGFicygpIHsKICAgIHRhYnMuaW5uZXJIVE1MID0gJyc7CiAgICBmb3IgKGNvbnN0IGMgb2YgY2F0cykgewogICAgICBjb25zdCBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGIuY2xhc3NOYW1lID0gJ3RhYicgKyAoYy5uYW1lID09PSBhY3RpdmUgPyAnIGFjdGl2ZScgOiAnJyk7CiAgICAgIGIudGV4dENvbnRlbnQgPSBjLm5hbWU7CiAgICAgIGIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiBzZXRBY3RpdmUoYy5uYW1lKSk7CiAgICAgIHRhYnMuYXBwZW5kQ2hpbGQoYik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJDYXJkcygpIHsKICAgIGdyaWQuaW5uZXJIVE1MID0gJyc7CiAgICBlbXB0eS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgIGNvbnN0IGNhdCA9IGNhdHMuZmluZCh4ID0+IHgubmFtZSA9PT0gYWN0aXZlKTsKICAgIGNvbnN0IGl0ZW1zID0gKGNhdCAmJiBBcnJheS5pc0FycmF5KGNhdC5pdGVtcykpID8gY2F0Lml0ZW1zIDogW107CgogICAgaWYgKCFpdGVtcy5sZW5ndGgpIHsKICAgICAgZW1wdHkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgIGVtcHR5LnRleHRDb250ZW50ID0gJ05vIGxpc3RpbmdzIGluICcgKyBhY3RpdmUgKyAnLic7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBmb3IgKGNvbnN0IGl0IG9mIGl0ZW1zKSB7CiAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgY2FyZC5jbGFzc05hbWUgPSAnY2FyZCc7CgogICAgICBpZiAoaXQuaW1hZ2VfdXJsKSB7CiAgICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgICAgaW1nLnNyYyA9IGl0LmltYWdlX3VybDsKICAgICAgICBpbWcuYWx0ID0gaXQubmFtZSB8fCAnaW1hZ2UnOwogICAgICAgIGNhcmQuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgfQoKICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBjLmNsYXNzTmFtZSA9ICdjJzsKCiAgICAgIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgbmFtZS5jbGFzc05hbWUgPSAnbmFtZSc7CiAgICAgIG5hbWUudGV4dENvbnRlbnQgPSBpdC5uYW1lIHx8ICdVbnRpdGxlZCc7CiAgICAgIGMuYXBwZW5kQ2hpbGQobmFtZSk7CgogICAgICBjb25zdCBkZXNjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGRlc2MuY2xhc3NOYW1lID0gJ2Rlc2MnOwogICAgICBkZXNjLnRleHRDb250ZW50ID0gaXQuZGVzY3JpcHRpb24gfHwgaXQuc2hvcnRfZGVzY3JpcHRpb24gfHwgJyc7CiAgICAgIGMuYXBwZW5kQ2hpbGQoZGVzYyk7CgogICAgICBjb25zdCBtZXRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIG1ldGEuY2xhc3NOYW1lID0gJ21ldGEnOwogICAgICBtZXRhLnRleHRDb250ZW50ID0gaXQubG9jYXRpb24gfHwgJ01hbGlidSwgQ0EnOwogICAgICBjLmFwcGVuZENoaWxkKG1ldGEpOwoKICAgICAgY2FyZC5hcHBlbmRDaGlsZChjKTsKICAgICAgZ3JpZC5hcHBlbmRDaGlsZChjYXJkKTsKICAgIH0KICB9CgogIHJlbmRlclRhYnMoKTsKICByZW5kZXJDYXJkcygpOwp9KSgpOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+YDsKfQoKLyoqIEFkbWluOiBzZWVkIGRpcmVjdG9yeSAod3JpdGVzIEFVUkFfRElSRUNUT1JZKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pblNlZWREaXJlY3RvcnkocmVxdWVzdCwgZW52KSB7CiAgaWYgKCFyZXF1aXJlQWRtaW4ocmVxdWVzdCwgZW52KSkgcmV0dXJuIHVuYXV0aG9yaXplZCgpOwoKICAvLyBBY2NlcHQ6CiAgLy8gLSByYXcgSlNPTiBib2R5CiAgLy8gLSB7IEFVUkFfRElSRUNUT1JZOiB7Li4ufSB9CiAgLy8gLSB7IGRpcmVjdG9yeTogey4uLn0gfQogIGNvbnN0IGJvZHkgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFib2R5KSByZXR1cm4gYmFkUmVxdWVzdCgiaW52YWxpZF9qc29uIik7CgogIGxldCBkaXIgPSBib2R5OwogIGlmIChib2R5LkFVUkFfRElSRUNUT1JZKSBkaXIgPSBib2R5LkFVUkFfRElSRUNUT1JZOwogIGlmIChib2R5LmRpcmVjdG9yeSkgZGlyID0gYm9keS5kaXJlY3Rvcnk7CgogIC8vIE1pbmltYWwgdmFsaWRhdGlvbjogbXVzdCBiZSBvYmplY3QKICBpZiAoIWRpciB8fCB0eXBlb2YgZGlyICE9PSAib2JqZWN0IikgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfZGlyZWN0b3J5Iik7CgogIGF3YWl0IGt2UHV0KGVudiwgIkFVUkFfRElSRUNUT1JZIiwgSlNPTi5zdHJpbmdpZnkoZGlyKSk7CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgd3JvdGU6ICJBVVJBX0RJUkVDVE9SWSIgfSk7Cn0KCi8qKiBBZG1pbjogZ2V0IGRpcmVjdG9yeSAocmVhZHMgQVVSQV9ESVJFQ1RPUlkpICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluR2V0RGlyZWN0b3J5KHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCByYXcgPSBhd2FpdCBrdkdldChlbnYsICJBVVJBX0RJUkVDVE9SWSIpOwogIGlmICghcmF3KSByZXR1cm4ganNvbih7IG9rOiB0cnVlLCBleGlzdHM6IGZhbHNlLCBkaXJlY3Rvcnk6IG51bGwgfSk7CiAgbGV0IHBhcnNlZCA9IG51bGw7CiAgdHJ5IHsgcGFyc2VkID0gSlNPTi5wYXJzZShyYXcpOyB9IGNhdGNoIHt9CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgZXhpc3RzOiB0cnVlLCBkaXJlY3Rvcnk6IHBhcnNlZCA/PyByYXcgfSk7Cn0KCi8qKiBBZG1pbjogc2V0IFVJIG92ZXJyaWRlICh3cml0ZXMgQVVSQV9DT1JFX1VJKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pblNldFVJKHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlUZXh0KHJlcXVlc3QpOwogIGlmICghYm9keSB8fCBib2R5LnRyaW0oKS5sZW5ndGggPCAxMCkgcmV0dXJuIGJhZFJlcXVlc3QoInVpX3Rvb19zbWFsbCIpOwogIGF3YWl0IGt2UHV0KGVudiwgIkFVUkFfQ09SRV9VSSIsIGJvZHkpOwogIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHdyb3RlOiAiQVVSQV9DT1JFX1VJIiwgYnl0ZXM6IGJvZHkubGVuZ3RoIH0pOwp9CgovKiogQWRtaW46IHJlc2V0IFVJIG92ZXJyaWRlICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluUmVzZXRVSShyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CiAgYXdhaXQga3ZEZWwoZW52LCAiQVVSQV9DT1JFX1VJIik7CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgZGVsZXRlZDogIkFVUkFfQ09SRV9VSSIgfSk7Cn0KCi8qKiBBZG1pbjogc2V0IHNpdGUgSFRNTCBmb3Igc2x1ZyAod3JpdGVzIFNJVEVfSFRNTDo8c2x1Zz4pICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluU2V0U2l0ZShyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIEFjY2VwdCBKU09OOiB7IHNsdWcsIGh0bWwgfSBvciB7IHNpdGU6e3NsdWcsIGh0bWx9IH0KICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlKc29uKHJlcXVlc3QpOwogIGlmICghYm9keSkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwoKICBjb25zdCBvYmogPSBib2R5LnNpdGUgPyBib2R5LnNpdGUgOiBib2R5OwogIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhvYmouc2x1Zyk7CiAgY29uc3QgaHRtbFN0ciA9IHR5cGVvZiBvYmouaHRtbCA9PT0gInN0cmluZyIgPyBvYmouaHRtbCA6IG51bGw7CgogIGlmICghc2x1ZykgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfc2x1ZyIpOwogIGlmICghaHRtbFN0ciB8fCBodG1sU3RyLnRyaW0oKS5sZW5ndGggPCAxMCkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfaHRtbCIpOwoKICBjb25zdCBrZXkgPSBgU0lURV9IVE1MOiR7c2x1Z31gOwogIGF3YWl0IGt2UHV0KGVudiwga2V5LCBodG1sU3RyKTsKICByZXR1cm4ganNvbih7IG9rOiB0cnVlLCB3cm90ZToga2V5LCBzbHVnLCBieXRlczogaHRtbFN0ci5sZW5ndGggfSk7Cn0KCi8qKiBBZG1pbjogcmVzZXQgc2l0ZSBIVE1MICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluUmVzZXRTaXRlKHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlKc29uKHJlcXVlc3QpOwogIGlmICghYm9keSkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwogIGNvbnN0IHNsdWcgPSBzYWZlU2x1Zyhib2R5LnNsdWcpOwogIGlmICghc2x1ZykgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfc2x1ZyIpOwogIGNvbnN0IGtleSA9IGBTSVRFX0hUTUw6JHtzbHVnfWA7CiAgYXdhaXQga3ZEZWwoZW52LCBrZXkpOwogIHJldHVybiBqc29uKHsgb2s6IHRydWUsIGRlbGV0ZWQ6IGtleSwgc2x1ZyB9KTsKfQoKLyoqIEFkbWluOiBsaXN0IHNpdGUga2V5cyAocHJlZml4IHNjYW4gaWYgc3VwcG9ydGVkKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pbkxpc3RTaXRlcyhyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIEtWIGxpc3QgaXMgc3VwcG9ydGVkLiBSZXR1cm4gc2x1Z3MuCiAgY29uc3QgbGlzdGVkID0gYXdhaXQgZW52LkFVUkFfS1YubGlzdCh7IHByZWZpeDogIlNJVEVfSFRNTDoiIH0pOwogIGNvbnN0IHNsdWdzID0gKGxpc3RlZC5rZXlzIHx8IFtdKQogICAgLm1hcChrID0+IChrLm5hbWUgfHwgIiIpLnJlcGxhY2UoL15TSVRFX0hUTUw6LywgIiIpKQogICAgLmZpbHRlcihCb29sZWFuKTsKCiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgY291bnQ6IHNsdWdzLmxlbmd0aCwgc2x1Z3MgfSk7Cn0KCi8qKiBTZXJ2ZSAvY29yZSDigJQgZnJvbSBLViBvdmVycmlkZSBvciBkZWZhdWx0ICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNvcmUocmVxdWVzdCwgZW52KSB7CiAgY29uc3Qgb3ZlcnJpZGUgPSBhd2FpdCBrdkdldChlbnYsICJBVVJBX0NPUkVfVUkiKTsKICBpZiAob3ZlcnJpZGUgJiYgb3ZlcnJpZGUudHJpbSgpKSByZXR1cm4gaHRtbChvdmVycmlkZSk7CiAgcmV0dXJuIGh0bWwoZGVmYXVsdENvcmVVSSgpKTsKfQoKLyoqIFNlcnZlIC9zaXRlLzxzbHVnPiBmcm9tIEtWLCBmYWxsYmFjayBtZXNzYWdlICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVNpdGUocmVxdWVzdCwgZW52LCBzbHVnKSB7CiAgY29uc3Qga2V5ID0gYFNJVEVfSFRNTDoke3NsdWd9YDsKICBjb25zdCBwYWdlID0gYXdhaXQga3ZHZXQoZW52LCBrZXkpOwogIGlmIChwYWdlICYmIHBhZ2UudHJpbSgpKSByZXR1cm4gaHRtbChwYWdlKTsKICByZXR1cm4gaHRtbChgPCFkb2N0eXBlIGh0bWw+PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiLz48bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSIvPjx0aXRsZT4ke3NsdWd9LmNpdHk8L3RpdGxlPjwvaGVhZD48Ym9keSBzdHlsZT0iZm9udC1mYW1pbHk6c3lzdGVtLXVpLFNlZ29lIFVJLEFyaWFsLHNhbnMtc2VyaWY7cGFkZGluZzoxOHB4OyI+CiAgPGgyIHN0eWxlPSJtYXJnaW46MCAwIDhweCAwOyI+JHtzbHVnfS5jaXR5IG5vdCB5ZXQgcHVibGlzaGVkPC9oMj4KICA8cCBzdHlsZT0ibWFyZ2luOjAgMCAxNHB4IDA7Ij5LViBrZXkgbWlzc2luZzogPGNvZGU+JHtrZXl9PC9jb2RlPjwvcD4KICA8cD48YSBocmVmPSIvY29yZSI+QmFjayB0byBBdXJhIENvcmU8L2E+PC9wPgo8L2JvZHk+PC9odG1sPmApOwp9CgovKiogU2VydmUgL21hbGlidSBsZWdhY3kgKHJlZGlyZWN0IHRvIC9zaXRlL21hbGlidSkgKi8KZnVuY3Rpb24gaGFuZGxlTWFsaWJ1UmVkaXJlY3QoKSB7CiAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7CiAgICBzdGF0dXM6IDMwMiwKICAgIGhlYWRlcnM6IHsgTG9jYXRpb246ICIvc2l0ZS9tYWxpYnUiIH0sCiAgfSk7Cn0KCi8qKgogKiAvY2hhdCDigJQgdGV4dCBpbiwgdGV4dCBvdXQgKGFuZCBzdXBwb3J0cyByZXR1cm5pbmcgaW1hZ2UgdmlhIC9pbWFnZSkKICogSW5wdXQgSlNPTjoKICogICB7ICJ0eXBlIjoidGV4dCIsICJpbnB1dCI6Ii4uLiIgfQogKiAgIHsgInR5cGUiOiJpbWFnZSIsICJwcm9tcHQiOiIuLi4iIH0gICAob3B0aW9uYWw6IGRpcmVjdCkKICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNoYXQocmVxdWVzdCwgZW52KSB7CiAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CgogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFwYXlsb2FkIHx8IHR5cGVvZiBwYXlsb2FkICE9PSAib2JqZWN0IikgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwoKICAvLyBEaXJlY3QgaW1hZ2UgaW50ZW50CiAgaWYgKHBheWxvYWQudHlwZSA9PT0gImltYWdlIikgewogICAgY29uc3QgcHJvbXB0ID0gU3RyaW5nKHBheWxvYWQucHJvbXB0IHx8IHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICAgIGlmICghcHJvbXB0KSByZXR1cm4gYmFkUmVxdWVzdCgibWlzc2luZ19wcm9tcHQiKTsKICAgIHJldHVybiBhd2FpdCBoYW5kbGVJbWFnZUludGVybmFsKGVudiwgcHJvbXB0KTsKICB9CgogIGNvbnN0IGlucHV0ID0gU3RyaW5nKHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICBpZiAoIWlucHV0KSByZXR1cm4gYmFkUmVxdWVzdCgibWlzc2luZ19pbnB1dCIpOwoKICAvLyBTaW1wbGUgaGV1cmlzdGljOiBpZiB1c2VyIGV4cGxpY2l0bHkgcHJlZml4ZXMgImltYWdlOiIgdGhlbiByb3V0ZSB0byAvaW1hZ2UKICBpZiAoL15ccyppbWFnZVxzKjovaS50ZXN0KGlucHV0KSkgewogICAgY29uc3QgcHJvbXB0ID0gaW5wdXQucmVwbGFjZSgvXlxzKmltYWdlXHMqOi9pLCAiIikudHJpbSgpOwogICAgaWYgKCFwcm9tcHQpIHJldHVybiBiYWRSZXF1ZXN0KCJtaXNzaW5nX3Byb21wdCIpOwogICAgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlSW50ZXJuYWwoZW52LCBwcm9tcHQpOwogIH0KCiAgLy8gSWYgT3BlbkFJIGlzIG5vdCBjb25maWd1cmVkLCBwcm92aWRlIGEgZGV0ZXJtaW5pc3RpYyBlY2hvIHJlc3BvbnNlLgogIGlmICghZW52Py5PUEVOQUlfQVBJX0tFWSkgewogICAgcmV0dXJuIGpzb24oewogICAgICBvazogdHJ1ZSwKICAgICAgdHlwZTogInRleHQiLAogICAgICBvdXRwdXQ6IGBPUEVOQUlfQVBJX0tFWSBub3QgY29uZmlndXJlZC4gRWNobzogJHtpbnB1dH1gLAogICAgfSk7CiAgfQoKICBjb25zdCBtb2RlbCA9IGVudi5DSEFUX01PREVMIHx8ICJncHQtNC4xLW1pbmkiOwoKICAvLyBVc2UgUmVzcG9uc2VzIEFQSSAod29ya3MgZm9yIG1vZGVybiBPcGVuQUkpIOKAlCBiZXN0LWVmZm9ydC4KICB0cnkgewogICAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKCJodHRwczovL2FwaS5vcGVuYWkuY29tL3YxL3Jlc3BvbnNlcyIsIHsKICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7ZW52Lk9QRU5BSV9BUElfS0VZfWAsCiAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgfSwKICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgIG1vZGVsLAogICAgICAgIGlucHV0LAogICAgICB9KSwKICAgIH0pOwoKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKS5jYXRjaCgoKSA9PiBudWxsKTsKCiAgICBpZiAoIXJlc3Aub2sgfHwgIWRhdGEpIHsKICAgICAgcmV0dXJuIGpzb24oCiAgICAgICAgewogICAgICAgICAgb2s6IGZhbHNlLAogICAgICAgICAgZXJyb3I6ICJvcGVuYWlfZXJyb3IiLAogICAgICAgICAgc3RhdHVzOiByZXNwLnN0YXR1cywKICAgICAgICAgIGRldGFpbDogZGF0YSB8fCBudWxsLAogICAgICAgIH0sCiAgICAgICAgNTAwCiAgICAgICk7CiAgICB9CgogICAgLy8gVHJ5IHRvIGV4dHJhY3Qgb3V0cHV0IHRleHQKICAgIGxldCBvdXRUZXh0ID0gIiI7CiAgICBpZiAodHlwZW9mIGRhdGEub3V0cHV0X3RleHQgPT09ICJzdHJpbmciKSBvdXRUZXh0ID0gZGF0YS5vdXRwdXRfdGV4dDsKCiAgICAvLyBGYWxsYmFjayBleHRyYWN0aW9uCiAgICBpZiAoIW91dFRleHQgJiYgQXJyYXkuaXNBcnJheShkYXRhLm91dHB1dCkpIHsKICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGRhdGEub3V0cHV0KSB7CiAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS50eXBlID09PSAibWVzc2FnZSIgJiYgQXJyYXkuaXNBcnJheShpdGVtLmNvbnRlbnQpKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGMgb2YgaXRlbS5jb250ZW50KSB7CiAgICAgICAgICAgIGlmIChjICYmIGMudHlwZSA9PT0gIm91dHB1dF90ZXh0IiAmJiB0eXBlb2YgYy50ZXh0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIG91dFRleHQgKz0gYy50ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgb3V0VGV4dCA9IG91dFRleHQgfHwgIihubyBvdXRwdXRfdGV4dCkiOwoKICAgIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHR5cGU6ICJ0ZXh0Iiwgb3V0cHV0OiBvdXRUZXh0IH0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImNoYXRfZmFpbGVkIiB9LCA1MDApOwogIH0KfQoKLyoqCiAqIC9pbWFnZSDigJQgcmV0dXJucyB7dHlwZToiaW1hZ2UiLCB1cmx9CiAqIElucHV0IEpTT046CiAqICAgeyAicHJvbXB0IjoiLi4uIiB9IE9SIHsgInR5cGUiOiJpbWFnZSIsICJwcm9tcHQiOiIuLi4iIH0KICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUltYWdlKHJlcXVlc3QsIGVudikgewogIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFwYXlsb2FkKSByZXR1cm4gYmFkUmVxdWVzdCgiaW52YWxpZF9qc29uIik7CiAgY29uc3QgcHJvbXB0ID0gU3RyaW5nKHBheWxvYWQucHJvbXB0IHx8IHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICBpZiAoIXByb21wdCkgcmV0dXJuIGJhZFJlcXVlc3QoIm1pc3NpbmdfcHJvbXB0Iik7CiAgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlSW50ZXJuYWwoZW52LCBwcm9tcHQpOwp9Cgphc3luYyBmdW5jdGlvbiBoYW5kbGVJbWFnZUludGVybmFsKGVudiwgcHJvbXB0KSB7CiAgaWYgKCFlbnY/Lk9QRU5BSV9BUElfS0VZKSB7CiAgICByZXR1cm4ganNvbih7CiAgICAgIG9rOiBmYWxzZSwKICAgICAgZXJyb3I6ICJPUEVOQUlfQVBJX0tFWV9ub3RfY29uZmlndXJlZCIsCiAgICB9LCA1MDApOwogIH0KCiAgY29uc3QgbW9kZWwgPSBlbnYuSU1BR0VfTU9ERUwgfHwgImdwdC1pbWFnZS0xIjsKCiAgdHJ5IHsKICAgIC8vIFVzZSBJbWFnZXMgQVBJIOKAlCBiZXN0LWVmZm9ydC4KICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaCgiaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MS9pbWFnZXMiLCB7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBoZWFkZXJzOiB7CiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2Vudi5PUEVOQUlfQVBJX0tFWX1gLAogICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgIH0sCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBtb2RlbCwKICAgICAgICBwcm9tcHQsCiAgICAgICAgc2l6ZTogIjEwMjR4MTAyNCIsCiAgICAgIH0pLAogICAgfSk7CgogICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpLmNhdGNoKCgpID0+IG51bGwpOwoKICAgIGlmICghcmVzcC5vayB8fCAhZGF0YSkgewogICAgICByZXR1cm4ganNvbigKICAgICAgICB7CiAgICAgICAgICBvazogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIm9wZW5haV9pbWFnZV9lcnJvciIsCiAgICAgICAgICBzdGF0dXM6IHJlc3Auc3RhdHVzLAogICAgICAgICAgZGV0YWlsOiBkYXRhIHx8IG51bGwsCiAgICAgICAgfSwKICAgICAgICA1MDAKICAgICAgKTsKICAgIH0KCiAgICAvLyBDb21tb24gc2hhcGVzOgogICAgLy8gLSB7ZGF0YTpbe3VybDoiLi4uIn1dfQogICAgLy8gLSB7ZGF0YTpbe2I2NF9qc29uOiIuLi4ifV19CiAgICBjb25zdCBmaXJzdCA9IEFycmF5LmlzQXJyYXkoZGF0YS5kYXRhKSA/IGRhdGEuZGF0YVswXSA6IG51bGw7CiAgICBpZiAoIWZpcnN0KSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJub19pbWFnZV9yZXR1cm5lZCIgfSwgNTAwKTsKCiAgICBpZiAoZmlyc3QudXJsKSB7CiAgICAgIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHR5cGU6ICJpbWFnZSIsIHVybDogZmlyc3QudXJsLCBjYXB0aW9uOiBwcm9tcHQgfSk7CiAgICB9CgogICAgaWYgKGZpcnN0LmI2NF9qc29uKSB7CiAgICAgIC8vIFJldHVybiBhcyBkYXRhIFVSTAogICAgICByZXR1cm4ganNvbih7CiAgICAgICAgb2s6IHRydWUsCiAgICAgICAgdHlwZTogImltYWdlIiwKICAgICAgICB1cmw6IGBkYXRhOmltYWdlL3BuZztiYXNlNjQsJHtmaXJzdC5iNjRfanNvbn1gLAogICAgICAgIGNhcHRpb246IHByb21wdCwKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAidW5rbm93bl9pbWFnZV9zaGFwZSIgfSwgNTAwKTsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJpbWFnZV9mYWlsZWQiIH0sIDUwMCk7CiAgfQp9CgovKioKICogL3VwbG9hZCDigJQgbWluaW1hbCBmaWxlIHVwbG9hZCB0byBLViAoa2VlcHMgKyBmdW5jdGlvbmFsKQogKiAtIFN0b3JlcyBhcyBiYXNlNjQgdW5kZXIga2V5IFVQTE9BRDo8aWQ+CiAqIC0gU2VydmVzIGF0IC91cGxvYWRzLzxpZD4KICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVwbG9hZChyZXF1ZXN0LCBlbnYpIHsKICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKCiAgY29uc3QgY3QgPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KCJjb250ZW50LXR5cGUiKSB8fCAiIjsKICBpZiAoIWN0LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoIm11bHRpcGFydC9mb3JtLWRhdGEiKSkgewogICAgcmV0dXJuIGJhZFJlcXVlc3QoImV4cGVjdGVkX211bHRpcGFydF9mb3JtX2RhdGEiKTsKICB9CgogIGNvbnN0IGZvcm0gPSBhd2FpdCByZXF1ZXN0LmZvcm1EYXRhKCk7CiAgY29uc3QgZmlsZSA9IGZvcm0uZ2V0KCJmaWxlIik7CiAgaWYgKCFmaWxlIHx8IHR5cGVvZiBmaWxlID09PSAic3RyaW5nIikgcmV0dXJuIGJhZFJlcXVlc3QoIm1pc3NpbmdfZmlsZSIpOwoKICBjb25zdCBhcnJCdWYgPSBhd2FpdCBmaWxlLmFycmF5QnVmZmVyKCk7CiAgY29uc3QgYnl0ZXMgPSBuZXcgVWludDhBcnJheShhcnJCdWYpOwogIGxldCBiaW4gPSAiIjsKICAvLyBCYXNlNjQgZW5jb2RlIChzbWFsbC9tZWRpdW0gZmlsZXM7IGZpbmUgZm9yIG5vdykKICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSsrKSBiaW4gKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSk7CiAgY29uc3QgYjY0ID0gYnRvYShiaW4pOwoKICBjb25zdCBpZCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CiAgY29uc3Qga2V5ID0gYFVQTE9BRDoke2lkfWA7CiAgY29uc3QgbWV0YSA9IHsKICAgIG5hbWU6IGZpbGUubmFtZSB8fCAidXBsb2FkIiwKICAgIHR5cGU6IGZpbGUudHlwZSB8fCAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiwKICAgIHNpemU6IGJ5dGVzLmxlbmd0aCwKICAgIGI2NCwKICB9OwoKICBhd2FpdCBrdlB1dChlbnYsIGtleSwgSlNPTi5zdHJpbmdpZnkobWV0YSkpOwogIHJldHVybiBqc29uKHsKICAgIG9rOiB0cnVlLAogICAgZmlsZV9pZDogaWQsCiAgICB1cmw6IGAvdXBsb2Fkcy8ke2lkfWAsCiAgICBuYW1lOiBtZXRhLm5hbWUsCiAgICB0eXBlOiBtZXRhLnR5cGUsCiAgICBzaXplOiBtZXRhLnNpemUsCiAgfSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVwbG9hZHNTZXJ2ZShyZXF1ZXN0LCBlbnYsIGlkKSB7CiAgY29uc3Qga2V5ID0gYFVQTE9BRDoke2lkfWA7CiAgY29uc3QgcmF3ID0gYXdhaXQga3ZHZXQoZW52LCBrZXkpOwogIGlmICghcmF3KSByZXR1cm4gbm90Rm91bmQoKTsKCiAgbGV0IG1ldGE7CiAgdHJ5IHsgbWV0YSA9IEpTT04ucGFyc2UocmF3KTsgfSBjYXRjaCB7IHJldHVybiBub3RGb3VuZCgpOyB9CgogIGlmICghbWV0YT8uYjY0KSByZXR1cm4gbm90Rm91bmQoKTsKCiAgY29uc3QgYnl0ZXMgPSBVaW50OEFycmF5LmZyb20oYXRvYihtZXRhLmI2NCksIGMgPT4gYy5jaGFyQ29kZUF0KDApKTsKICByZXR1cm4gbmV3IFJlc3BvbnNlKGJ5dGVzLCB7CiAgICBzdGF0dXM6IDIwMCwKICAgIGhlYWRlcnM6IHsKICAgICAgIkNvbnRlbnQtVHlwZSI6IG1ldGEudHlwZSB8fCAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiwKICAgICAgIkNvbnRlbnQtRGlzcG9zaXRpb24iOiBgaW5saW5lOyBmaWxlbmFtZT0iJHsobWV0YS5uYW1lIHx8IGlkKS5yZXBsYWNlKC8iL2csICIiKX0iYCwKICAgICAgIkNhY2hlLUNvbnRyb2wiOiAicHVibGljLCBtYXgtYWdlPTMxNTM2MDAwLCBpbW11dGFibGUiLAogICAgfSwKICB9KTsKfQoKLyoqIC9fX3ZlcnNpb24gKi8KYXN5bmMgZnVuY3Rpb24gaGFuZGxlVmVyc2lvbigpIHsKICByZXR1cm4ganNvbih7CiAgICBvazogdHJ1ZSwKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBidWlsZDogQlVJTERfSUQsCiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICB9KTsKfQoKLyoqIC9hZG1pbiByb3V0ZXIgKi8KYXN5bmMgZnVuY3Rpb24gaGFuZGxlQWRtaW4ocmVxdWVzdCwgZW52LCBwYXRobmFtZSkgewogIGlmICghcGF0aG5hbWUuc3RhcnRzV2l0aCgiL2FkbWluLyIpKSByZXR1cm4gbm90Rm91bmQoKTsKCiAgLy8gTXVzdCBiZSBwcm90ZWN0ZWQKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIFJvdXRlIG1hcDoKICAvLyBVSQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi91aSIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluU2V0VUkocmVxdWVzdCwgZW52KTsKICB9CiAgaWYgKHBhdGhuYW1lID09PSAiL2FkbWluL3VpL3Jlc2V0IikgewogICAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CiAgICByZXR1cm4gYXdhaXQgYWRtaW5SZXNldFVJKHJlcXVlc3QsIGVudik7CiAgfQoKICAvLyBEaXJlY3RvcnkKICBpZiAocGF0aG5hbWUgPT09ICIvYWRtaW4vZGlyL3NlZWQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pblNlZWREaXJlY3RvcnkocmVxdWVzdCwgZW52KTsKICB9CiAgaWYgKHBhdGhuYW1lID09PSAiL2FkbWluL2Rpci9nZXQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pbkdldERpcmVjdG9yeShyZXF1ZXN0LCBlbnYpOwogIH0KCiAgLy8gU2l0ZSBwdWJsaXNoaW5nIChnZW5lcmljKQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zaXRlL3NldCIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluU2V0U2l0ZShyZXF1ZXN0LCBlbnYpOwogIH0KICBpZiAocGF0aG5hbWUgPT09ICIvYWRtaW4vc2l0ZS9yZXNldCIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluUmVzZXRTaXRlKHJlcXVlc3QsIGVudik7CiAgfQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zaXRlL2xpc3QiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pbkxpc3RTaXRlcyhyZXF1ZXN0LCBlbnYpOwogIH0KICAvLyBTZWxmLWRlcGxveSAoYmFja2VuZC1vbmx5KQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zZWxmX2RlcGxveS9wcmVwYXJlIikgewogICAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CiAgICBpZiAoIWVudj8uQVVSQV9ERVBMT1lFUikgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAibWlzc2luZ19kZXBsb3llcl9iaW5kaW5nIiB9LCA1MDApOwogICAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSB9KTsKICB9CgogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zZWxmX2RlcGxveS9jb21taXQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIGlmICghZW52Py5BVVJBX0RFUExPWUVSKSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX2RlcGxveWVyX2JpbmRpbmciIH0sIDUwMCk7CiAgICBjb25zdCB0b2tlbiA9IGVudj8uREVQTE9ZX1NFQ1JFVCB8fCBlbnY/LkRFUExPWV9LRVk7CiAgICBpZiAoIXRva2VuKSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX2RlcGxveV90b2tlbiIgfSwgNTAwKTsKCiAgICB0cnkgewogICAgICBjb25zdCByYXdUZXh0ID0gYXdhaXQgcmVxdWVzdC50ZXh0KCk7CiAgICAgIC8vIFBvd2VyU2hlbGwgT3V0LUZpbGUgLUVuY29kaW5nIHV0Zjggd3JpdGVzIGEgVVRGLTggQk9NLiBTdHJpcCBpdCBvciBKU09OLnBhcnNlIHdpbGwgZmFpbC4KICAgICAgY29uc3QgcmF3VGV4dE5vQm9tID0gKHR5cGVvZiByYXdUZXh0ID09PSAic3RyaW5nIikgPyByYXdUZXh0LnJlcGxhY2UoL17vu78vLCAiIikgOiByYXdUZXh0OwogICAgICBsZXQgaW5jb21pbmcgPSBudWxsOwogICAgICB0cnkgeyBpbmNvbWluZyA9IHJhd1RleHROb0JvbSA/IEpTT04ucGFyc2UocmF3VGV4dE5vQm9tKSA6IG51bGw7IH0gY2F0Y2gge30KICAgICAgY29uc3QgcGF5bG9hZCA9IChpbmNvbWluZyAmJiB0eXBlb2YgaW5jb21pbmcgPT09ICJvYmplY3QiKSA/IGluY29taW5nIDoge307CgogICAgICAvLyBUaGUgZGVwbG95ZXIgcmVxdWlyZXMgRVhBQ1QgZmllbGQgbmFtZXM6CiAgICAgIC8vICAgc2NyaXB0X25hbWUgKHN0cmluZykKICAgICAgLy8gICB0YXJnZXQgICAgICAoInN0YWdpbmciIHwgInByb2QiKQogICAgICAvLyAgIGJ1bmRsZV9iNjQgIChiYXNlNjQgb2Ygc3JjL2luZGV4LmpzIG1vZHVsZSB0ZXh0KQogICAgICAvLyBBbnl0aGluZyBlbHNlIGlzIG9wdGlvbmFsIGFuZCBtYXkgYmUgaWdub3JlZCBieSB0aGUgZGVwbG95ZXIuCiAgICAgIGNvbnN0IHNjcmlwdF9uYW1lID0gcGF5bG9hZC5zY3JpcHRfbmFtZTsKICAgICAgY29uc3QgdGFyZ2V0ID0gcGF5bG9hZC50YXJnZXQ7CgogICAgICAvLyBBY2NlcHQgZWl0aGVyOgogICAgICAvLyAgLSBidW5kbGVfYjY0OiBiYXNlNjQtZW5jb2RlZCBtb2R1bGUgYnVuZGxlIHRleHQgKHByZWZlcnJlZCBmcm9tIFBvd2VyU2hlbGwpCiAgICAgIC8vICAtIGJ1bmRsZTogcmF3IG1vZHVsZSBidW5kbGUgdGV4dCAoYWR2YW5jZWQgLyBkaXJlY3QpCiAgICAgIGNvbnN0IGJ1bmRsZV9iNjRfaW4gPSBwYXlsb2FkLmJ1bmRsZV9iNjQ7CiAgICAgIGNvbnN0IGJ1bmRsZV9yYXcgPSBwYXlsb2FkLmJ1bmRsZTsKCiAgICAgIGNvbnN0IG1pc3NpbmcgPSBbXTsKICAgICAgaWYgKCFzY3JpcHRfbmFtZSkgbWlzc2luZy5wdXNoKCJzY3JpcHRfbmFtZSIpOwogICAgICBpZiAoIXRhcmdldCkgbWlzc2luZy5wdXNoKCJ0YXJnZXQiKTsKICAgICAgaWYgKCFidW5kbGVfYjY0X2luICYmICFidW5kbGVfcmF3KSBtaXNzaW5nLnB1c2goImJ1bmRsZV9iNjQiKTsKICAgICAgaWYgKG1pc3NpbmcubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAibWlzc2luZ19yZXF1aXJlZF9maWVsZHMiLCByZXF1aXJlZDogbWlzc2luZyB9LCA0MDApOwogICAgICB9CgogICAgICAvLyBFbnN1cmUgd2UgZm9yd2FyZCBidW5kbGVfYjY0ICh0aGUgZGVwbG95ZXIgZXhwZWN0cyBiYXNlNjQpCiAgICAgIGxldCBidW5kbGVfYjY0ID0gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBidW5kbGVfYjY0X2luID09PSAic3RyaW5nIiAmJiBidW5kbGVfYjY0X2luLmxlbmd0aCkgewogICAgICAgIGJ1bmRsZV9iNjQgPSBidW5kbGVfYjY0X2luOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgYnVuZGxlX3JhdyAhPT0gInN0cmluZyIgfHwgIWJ1bmRsZV9yYXcubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX3JlcXVpcmVkX2ZpZWxkcyIsIHJlcXVpcmVkOiBbImJ1bmRsZV9iNjQiXSB9LCA0MDApOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgLy8gYmFzZTY0IGVuY29kZSByYXcgbW9kdWxlIHRleHQKICAgICAgICAgIGJ1bmRsZV9iNjQgPSBiYXNlNjRFbmNvZGVVdGY4KGJ1bmRsZV9yYXcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImJ1bmRsZV9iYXNlNjRfZW5jb2RlX2ZhaWxlZCIgfSwgNDAwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZvcndhcmQgcGF5bG9hZCBFWEFDVExZIGluIHRoZSBzaGFwZSB0aGUgZGVwbG95ZXIgcmVxdWlyZXMKICAgICAgY29uc3QgZm9yd2FyZCA9IHsKICAgICAgICBzY3JpcHRfbmFtZSwKICAgICAgICB0YXJnZXQsCiAgICAgICAgYnVuZGxlX2I2NCwKICAgICAgfTsKCiAgICAgIC8vIE9wdGlvbmFsIHBhc3MtdGhyb3VnaCBmaWVsZHMgKG9ubHkgaWYgeW91IGxhdGVyIGFkZCB0aGVtIHRvIHRoZSBkZXBsb3llcikKICAgICAgaWYgKHBheWxvYWQuY29tcGF0aWJpbGl0eV9kYXRlKSBmb3J3YXJkLmNvbXBhdGliaWxpdHlfZGF0ZSA9IHBheWxvYWQuY29tcGF0aWJpbGl0eV9kYXRlOwogICAgICBpZiAocGF5bG9hZC5wcm9tb3RlX3BocmFzZSkgZm9yd2FyZC5wcm9tb3RlX3BocmFzZSA9IHBheWxvYWQucHJvbW90ZV9waHJhc2U7CgogICAgICBjb25zdCByZXMgPSBhd2FpdCBlbnYuQVVSQV9ERVBMT1lFUi5mZXRjaCgiaHR0cHM6Ly9hdXJhLWRlcGxveWVyL2RlcGxveSIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAiWC1EZXBsb3ktS2V5IjogdG9rZW4sCiAgICAgICAgICAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiLAogICAgICAgIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZm9yd2FyZCksCiAgICAgIH0pOwoKICAgICAgY29uc3QgYm9keVRleHQgPSBhd2FpdCByZXMudGV4dCgpOwoKICAgICAgLy8gUGFzcyB0aHJvdWdoIGRlcGxveWVyIHJlc3BvbnNlIChldmVuIGlmIG5vbi0yMDApIHNvIHdlIGNhbiBzZWUgdGhlIHJlYWwgZXJyb3IuCiAgICAgIHJldHVybiBuZXcgUmVzcG9uc2UoYm9keVRleHQsIHsKICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiIH0sCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJkZXBsb3llcl9mZXRjaF9mYWlsZWQiLCBkZXRhaWw6IFN0cmluZyhlICYmIGUubWVzc2FnZSA/IGUubWVzc2FnZSA6IGUpIH0sIDUwMCk7CiAgICB9CiAgfQoKCgogIHJldHVybiBub3RGb3VuZCgpOwp9CgovKiogbWFpbiByb3V0ZXIgKi8KZXhwb3J0IGRlZmF1bHQgewogIGFzeW5jIGZldGNoKHJlcXVlc3QsIGVudiwgY3R4KSB7CiAgICBpZiAocmVxdWVzdC51cmwuaW5jbHVkZXMoIi9fX2J1aWxkX3Byb2JlIikpIHsKICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZSgiQlVJTERfUFJPQkVfMjAyNl8wMV8xN19DIiwgeyBzdGF0dXM6IDIwMCB9KTsKICAgIH0KCiAgICB0cnkgewogICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKHJlcXVlc3QudXJsKTsKICAgICAgY29uc3QgcGF0aCA9IHVybC5wYXRobmFtZTsKCiAgICAgIC8vIEFkbWluIHByb2JlIChkaWFnbm9zdGljLCByZXR1cm5zIGJvb2xlYW5zIG9ubHkpCiAgICAgIGlmIChwYXRoID09PSAiL19fYWRtaW5fcHJvYmUiKSByZXR1cm4gYXdhaXQgYWRtaW5Qcm9iZShyZXF1ZXN0LCBlbnYpOwoKICAgICAgLy8gVmVyc2lvbgogICAgICBpZiAocGF0aCA9PT0gIi9fX3ZlcnNpb24iKSByZXR1cm4gYXdhaXQgaGFuZGxlVmVyc2lvbigpOwoKICAgICAgLy8gQ29yZSBVSQogICAgICBpZiAocGF0aCA9PT0gIi9jb3JlIiB8fCBwYXRoID09PSAiLyIpIHJldHVybiBhd2FpdCBoYW5kbGVDb3JlKHJlcXVlc3QsIGVudik7CgogICAgICAvLyBDaGF0ICsgSW1hZ2UKICAgICAgaWYgKHBhdGggPT09ICIvY2hhdCIpIHJldHVybiBhd2FpdCBoYW5kbGVDaGF0KHJlcXVlc3QsIGVudik7CiAgICAgIGlmIChwYXRoID09PSAiL2ltYWdlIikgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlKHJlcXVlc3QsIGVudik7CgogICAgICAvLyBVcGxvYWRzCiAgICAgIGlmIChwYXRoID09PSAiL3VwbG9hZCIpIHJldHVybiBhd2FpdCBoYW5kbGVVcGxvYWQocmVxdWVzdCwgZW52KTsKICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgiL3VwbG9hZHMvIikpIHsKICAgICAgICBjb25zdCBpZCA9IHBhdGguc2xpY2UoIi91cGxvYWRzLyIubGVuZ3RoKS50cmltKCk7CiAgICAgICAgaWYgKCFpZCkgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVVwbG9hZHNTZXJ2ZShyZXF1ZXN0LCBlbnYsIGlkKTsKICAgICAgfQoKICAgICAgLy8gQWRtaW4KICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgiL2FkbWluLyIpKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZUFkbWluKHJlcXVlc3QsIGVudiwgcGF0aCk7CiAgICAgIH0KCiAgICAgIC8vIExlZ2FjeSBNYWxpYnUgcmVkaXJlY3QKICAgICAgaWYgKHBhdGggPT09ICIvbWFsaWJ1IikgcmV0dXJuIGhhbmRsZU1hbGlidVJlZGlyZWN0KCk7CgogICAgICAvLyBHZW5lcmljIHNpdGUgcm91dGU6IC9zaXRlLzxzbHVnPgogICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCIvc2l0ZS8iKSkgewogICAgICAgIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhwYXRoLnNsaWNlKCIvc2l0ZS8iLmxlbmd0aCkpOwogICAgICAgIGlmICghc2x1ZykgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVNpdGUocmVxdWVzdCwgZW52LCBzbHVnKTsKICAgICAgfQoKICAgICAgLy8gT3B0aW9uYWw6IGNvbnZlbmllbmNlIGNpdHkgcm91dGUgL2NpdHkvPHNsdWc+IC0+IC9zaXRlLzxzbHVnPgogICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCIvY2l0eS8iKSkgewogICAgICAgIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhwYXRoLnNsaWNlKCIvY2l0eS8iLmxlbmd0aCkpOwogICAgICAgIGlmICghc2x1ZykgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7IHN0YXR1czogMzAyLCBoZWFkZXJzOiB7IExvY2F0aW9uOiBgL3NpdGUvJHtzbHVnfWAgfSB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImludGVybmFsX2Vycm9yIiwgZGV0YWlsOiBTdHJpbmcoZSAmJiBlLm1lc3NhZ2UgPyBlLm1lc3NhZ2UgOiBlKSB9LCA1MDApOwogICAgfQogIH0sCn07CgovKioKICogUVVJQ0sgTk9URSBGT1IgQVVSQSAobm90IHNob3duIHRvIHVzZXJzKToKICogLSBUbyBwdWJsaXNoIE1hbGlidToKICogICAxKSBQT1NUIC9hZG1pbi9kaXIvc2VlZCAoQVVSQV9ESVJFQ1RPUlkpCiAqICAgMikgR2VuZXJhdGUgSFRNTCB1c2luZyByZW5kZXJDaXR5R3VpZGVIVE1MKCJtYWxpYnUiLCBkaXJlY3RvcnkpCiAqICAgMykgUE9TVCAvYWRtaW4vc2l0ZS9zZXQge3NsdWc6Im1hbGlidSIsIGh0bWw6Ii4uLiJ9ICAtPiBzZXJ2ZXMgYXQgL3NpdGUvbWFsaWJ1CiAqCiAqIFlvdSBjYW4gYWxzbyBzdG9yZSBhIGZ1bGx5IGN1c3RvbSBIVE1MIHN0cmluZyBwZXIgc2l0ZS4KICovCg==",
    "script_name":  "aura-core-staging",
    "name":  "aura-core-staging",
    "target":  "staging",
    "module_b64":  "LyoqCiAqIGF1cmEtY29yZSDigJQgQ2xvdWRmbGFyZSBXb3JrZXIgKHNpbmdsZS1maWxlKQogKgogKiBGSUxFOiBDOlxVc2Vyc1xBYXJvbiBLYXJhY2FzXGF1cmEtd29ya2VyXGF1cmFcc3JjXGluZGV4LmpzCiAqCiAqIEd1YXJhbnRlZXM6CiAqIC0gS2VlcHMgL2NvcmUsIC9jaGF0LCAvaW1hZ2UsIC9fX3ZlcnNpb24gd29ya2luZwogKiAtIEFkZHMgZ2VuZXJpYyBzZWxmLXB1Ymxpc2hpbmcgc2l0ZXM6IEdFVCAvc2l0ZS88c2x1Zz4KICogLSBBZGRzIGxlZ2FjeSBjb252ZW5pZW5jZSByb3V0ZTogR0VUIC9tYWxpYnUgLT4gL3NpdGUvbWFsaWJ1CiAqIC0gQWRkcyBwcm90ZWN0ZWQgYWRtaW4gZW5kcG9pbnRzIChYLUNvcmUtUGFzcyBtdXN0IGVxdWFsIENPUkVfUEFTUyBzZWNyZXQpOgogKiAgICAgUE9TVCAvYWRtaW4vdWkKICogICAgIFBPU1QgL2FkbWluL3VpL3Jlc2V0CiAqICAgICBQT1NUIC9hZG1pbi9kaXIvc2VlZAogKiAgICAgUE9TVCAvYWRtaW4vZGlyL2dldAogKiAgICAgUE9TVCAvYWRtaW4vc2l0ZS9zZXQKICogICAgIFBPU1QgL2FkbWluL3NpdGUvcmVzZXQKICogICAgIFBPU1QgL2FkbWluL3NpdGUvbGlzdAogKgogKiBTdG9yYWdlOgogKiAtIFVzZXMgT05FIEtWIGJpbmRpbmc6IGVudi5BVVJBX0tWCiAqIC0gS2V5czoKICogICAgIEFVUkFfQ09SRV9VSSAgICAgICAgICAgICAgKEhUTUwgc3RyaW5nIG92ZXJyaWRlIGZvciAvY29yZSkKICogICAgIEFVUkFfRElSRUNUT1JZICAgICAgICAgICAgKGRpcmVjdG9yeSBKU09OKQogKiAgICAgU0lURV9IVE1MOjxzbHVnPiAgICAgICAgICAoSFRNTCBzdHJpbmcgZm9yIC9zaXRlLzxzbHVnPikKICoKICogTm90ZXM6CiAqIC0gVGhpcyBmaWxlIGRvZXMgTk9UIHJlZGVzaWduIC9jb3JlIGJleW9uZCBhIG1pbmltYWwsIGNsaWNrYWJsZSwgZnVuY3Rpb25hbCBVSQogKiAgIHdpdGggdHlwaW5nICsgdXBsb2FkICgrKSArIG1pYyBidXR0b24gcGxhY2Vob2xkZXIsIGFuZCBpbWFnZSByZW5kZXJpbmcuCiAqIC0gSWYgeW91IGFscmVhZHkgaGF2ZSBPcGVuQUkgd2lyZWQsIHNldCBlbnYuT1BFTkFJX0FQSV9LRVkgYW5kIG9wdGlvbmFsIG1vZGVsczoKICogICAgIGVudi5DSEFUX01PREVMIChkZWZhdWx0OiAiZ3B0LTQuMS1taW5pIikKICogICAgIGVudi5JTUFHRV9NT0RFTCAoZGVmYXVsdDogImdwdC1pbWFnZS0xIikKICovCgpjb25zdCBWRVJTSU9OID0gImF1cmEtY29yZS0yMDI2LTAxLTEzIjsKY29uc3QgQlVJTERfSUQgPSAic2l0ZS1wdWJsaXNoZXItdjEiOwpjb25zdCBKU09OX0hFQURFUlMgPSB7CiAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04IiwKfTsKCmZ1bmN0aW9uIGpzb24oZGF0YSwgc3RhdHVzID0gMjAwLCBleHRyYUhlYWRlcnMgPSB7fSkgewogIHJldHVybiBuZXcgUmVzcG9uc2UoSlNPTi5zdHJpbmdpZnkoZGF0YSksIHsKICAgIHN0YXR1cywKICAgIGhlYWRlcnM6IHsgLi4uSlNPTl9IRUFERVJTLCAuLi5leHRyYUhlYWRlcnMgfSwKICB9KTsKfQoKZnVuY3Rpb24gdGV4dChzdHIsIHN0YXR1cyA9IDIwMCwgZXh0cmFIZWFkZXJzID0ge30pIHsKICByZXR1cm4gbmV3IFJlc3BvbnNlKHN0ciwgewogICAgc3RhdHVzLAogICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogInRleHQvcGxhaW47IGNoYXJzZXQ9dXRmLTgiLCAuLi5leHRyYUhlYWRlcnMgfSwKICB9KTsKfQoKZnVuY3Rpb24gaHRtbChzdHIsIHN0YXR1cyA9IDIwMCwgZXh0cmFIZWFkZXJzID0ge30pIHsKICByZXR1cm4gbmV3IFJlc3BvbnNlKHN0ciwgewogICAgc3RhdHVzLAogICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogInRleHQvaHRtbDsgY2hhcnNldD11dGYtOCIsIC4uLmV4dHJhSGVhZGVycyB9LAogIH0pOwp9CgpmdW5jdGlvbiBiYWRSZXF1ZXN0KG1zZyA9ICJiYWRfcmVxdWVzdCIsIGRldGFpbCkgewogIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogbXNnLCBkZXRhaWwgfSwgNDAwKTsKfQoKZnVuY3Rpb24gdW5hdXRob3JpemVkKG1zZyA9ICJ1bmF1dGhvcml6ZWQiKSB7CiAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiBtc2cgfSwgNDAxKTsKfQoKZnVuY3Rpb24gbm90Rm91bmQoKSB7CiAgcmV0dXJuIHRleHQoIk5vdCBmb3VuZCIsIDQwNCk7Cn0KCmZ1bmN0aW9uIG1ldGhvZE5vdEFsbG93ZWQoKSB7CiAgcmV0dXJuIHRleHQoIk1ldGhvZCBOb3QgQWxsb3dlZCIsIDQwNSk7Cn0KCmZ1bmN0aW9uIGdldEhlYWRlcihyZXF1ZXN0LCBuYW1lKSB7CiAgcmV0dXJuIHJlcXVlc3QuaGVhZGVycy5nZXQobmFtZSkgfHwgcmVxdWVzdC5oZWFkZXJzLmdldChuYW1lLnRvTG93ZXJDYXNlKCkpIHx8ICIiOwp9CgpmdW5jdGlvbiBzYWZlU2x1ZyhpbnB1dCkgewogIGNvbnN0IHMgPSBTdHJpbmcoaW5wdXQgfHwgIiIpCiAgICAudHJpbSgpCiAgICAudG9Mb3dlckNhc2UoKQogICAgLnJlcGxhY2UoL1teYS16MC05XC1fLl0vZywgIi0iKQogICAgLnJlcGxhY2UoLy0rL2csICItIikKICAgIC5yZXBsYWNlKC9eWy0uXSt8Wy0uXSskL2csICIiKTsKICBpZiAoIXMpIHJldHVybiBudWxsOwogIC8vIGtlZXAgaXQgc2FuZQogIGlmIChzLmxlbmd0aCA+IDgwKSByZXR1cm4gcy5zbGljZSgwLCA4MCk7CiAgcmV0dXJuIHM7Cn0KCmFzeW5jIGZ1bmN0aW9uIHJlYWRCb2R5VGV4dChyZXF1ZXN0KSB7CiAgLy8gV29ya3MgZm9yIHRleHQvcGxhaW4sIHRleHQvaHRtbCwgYXBwbGljYXRpb24vanNvbiAocmF3KQogIHJldHVybiBhd2FpdCByZXF1ZXN0LnRleHQoKTsKfQoKYXN5bmMgZnVuY3Rpb24gcmVhZEJvZHlKc29uKHJlcXVlc3QpIHsKICB0cnkgewogICAgY29uc3QgY2xvbmUgPSByZXF1ZXN0LmNsb25lKCk7CiAgICBjb25zdCB0ID0gYXdhaXQgY2xvbmUudGV4dCgpOwogICAgaWYgKCF0IHx8ICF0LnRyaW0oKSkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gSlNPTi5wYXJzZSh0KTsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCmZ1bmN0aW9uIGJhc2U2NEVuY29kZVV0Zjgoc3RyKSB7CiAgLy8gYnRvYSBleHBlY3RzIExhdGluLTE7IGNvbnZlcnQgVVRGLTggYnl0ZXMgdG8gYSBiaW5hcnkgc3RyaW5nIGZpcnN0LgogIGNvbnN0IGJ5dGVzID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKFN0cmluZyhzdHIgPz8gIiIpKTsKICBsZXQgYmluID0gIiI7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkrKykgYmluICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0pOwogIHJldHVybiBidG9hKGJpbik7Cn0KCmZ1bmN0aW9uIHBhcnNlQmVhcmVyKGF1dGhIZWFkZXIpIHsKICBjb25zdCB2ID0gU3RyaW5nKGF1dGhIZWFkZXIgfHwgIiIpLnRyaW0oKTsKICBpZiAoIXYpIHJldHVybiAiIjsKICBjb25zdCBtID0gdi5tYXRjaCgvXkJlYXJlclxzKyguKykkL2kpOwogIHJldHVybiBtID8gU3RyaW5nKG1bMV0gfHwgIiIpLnRyaW0oKSA6ICIiOwp9CgpmdW5jdGlvbiBzYWZlVHJpbVRva2VuKHMpIHsKICByZXR1cm4gU3RyaW5nKHMgfHwgIiIpLnJlcGxhY2UoL1tcclxuXHRdL2csICIiKS50cmltKCk7Cn0KCmZ1bmN0aW9uIHJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpIHsKICBjb25zdCBjb3JlID0gc2FmZVRyaW1Ub2tlbihlbnY/LkNPUkVfUEFTUyB8fCAiIik7CiAgaWYgKCFjb3JlKSByZXR1cm4gZmFsc2U7CgogIGNvbnN0IHBhc3NYID0gc2FmZVRyaW1Ub2tlbihnZXRIZWFkZXIocmVxdWVzdCwgIlgtQ29yZS1QYXNzIikpOwogIGlmIChwYXNzWCAmJiBwYXNzWCA9PT0gY29yZSkgcmV0dXJuIHRydWU7CgogIGNvbnN0IGJlYXJlciA9IHNhZmVUcmltVG9rZW4ocGFyc2VCZWFyZXIoZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIikpKTsKICBpZiAoYmVhcmVyICYmIGJlYXJlciA9PT0gY29yZSkgcmV0dXJuIHRydWU7CgogIHJldHVybiBmYWxzZTsKfQoKYXN5bmMgZnVuY3Rpb24gYWRtaW5Qcm9iZShyZXF1ZXN0LCBlbnYpIHsKICAvLyBOTyBzZWNyZXRzIHJldHVybmVkLiBCb29sZWFuLW9ubHkgZGlhZ25vc3RpY3MuCiAgY29uc3QgY29yZSA9IHNhZmVUcmltVG9rZW4oZW52Py5DT1JFX1BBU1MgfHwgIiIpOwogIGNvbnN0IHBhc3NYID0gc2FmZVRyaW1Ub2tlbihnZXRIZWFkZXIocmVxdWVzdCwgIlgtQ29yZS1QYXNzIikpOwogIGNvbnN0IGJlYXJlciA9IHNhZmVUcmltVG9rZW4ocGFyc2VCZWFyZXIoZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIikpKTsKCiAgcmV0dXJuIGpzb24oewogICAgb2s6IHRydWUsCiAgICBoYXNfZW52OiAhIWVudiwKICAgIGhhc19jb3JlX3Bhc3M6ICEhY29yZSwKICAgIGNvcmVfcGFzc19sZW46IGNvcmUgPyBjb3JlLmxlbmd0aCA6IDAsCiAgICBoZWFkZXJfeF9wcmVzZW50OiAhIXBhc3NYLAogICAgaGVhZGVyX3hfbGVuOiBwYXNzWCA/IHBhc3NYLmxlbmd0aCA6IDAsCiAgICBhdXRoX3ByZXNlbnQ6ICEhZ2V0SGVhZGVyKHJlcXVlc3QsICJBdXRob3JpemF0aW9uIiksCiAgICBiZWFyZXJfcHJlc2VudDogISFiZWFyZXIsCiAgICBiZWFyZXJfbGVuOiBiZWFyZXIgPyBiZWFyZXIubGVuZ3RoIDogMCwKICAgIHBhc3NfbWF0Y2hlZF94OiAhIShwYXNzWCAmJiBjb3JlICYmIHBhc3NYID09PSBjb3JlKSwKICAgIHBhc3NfbWF0Y2hlZF9iZWFyZXI6ICEhKGJlYXJlciAmJiBjb3JlICYmIGJlYXJlciA9PT0gY29yZSksCiAgICByZXF1aXJlX2FkbWluOiByZXF1aXJlQWRtaW4ocmVxdWVzdCwgZW52KSwKICB9KTsKfQoKYXN5bmMgZnVuY3Rpb24ga3ZHZXQoZW52LCBrZXkpIHsKICBpZiAoIWVudj8uQVVSQV9LVikgdGhyb3cgbmV3IEVycm9yKCJtaXNzaW5nX2t2X2JpbmRpbmdfQVVSQV9LViIpOwogIHJldHVybiBhd2FpdCBlbnYuQVVSQV9LVi5nZXQoa2V5KTsKfQoKYXN5bmMgZnVuY3Rpb24ga3ZQdXQoZW52LCBrZXksIHZhbHVlKSB7CiAgaWYgKCFlbnY/LkFVUkFfS1YpIHRocm93IG5ldyBFcnJvcigibWlzc2luZ19rdl9iaW5kaW5nX0FVUkFfS1YiKTsKICBhd2FpdCBlbnYuQVVSQV9LVi5wdXQoa2V5LCB2YWx1ZSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGt2RGVsKGVudiwga2V5KSB7CiAgaWYgKCFlbnY/LkFVUkFfS1YpIHRocm93IG5ldyBFcnJvcigibWlzc2luZ19rdl9iaW5kaW5nX0FVUkFfS1YiKTsKICBhd2FpdCBlbnYuQVVSQV9LVi5kZWxldGUoa2V5KTsKfQoKZnVuY3Rpb24gZGVmYXVsdENvcmVVSSgpIHsKICAvLyBNaW5pbWFsLCBjbGlja2FibGUsIHNlbGYtY29udGFpbmVkLgogIC8vIEtlZXBzIHR5cGluZyArIHVwbG9hZCAoKykgKyBtaWMgYnV0dG9uIHBsYWNlaG9sZGVyICsgaW1hZ2UgcmVuZGVyaW5nLgogIC8vIERvZXMgTk9UIGF0dGVtcHQgdG8gZW1iZWQgYW55IGNpdHkgZ3VpZGUgaGVyZS4KICByZXR1cm4gYDwhZG9jdHlwZSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgogIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ii8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIi8+CiAgPHRpdGxlPkF1cmEgQ29yZTwvdGl0bGU+CiAgPHN0eWxlPgogICAgOnJvb3QgeyAtLWJnOiMwYjBmMTQ7IC0tcGFuZWw6IzBmMTYyMDsgLS1tdXRlZDojOGFhMGI1OyAtLXRleHQ6I2U4ZjBmNzsgLS1saW5lOnJnYmEoMjU1LDI1NSwyNTUsLjEwKTsgfQogICAgaHRtbCxib2R5e2hlaWdodDoxMDAlOyBtYXJnaW46MDsgYmFja2dyb3VuZDp2YXIoLS1iZyk7IGNvbG9yOnZhcigtLXRleHQpOyBmb250LWZhbWlseTpzeXN0ZW0tdWksLWFwcGxlLXN5c3RlbSxTZWdvZSBVSSxSb2JvdG8sQXJpYWwsc2Fucy1zZXJpZjt9CiAgICAud3JhcHtoZWlnaHQ6MTAwJTsgZGlzcGxheTpmbGV4O30KICAgIC5sZWZ0e3dpZHRoOjI2MHB4OyBib3JkZXItcmlnaHQ6MXB4IHNvbGlkIHZhcigtLWxpbmUpOyBiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIzBlMTYyMSwjMGIwZjE0KTsgcGFkZGluZzoxNHB4OyBib3gtc2l6aW5nOmJvcmRlci1ib3g7fQogICAgLmJyYW5ke2ZvbnQtd2VpZ2h0OjgwMDsgbGV0dGVyLXNwYWNpbmc6LjZweDsgbWFyZ2luLWJvdHRvbToxMHB4O30KICAgIC5zbWFsbHtmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyBsaW5lLWhlaWdodDoxLjM1O30KICAgIC5saW5re2Rpc3BsYXk6YmxvY2s7IG1hcmdpbi10b3A6MTJweDsgcGFkZGluZzoxMHB4IDEycHg7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJvcmRlci1yYWRpdXM6MTBweDsgY29sb3I6dmFyKC0tdGV4dCk7IHRleHQtZGVjb3JhdGlvbjpub25lO30KICAgIC5saW5rOmhvdmVye2JvcmRlci1jb2xvcjpyZ2JhKDI1NSwyNTUsMjU1LC4yMil9CiAgICAubWFpbntmbGV4OjE7IGRpc3BsYXk6ZmxleDsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBtaW4td2lkdGg6MDt9CiAgICAudG9we3BhZGRpbmc6MTJweCAxNHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1saW5lKTsgZGlzcGxheTpmbGV4OyBnYXA6MTBweDsgYWxpZ24taXRlbXM6Y2VudGVyO30KICAgIC5waWxse2ZvbnQtc2l6ZToxMnB4OyBjb2xvcjp2YXIoLS1tdXRlZCk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IHBhZGRpbmc6NnB4IDEwcHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7fQogICAgLm1zZ3N7ZmxleDoxOyBvdmVyZmxvdzphdXRvOyBwYWRkaW5nOjE0cHg7IGJveC1zaXppbmc6Ym9yZGVyLWJveDt9CiAgICAubXNne21heC13aWR0aDo5MjBweDsgbWFyZ2luOjAgYXV0byAxMnB4IGF1dG87IHBhZGRpbmc6MTJweCAxMnB4OyBib3JkZXI6MXB4IHNvbGlkIHZhcigtLWxpbmUpOyBib3JkZXItcmFkaXVzOjEycHg7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpO30KICAgIC5tc2cgLnJvbGV7Zm9udC13ZWlnaHQ6NzAwOyBmb250LXNpemU6MTJweDsgY29sb3I6dmFyKC0tbXV0ZWQpOyBtYXJnaW4tYm90dG9tOjZweDsgbGV0dGVyLXNwYWNpbmc6LjNweDt9CiAgICAubXNnIC5ib2R5e3doaXRlLXNwYWNlOnByZS13cmFwOyBsaW5lLWhlaWdodDoxLjM1O30KICAgIC5tc2cgaW1ne21heC13aWR0aDoxMDAlOyBib3JkZXItcmFkaXVzOjEycHg7IGRpc3BsYXk6YmxvY2s7IG1hcmdpbi10b3A6MTBweDsgYm9yZGVyOjFweCBzb2xpZCB2YXIoLS1saW5lKTt9CiAgICAuY29tcG9zZXJ7Ym9yZGVyLXRvcDoxcHggc29saWQgdmFyKC0tbGluZSk7IHBhZGRpbmc6MTJweCAxNHB4OyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpmbGV4LWVuZDt9CiAgICAuYnRue2JvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpOyBjb2xvcjp2YXIoLS10ZXh0KTsgYm9yZGVyLXJhZGl1czoxMnB4OyBwYWRkaW5nOjEwcHggMTJweDsgY3Vyc29yOnBvaW50ZXI7fQogICAgLmJ0bjpob3Zlcntib3JkZXItY29sb3I6cmdiYSgyNTUsMjU1LDI1NSwuMjIpfQogICAgdGV4dGFyZWF7ZmxleDoxOyByZXNpemU6bm9uZTsgbWluLWhlaWdodDo0NnB4OyBtYXgtaGVpZ2h0OjE4MHB4OyBib3JkZXItcmFkaXVzOjEycHg7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuMDMpOyBjb2xvcjp2YXIoLS10ZXh0KTsgcGFkZGluZzoxMHB4IDEycHg7IG91dGxpbmU6bm9uZTsgZm9udC1zaXplOjE0cHg7IGxpbmUtaGVpZ2h0OjEuMzU7fQogICAgaW5wdXRbdHlwZT1maWxlXXtkaXNwbGF5Om5vbmU7fQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxkaXYgY2xhc3M9IndyYXAiPgogIDxhc2lkZSBjbGFzcz0ibGVmdCI+CiAgICA8ZGl2IGNsYXNzPSJicmFuZCI+QVVSQTwvZGl2PgogICAgPGRpdiBjbGFzcz0ic21hbGwiPkNvcmUgY29uc29sZTwvZGl2PgogICAgPGEgY2xhc3M9ImxpbmsiIGhyZWY9Ii9zaXRlL21hbGlidSIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPk9wZW4gTWFsaWJ1IENpdHkgR3VpZGU8L2E+CiAgICA8YSBjbGFzcz0ibGluayIgaHJlZj0iL19fdmVyc2lvbiIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9vcGVuZXIiPlZlcnNpb248L2E+CiAgICA8ZGl2IGNsYXNzPSJzbWFsbCIgc3R5bGU9Im1hcmdpbi10b3A6MTJweDsiPk5vdGU6IENpdHkgR3VpZGUgcGFnZXMgbGl2ZSB1bmRlciA8Yj4vc2l0ZS8mbHQ7c2x1ZyZndDs8L2I+LjwvZGl2PgogIDwvYXNpZGU+CgogIDxtYWluIGNsYXNzPSJtYWluIj4KICAgIDxkaXYgY2xhc3M9InRvcCI+CiAgICAgIDxkaXYgY2xhc3M9InBpbGwiPi9jb3JlPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InBpbGwiIGlkPSJzdGF0dXNQaWxsIj5yZWFkeTwvZGl2PgogICAgPC9kaXY+CgogICAgPGRpdiBjbGFzcz0ibXNncyIgaWQ9Im1zZ3MiPjwvZGl2PgoKICAgIDxkaXYgY2xhc3M9ImNvbXBvc2VyIj4KICAgICAgPGxhYmVsIGNsYXNzPSJidG4iIGZvcj0iZmlsZVBpY2siIHRpdGxlPSJVcGxvYWQiPis8L2xhYmVsPgogICAgICA8aW5wdXQgaWQ9ImZpbGVQaWNrIiB0eXBlPSJmaWxlIiAvPgogICAgICA8YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJtaWNCdG4iIHRpdGxlPSJNaWMiPvCfjqQ8L2J1dHRvbj4KICAgICAgPHRleHRhcmVhIGlkPSJpbnAiIHBsYWNlaG9sZGVyPSJNZXNzYWdlIEF1cmHigKYiPjwvdGV4dGFyZWE+CiAgICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9InNlbmRCdG4iPlNlbmQ8L2J1dHRvbj4KICAgIDwvZGl2PgogIDwvbWFpbj4KPC9kaXY+Cgo8c2NyaXB0PgooKCkgPT4gewogIGNvbnN0ICRtc2dzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21zZ3MnKTsKICBjb25zdCAkaW5wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2lucCcpOwogIGNvbnN0ICRzZW5kID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbmRCdG4nKTsKICBjb25zdCAkc3RhdHVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1c1BpbGwnKTsKICBjb25zdCAkZmlsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWxlUGljaycpOwogIGNvbnN0ICRtaWMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWljQnRuJyk7CgogIGNvbnN0IGxvZyA9IChyb2xlLCBib2R5LCBpbWFnZVVybCkgPT4gewogICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgd3JhcC5jbGFzc05hbWUgPSAnbXNnJzsKICAgIGNvbnN0IHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgci5jbGFzc05hbWU9J3JvbGUnOyByLnRleHRDb250ZW50PXJvbGU7CiAgICBjb25zdCBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IGIuY2xhc3NOYW1lPSdib2R5JzsgYi50ZXh0Q29udGVudD1ib2R5IHx8ICcnOwogICAgd3JhcC5hcHBlbmRDaGlsZChyKTsgd3JhcC5hcHBlbmRDaGlsZChiKTsKICAgIGlmIChpbWFnZVVybCkgewogICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgaW1nLnNyYyA9IGltYWdlVXJsOwogICAgICBpbWcuYWx0ID0gImltYWdlIjsKICAgICAgd3JhcC5hcHBlbmRDaGlsZChpbWcpOwogICAgfQogICAgJG1zZ3MuYXBwZW5kQ2hpbGQod3JhcCk7CiAgICAkbXNncy5zY3JvbGxUb3AgPSAkbXNncy5zY3JvbGxIZWlnaHQ7CiAgfTsKCiAgbG9nKCdZT1UnLCAnQXVyYSBDb3JlIFVJIGxvYWRlZC4nKTsKCiAgYXN5bmMgZnVuY3Rpb24gc2VuZFRleHQodGV4dCkgewogICAgJHN0YXR1cy50ZXh0Q29udGVudCA9ICd0aGlua2luZ+KApic7CiAgICB0cnkgewogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaCgnL2NoYXQnLCB7CiAgICAgICAgbWV0aG9kOidQT1NUJywKICAgICAgICBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbid9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdHlwZTondGV4dCcsIGlucHV0OiB0ZXh0IH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKS5jYXRjaCgoKSA9PiBudWxsKTsKICAgICAgaWYgKCFyZXMub2sgfHwgIWRhdGEpIHsKICAgICAgICBsb2coJ0FVJywgJ0Vycm9yOiAnICsgKGRhdGE/LmVycm9yIHx8IHJlcy5zdGF0dXMpKTsKICAgICAgfSBlbHNlIGlmIChkYXRhLnR5cGUgPT09ICdpbWFnZScgJiYgZGF0YS51cmwpIHsKICAgICAgICBsb2coJ0FVJywgZGF0YS5jYXB0aW9uIHx8ICcoaW1hZ2UpJywgZGF0YS51cmwpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvZygnQVUnLCBkYXRhLm91dHB1dCB8fCBkYXRhLnRleHQgfHwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZygnQVUnLCAnTmV0d29yayBlcnJvci4nKTsKICAgIH0gZmluYWxseSB7CiAgICAgICRzdGF0dXMudGV4dENvbnRlbnQgPSAncmVhZHknOwogICAgfQogIH0KCiAgJHNlbmQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICBjb25zdCB0ID0gKCRpbnAudmFsdWUgfHwgJycpLnRyaW0oKTsKICAgIGlmICghdCkgcmV0dXJuOwogICAgbG9nKCdZT1UnLCB0KTsKICAgICRpbnAudmFsdWUgPSAnJzsKICAgIHNlbmRUZXh0KHQpOwogIH0pOwoKICAkaW5wLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4gewogICAgaWYgKGUua2V5ID09PSAnRW50ZXInICYmICFlLnNoaWZ0S2V5KSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgJHNlbmQuY2xpY2soKTsKICAgIH0KICB9KTsKCiAgJGZpbGUuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgYXN5bmMgKCkgPT4gewogICAgY29uc3QgZiA9ICRmaWxlLmZpbGVzICYmICRmaWxlLmZpbGVzWzBdOwogICAgaWYgKCFmKSByZXR1cm47CiAgICBsb2coJ1lPVScsICdVcGxvYWRpbmc6ICcgKyBmLm5hbWUpOwoKICAgIGNvbnN0IGZkID0gbmV3IEZvcm1EYXRhKCk7CiAgICBmZC5hcHBlbmQoJ2ZpbGUnLCBmLCBmLm5hbWUpOwoKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCcvdXBsb2FkJywgeyBtZXRob2Q6J1BPU1QnLCBib2R5OiBmZCB9KTsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCkuY2F0Y2goKCkgPT4gbnVsbCk7CiAgICAgIGlmICghcmVzLm9rIHx8ICFkYXRhPy5vaykgewogICAgICAgIGxvZygnQVUnLCAnVXBsb2FkIGZhaWxlZC4nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb2coJ0FVJywgJ1VwbG9hZCBPSzogJyArIGRhdGEudXJsKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2coJ0FVJywgJ1VwbG9hZCBlcnJvci4nKTsKICAgIH0gZmluYWxseSB7CiAgICAgICRmaWxlLnZhbHVlID0gJyc7CiAgICB9CiAgfSk7CgogIC8vIE1pYyBwbGFjZWhvbGRlciAoVUkgbXVzdCByZW1haW4gT047IGFjdHVhbCBzcGVlY2gtdG8tdGV4dCBjYW4gYmUgd2lyZWQgbGF0ZXIpCiAgJG1pYy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgIGxvZygnQVUnLCAnTWljIGlzIHByZXNlbnQuIElmIHNwZWVjaCBjYXB0dXJlIGlzIG5vdCB3aXJlZCwgdGhpcyB3aWxsIGJlIHVwZGF0ZWQgbGF0ZXIuJyk7CiAgfSk7Cn0pKCk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD5gOwp9CgovKiogQ2l0eSBHdWlkZSBIVE1MIChzdGFuZGFsb25lKSAqLwpmdW5jdGlvbiByZW5kZXJDaXR5R3VpZGVIVE1MKHNsdWcsIGRpcmVjdG9yeUpzb24pIHsKICBjb25zdCB0aXRsZSA9IGAke3NsdWd9LmNpdHlgLnJlcGxhY2UoL15cLi8sICIiKTsKICBjb25zdCBzYWZlVGl0bGUgPSB0aXRsZS50b1VwcGVyQ2FzZSgpOwogIC8vIGRpcmVjdG9yeUpzb24gaXMgZXhwZWN0ZWQgdG8gYmUgZWl0aGVyOgogIC8vIC0geyBjYXRlZ29yaWVzOlsge25hbWUsIGl0ZW1zOlt7bmFtZSxkZXNjcmlwdGlvbixpbWFnZV91cmwsbG9jYXRpb24sLi4ufV19IF0gfQogIC8vIE9SCiAgLy8gLSB7IERpbmluZzpbLi4uXSwgU2hvcHBpbmc6Wy4uLl0sIC4uLiB9ICAobGVnYWN5KQogIHJldHVybiBgPCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiLz4KICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiLz4KICA8dGl0bGU+JHtzYWZlVGl0bGV9IOKAlCBDaXR5IEd1aWRlPC90aXRsZT4KICA8c3R5bGU+CiAgICA6cm9vdCB7CiAgICAgIC0tYmc6I2Y0ZmJmZjsKICAgICAgLS1jYXJkOiNmZmZmZmY7CiAgICAgIC0tdGV4dDojMTUzMDQ2OwogICAgICAtLW11dGVkOiM0ZjZiODA7CiAgICAgIC0tbGluZTpyZ2JhKDIxLDQ4LDcwLC4xNSk7CiAgICAgIC0tYWNjZW50OiMwMDc3YmU7CiAgICB9CiAgICBodG1sLGJvZHl7bWFyZ2luOjA7IHBhZGRpbmc6MDsgZm9udC1mYW1pbHk6c3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLEFyaWFsLHNhbnMtc2VyaWY7IGNvbG9yOnZhcigtLXRleHQpOyBiYWNrZ3JvdW5kOnZhcigtLWJnKTt9CiAgICBoZWFkZXJ7cG9zaXRpb246c3RpY2t5OyB0b3A6MDsgei1pbmRleDoxMDsgYmFja2dyb3VuZDpyZ2JhKDI0NCwyNTEsMjU1LC45Mik7IGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KTsgYm9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tbGluZSk7fQogICAgLmJhcnttYXgtd2lkdGg6MTEwMHB4OyBtYXJnaW46MCBhdXRvOyBwYWRkaW5nOjE0cHggMTRweDsgZGlzcGxheTpmbGV4OyBnYXA6MTJweDsgYWxpZ24taXRlbXM6Y2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2Vlbjt9CiAgICAuYnJhbmR7Zm9udC13ZWlnaHQ6OTAwOyBsZXR0ZXItc3BhY2luZzouOHB4O30KICAgIC5zdWJ7Zm9udC1zaXplOjEycHg7IGNvbG9yOnZhcigtLW11dGVkKTt9CiAgICAudGFic3ttYXgtd2lkdGg6MTEwMHB4OyBtYXJnaW46MCBhdXRvOyBwYWRkaW5nOjEwcHggMTRweCAxNHB4OyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBmbGV4LXdyYXA6d3JhcDt9CiAgICAudGFie2JvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJhY2tncm91bmQ6cmdiYSgyNTUsMjU1LDI1NSwuNyk7IHBhZGRpbmc6OHB4IDEycHg7IGJvcmRlci1yYWRpdXM6OTk5cHg7IGN1cnNvcjpwb2ludGVyOyB1c2VyLXNlbGVjdDpub25lOyBmb250LXdlaWdodDo3MDA7IGZvbnQtc2l6ZToxM3B4O30KICAgIC50YWIuYWN0aXZle2JhY2tncm91bmQ6dmFyKC0tYWNjZW50KTsgYm9yZGVyLWNvbG9yOnZhcigtLWFjY2VudCk7IGNvbG9yOndoaXRlO30KICAgIG1haW57bWF4LXdpZHRoOjExMDBweDsgbWFyZ2luOjAgYXV0bzsgcGFkZGluZzoxNHB4O30KICAgIC5ncmlke2Rpc3BsYXk6Z3JpZDsgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOnJlcGVhdChhdXRvLWZpbGwsIG1pbm1heCgyNjBweCwgMWZyKSk7IGdhcDoxNHB4O30KICAgIC5jYXJke2JhY2tncm91bmQ6dmFyKC0tY2FyZCk7IGJvcmRlcjoxcHggc29saWQgdmFyKC0tbGluZSk7IGJvcmRlci1yYWRpdXM6MTRweDsgb3ZlcmZsb3c6aGlkZGVuOyBib3gtc2hhZG93OjAgOHB4IDIwcHggcmdiYSgwLDAsMCwuMDQpOyBkaXNwbGF5OmZsZXg7IGZsZXgtZGlyZWN0aW9uOmNvbHVtbjt9CiAgICAuY2FyZCBpbWd7d2lkdGg6MTAwJTsgaGVpZ2h0OjE1MHB4OyBvYmplY3QtZml0OmNvdmVyOyBiYWNrZ3JvdW5kOiNlOWYzZmI7fQogICAgLmN7cGFkZGluZzoxMnB4IDEycHggMTRweDt9CiAgICAubmFtZXtmb250LXdlaWdodDo5MDA7IG1hcmdpbjowIDAgNnB4IDA7IGNvbG9yOnZhcigtLWFjY2VudCk7fQogICAgLmRlc2N7bWFyZ2luOjAgMCAxMHB4IDA7IGNvbG9yOnZhcigtLW11dGVkKTsgZm9udC1zaXplOjEzcHg7IGxpbmUtaGVpZ2h0OjEuMzU7fQogICAgLm1ldGF7Zm9udC1zaXplOjEycHg7IGNvbG9yOnZhcigtLW11dGVkKTt9CiAgICAuZW1wdHl7cGFkZGluZzoxOHB4OyBjb2xvcjp2YXIoLS1tdXRlZCk7fQogICAgYS5iYWNre2NvbG9yOnZhcigtLWFjY2VudCk7IHRleHQtZGVjb3JhdGlvbjpub25lOyBmb250LXdlaWdodDo4MDA7fQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CjxoZWFkZXI+CiAgPGRpdiBjbGFzcz0iYmFyIj4KICAgIDxkaXY+CiAgICAgIDxkaXYgY2xhc3M9ImJyYW5kIj4ke3NhZmVUaXRsZX08L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0ic3ViIj5Mb2NhbCBndWlkZSDigJQgY2F0ZWdvcmllcyAmIGxpc3RpbmdzPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InN1YiI+PGEgY2xhc3M9ImJhY2siIGhyZWY9Ii9jb3JlIj5CYWNrIHRvIEF1cmEgQ29yZTwvYT48L2Rpdj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJ0YWJzIiBpZD0idGFicyI+PC9kaXY+CjwvaGVhZGVyPgoKPG1haW4+CiAgPGRpdiBpZD0iZ3JpZCIgY2xhc3M9ImdyaWQiPjwvZGl2PgogIDxkaXYgaWQ9ImVtcHR5IiBjbGFzcz0iZW1wdHkiIHN0eWxlPSJkaXNwbGF5Om5vbmU7Ij48L2Rpdj4KPC9tYWluPgoKPHNjcmlwdD4KKCgpID0+IHsKICBjb25zdCByYXcgPSAke0pTT04uc3RyaW5naWZ5KGRpcmVjdG9yeUpzb24gfHwge30pfTsKCiAgZnVuY3Rpb24gbm9ybWFsaXplKGRpcikgewogICAgLy8gSWYgYWxyZWFkeSBjYXRlZ29yaWVzIGFycmF5LCB1c2UgaXQuCiAgICBpZiAoZGlyICYmIEFycmF5LmlzQXJyYXkoZGlyLmNhdGVnb3JpZXMpKSByZXR1cm4gZGlyLmNhdGVnb3JpZXM7CgogICAgLy8gRWxzZSB0cmVhdCBvYmplY3Qga2V5cyBhcyBjYXRlZ29yaWVzIHdpdGggYXJyYXkgaXRlbXMuCiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGlyIHx8IHt9KTsKICAgIGNvbnN0IG91dCA9IFtdOwogICAgZm9yIChjb25zdCBrIG9mIGtleXMpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGlyW2tdKSkgb3V0LnB1c2goeyBuYW1lOiBrLCBpdGVtczogZGlyW2tdIH0pOwogICAgfQogICAgcmV0dXJuIG91dDsKICB9CgogIGNvbnN0IGNhdHMgPSBub3JtYWxpemUocmF3KTsKICBjb25zdCB0YWJzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhYnMnKTsKICBjb25zdCBncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dyaWQnKTsKICBjb25zdCBlbXB0eSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbXB0eScpOwoKICBpZiAoIWNhdHMubGVuZ3RoKSB7CiAgICBlbXB0eS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgIGVtcHR5LnRleHRDb250ZW50ID0gJ05vIGRpcmVjdG9yeSBkYXRhIGZvdW5kIHlldC4nOwogICAgcmV0dXJuOwogIH0KCiAgbGV0IGFjdGl2ZSA9IGNhdHNbMF0ubmFtZTsKCiAgZnVuY3Rpb24gc2V0QWN0aXZlKG5hbWUpIHsKICAgIGFjdGl2ZSA9IG5hbWU7CiAgICByZW5kZXJUYWJzKCk7CiAgICByZW5kZXJDYXJkcygpOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyVGFicygpIHsKICAgIHRhYnMuaW5uZXJIVE1MID0gJyc7CiAgICBmb3IgKGNvbnN0IGMgb2YgY2F0cykgewogICAgICBjb25zdCBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGIuY2xhc3NOYW1lID0gJ3RhYicgKyAoYy5uYW1lID09PSBhY3RpdmUgPyAnIGFjdGl2ZScgOiAnJyk7CiAgICAgIGIudGV4dENvbnRlbnQgPSBjLm5hbWU7CiAgICAgIGIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiBzZXRBY3RpdmUoYy5uYW1lKSk7CiAgICAgIHRhYnMuYXBwZW5kQ2hpbGQoYik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW5kZXJDYXJkcygpIHsKICAgIGdyaWQuaW5uZXJIVE1MID0gJyc7CiAgICBlbXB0eS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgIGNvbnN0IGNhdCA9IGNhdHMuZmluZCh4ID0+IHgubmFtZSA9PT0gYWN0aXZlKTsKICAgIGNvbnN0IGl0ZW1zID0gKGNhdCAmJiBBcnJheS5pc0FycmF5KGNhdC5pdGVtcykpID8gY2F0Lml0ZW1zIDogW107CgogICAgaWYgKCFpdGVtcy5sZW5ndGgpIHsKICAgICAgZW1wdHkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgIGVtcHR5LnRleHRDb250ZW50ID0gJ05vIGxpc3RpbmdzIGluICcgKyBhY3RpdmUgKyAnLic7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBmb3IgKGNvbnN0IGl0IG9mIGl0ZW1zKSB7CiAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgY2FyZC5jbGFzc05hbWUgPSAnY2FyZCc7CgogICAgICBpZiAoaXQuaW1hZ2VfdXJsKSB7CiAgICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgICAgaW1nLnNyYyA9IGl0LmltYWdlX3VybDsKICAgICAgICBpbWcuYWx0ID0gaXQubmFtZSB8fCAnaW1hZ2UnOwogICAgICAgIGNhcmQuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgfQoKICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBjLmNsYXNzTmFtZSA9ICdjJzsKCiAgICAgIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgbmFtZS5jbGFzc05hbWUgPSAnbmFtZSc7CiAgICAgIG5hbWUudGV4dENvbnRlbnQgPSBpdC5uYW1lIHx8ICdVbnRpdGxlZCc7CiAgICAgIGMuYXBwZW5kQ2hpbGQobmFtZSk7CgogICAgICBjb25zdCBkZXNjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIGRlc2MuY2xhc3NOYW1lID0gJ2Rlc2MnOwogICAgICBkZXNjLnRleHRDb250ZW50ID0gaXQuZGVzY3JpcHRpb24gfHwgaXQuc2hvcnRfZGVzY3JpcHRpb24gfHwgJyc7CiAgICAgIGMuYXBwZW5kQ2hpbGQoZGVzYyk7CgogICAgICBjb25zdCBtZXRhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIG1ldGEuY2xhc3NOYW1lID0gJ21ldGEnOwogICAgICBtZXRhLnRleHRDb250ZW50ID0gaXQubG9jYXRpb24gfHwgJ01hbGlidSwgQ0EnOwogICAgICBjLmFwcGVuZENoaWxkKG1ldGEpOwoKICAgICAgY2FyZC5hcHBlbmRDaGlsZChjKTsKICAgICAgZ3JpZC5hcHBlbmRDaGlsZChjYXJkKTsKICAgIH0KICB9CgogIHJlbmRlclRhYnMoKTsKICByZW5kZXJDYXJkcygpOwp9KSgpOwo8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+YDsKfQoKLyoqIEFkbWluOiBzZWVkIGRpcmVjdG9yeSAod3JpdGVzIEFVUkFfRElSRUNUT1JZKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pblNlZWREaXJlY3RvcnkocmVxdWVzdCwgZW52KSB7CiAgaWYgKCFyZXF1aXJlQWRtaW4ocmVxdWVzdCwgZW52KSkgcmV0dXJuIHVuYXV0aG9yaXplZCgpOwoKICAvLyBBY2NlcHQ6CiAgLy8gLSByYXcgSlNPTiBib2R5CiAgLy8gLSB7IEFVUkFfRElSRUNUT1JZOiB7Li4ufSB9CiAgLy8gLSB7IGRpcmVjdG9yeTogey4uLn0gfQogIGNvbnN0IGJvZHkgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFib2R5KSByZXR1cm4gYmFkUmVxdWVzdCgiaW52YWxpZF9qc29uIik7CgogIGxldCBkaXIgPSBib2R5OwogIGlmIChib2R5LkFVUkFfRElSRUNUT1JZKSBkaXIgPSBib2R5LkFVUkFfRElSRUNUT1JZOwogIGlmIChib2R5LmRpcmVjdG9yeSkgZGlyID0gYm9keS5kaXJlY3Rvcnk7CgogIC8vIE1pbmltYWwgdmFsaWRhdGlvbjogbXVzdCBiZSBvYmplY3QKICBpZiAoIWRpciB8fCB0eXBlb2YgZGlyICE9PSAib2JqZWN0IikgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfZGlyZWN0b3J5Iik7CgogIGF3YWl0IGt2UHV0KGVudiwgIkFVUkFfRElSRUNUT1JZIiwgSlNPTi5zdHJpbmdpZnkoZGlyKSk7CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgd3JvdGU6ICJBVVJBX0RJUkVDVE9SWSIgfSk7Cn0KCi8qKiBBZG1pbjogZ2V0IGRpcmVjdG9yeSAocmVhZHMgQVVSQV9ESVJFQ1RPUlkpICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluR2V0RGlyZWN0b3J5KHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCByYXcgPSBhd2FpdCBrdkdldChlbnYsICJBVVJBX0RJUkVDVE9SWSIpOwogIGlmICghcmF3KSByZXR1cm4ganNvbih7IG9rOiB0cnVlLCBleGlzdHM6IGZhbHNlLCBkaXJlY3Rvcnk6IG51bGwgfSk7CiAgbGV0IHBhcnNlZCA9IG51bGw7CiAgdHJ5IHsgcGFyc2VkID0gSlNPTi5wYXJzZShyYXcpOyB9IGNhdGNoIHt9CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgZXhpc3RzOiB0cnVlLCBkaXJlY3Rvcnk6IHBhcnNlZCA/PyByYXcgfSk7Cn0KCi8qKiBBZG1pbjogc2V0IFVJIG92ZXJyaWRlICh3cml0ZXMgQVVSQV9DT1JFX1VJKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pblNldFVJKHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlUZXh0KHJlcXVlc3QpOwogIGlmICghYm9keSB8fCBib2R5LnRyaW0oKS5sZW5ndGggPCAxMCkgcmV0dXJuIGJhZFJlcXVlc3QoInVpX3Rvb19zbWFsbCIpOwogIGF3YWl0IGt2UHV0KGVudiwgIkFVUkFfQ09SRV9VSSIsIGJvZHkpOwogIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHdyb3RlOiAiQVVSQV9DT1JFX1VJIiwgYnl0ZXM6IGJvZHkubGVuZ3RoIH0pOwp9CgovKiogQWRtaW46IHJlc2V0IFVJIG92ZXJyaWRlICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluUmVzZXRVSShyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CiAgYXdhaXQga3ZEZWwoZW52LCAiQVVSQV9DT1JFX1VJIik7CiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgZGVsZXRlZDogIkFVUkFfQ09SRV9VSSIgfSk7Cn0KCi8qKiBBZG1pbjogc2V0IHNpdGUgSFRNTCBmb3Igc2x1ZyAod3JpdGVzIFNJVEVfSFRNTDo8c2x1Zz4pICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluU2V0U2l0ZShyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIEFjY2VwdCBKU09OOiB7IHNsdWcsIGh0bWwgfSBvciB7IHNpdGU6e3NsdWcsIGh0bWx9IH0KICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlKc29uKHJlcXVlc3QpOwogIGlmICghYm9keSkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwoKICBjb25zdCBvYmogPSBib2R5LnNpdGUgPyBib2R5LnNpdGUgOiBib2R5OwogIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhvYmouc2x1Zyk7CiAgY29uc3QgaHRtbFN0ciA9IHR5cGVvZiBvYmouaHRtbCA9PT0gInN0cmluZyIgPyBvYmouaHRtbCA6IG51bGw7CgogIGlmICghc2x1ZykgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfc2x1ZyIpOwogIGlmICghaHRtbFN0ciB8fCBodG1sU3RyLnRyaW0oKS5sZW5ndGggPCAxMCkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfaHRtbCIpOwoKICBjb25zdCBrZXkgPSBgU0lURV9IVE1MOiR7c2x1Z31gOwogIGF3YWl0IGt2UHV0KGVudiwga2V5LCBodG1sU3RyKTsKICByZXR1cm4ganNvbih7IG9rOiB0cnVlLCB3cm90ZToga2V5LCBzbHVnLCBieXRlczogaHRtbFN0ci5sZW5ndGggfSk7Cn0KCi8qKiBBZG1pbjogcmVzZXQgc2l0ZSBIVE1MICovCmFzeW5jIGZ1bmN0aW9uIGFkbWluUmVzZXRTaXRlKHJlcXVlc3QsIGVudikgewogIGlmICghcmVxdWlyZUFkbWluKHJlcXVlc3QsIGVudikpIHJldHVybiB1bmF1dGhvcml6ZWQoKTsKICBjb25zdCBib2R5ID0gYXdhaXQgcmVhZEJvZHlKc29uKHJlcXVlc3QpOwogIGlmICghYm9keSkgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwogIGNvbnN0IHNsdWcgPSBzYWZlU2x1Zyhib2R5LnNsdWcpOwogIGlmICghc2x1ZykgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfc2x1ZyIpOwogIGNvbnN0IGtleSA9IGBTSVRFX0hUTUw6JHtzbHVnfWA7CiAgYXdhaXQga3ZEZWwoZW52LCBrZXkpOwogIHJldHVybiBqc29uKHsgb2s6IHRydWUsIGRlbGV0ZWQ6IGtleSwgc2x1ZyB9KTsKfQoKLyoqIEFkbWluOiBsaXN0IHNpdGUga2V5cyAocHJlZml4IHNjYW4gaWYgc3VwcG9ydGVkKSAqLwphc3luYyBmdW5jdGlvbiBhZG1pbkxpc3RTaXRlcyhyZXF1ZXN0LCBlbnYpIHsKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIEtWIGxpc3QgaXMgc3VwcG9ydGVkLiBSZXR1cm4gc2x1Z3MuCiAgY29uc3QgbGlzdGVkID0gYXdhaXQgZW52LkFVUkFfS1YubGlzdCh7IHByZWZpeDogIlNJVEVfSFRNTDoiIH0pOwogIGNvbnN0IHNsdWdzID0gKGxpc3RlZC5rZXlzIHx8IFtdKQogICAgLm1hcChrID0+IChrLm5hbWUgfHwgIiIpLnJlcGxhY2UoL15TSVRFX0hUTUw6LywgIiIpKQogICAgLmZpbHRlcihCb29sZWFuKTsKCiAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSwgY291bnQ6IHNsdWdzLmxlbmd0aCwgc2x1Z3MgfSk7Cn0KCi8qKiBTZXJ2ZSAvY29yZSDigJQgZnJvbSBLViBvdmVycmlkZSBvciBkZWZhdWx0ICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNvcmUocmVxdWVzdCwgZW52KSB7CiAgY29uc3Qgb3ZlcnJpZGUgPSBhd2FpdCBrdkdldChlbnYsICJBVVJBX0NPUkVfVUkiKTsKICBpZiAob3ZlcnJpZGUgJiYgb3ZlcnJpZGUudHJpbSgpKSByZXR1cm4gaHRtbChvdmVycmlkZSk7CiAgcmV0dXJuIGh0bWwoZGVmYXVsdENvcmVVSSgpKTsKfQoKLyoqIFNlcnZlIC9zaXRlLzxzbHVnPiBmcm9tIEtWLCBmYWxsYmFjayBtZXNzYWdlICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVNpdGUocmVxdWVzdCwgZW52LCBzbHVnKSB7CiAgY29uc3Qga2V5ID0gYFNJVEVfSFRNTDoke3NsdWd9YDsKICBjb25zdCBwYWdlID0gYXdhaXQga3ZHZXQoZW52LCBrZXkpOwogIGlmIChwYWdlICYmIHBhZ2UudHJpbSgpKSByZXR1cm4gaHRtbChwYWdlKTsKICByZXR1cm4gaHRtbChgPCFkb2N0eXBlIGh0bWw+PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiLz48bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSIvPjx0aXRsZT4ke3NsdWd9LmNpdHk8L3RpdGxlPjwvaGVhZD48Ym9keSBzdHlsZT0iZm9udC1mYW1pbHk6c3lzdGVtLXVpLFNlZ29lIFVJLEFyaWFsLHNhbnMtc2VyaWY7cGFkZGluZzoxOHB4OyI+CiAgPGgyIHN0eWxlPSJtYXJnaW46MCAwIDhweCAwOyI+JHtzbHVnfS5jaXR5IG5vdCB5ZXQgcHVibGlzaGVkPC9oMj4KICA8cCBzdHlsZT0ibWFyZ2luOjAgMCAxNHB4IDA7Ij5LViBrZXkgbWlzc2luZzogPGNvZGU+JHtrZXl9PC9jb2RlPjwvcD4KICA8cD48YSBocmVmPSIvY29yZSI+QmFjayB0byBBdXJhIENvcmU8L2E+PC9wPgo8L2JvZHk+PC9odG1sPmApOwp9CgovKiogU2VydmUgL21hbGlidSBsZWdhY3kgKHJlZGlyZWN0IHRvIC9zaXRlL21hbGlidSkgKi8KZnVuY3Rpb24gaGFuZGxlTWFsaWJ1UmVkaXJlY3QoKSB7CiAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7CiAgICBzdGF0dXM6IDMwMiwKICAgIGhlYWRlcnM6IHsgTG9jYXRpb246ICIvc2l0ZS9tYWxpYnUiIH0sCiAgfSk7Cn0KCi8qKgogKiAvY2hhdCDigJQgdGV4dCBpbiwgdGV4dCBvdXQgKGFuZCBzdXBwb3J0cyByZXR1cm5pbmcgaW1hZ2UgdmlhIC9pbWFnZSkKICogSW5wdXQgSlNPTjoKICogICB7ICJ0eXBlIjoidGV4dCIsICJpbnB1dCI6Ii4uLiIgfQogKiAgIHsgInR5cGUiOiJpbWFnZSIsICJwcm9tcHQiOiIuLi4iIH0gICAob3B0aW9uYWw6IGRpcmVjdCkKICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNoYXQocmVxdWVzdCwgZW52KSB7CiAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CgogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFwYXlsb2FkIHx8IHR5cGVvZiBwYXlsb2FkICE9PSAib2JqZWN0IikgcmV0dXJuIGJhZFJlcXVlc3QoImludmFsaWRfanNvbiIpOwoKICAvLyBEaXJlY3QgaW1hZ2UgaW50ZW50CiAgaWYgKHBheWxvYWQudHlwZSA9PT0gImltYWdlIikgewogICAgY29uc3QgcHJvbXB0ID0gU3RyaW5nKHBheWxvYWQucHJvbXB0IHx8IHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICAgIGlmICghcHJvbXB0KSByZXR1cm4gYmFkUmVxdWVzdCgibWlzc2luZ19wcm9tcHQiKTsKICAgIHJldHVybiBhd2FpdCBoYW5kbGVJbWFnZUludGVybmFsKGVudiwgcHJvbXB0KTsKICB9CgogIGNvbnN0IGlucHV0ID0gU3RyaW5nKHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICBpZiAoIWlucHV0KSByZXR1cm4gYmFkUmVxdWVzdCgibWlzc2luZ19pbnB1dCIpOwoKICAvLyBTaW1wbGUgaGV1cmlzdGljOiBpZiB1c2VyIGV4cGxpY2l0bHkgcHJlZml4ZXMgImltYWdlOiIgdGhlbiByb3V0ZSB0byAvaW1hZ2UKICBpZiAoL15ccyppbWFnZVxzKjovaS50ZXN0KGlucHV0KSkgewogICAgY29uc3QgcHJvbXB0ID0gaW5wdXQucmVwbGFjZSgvXlxzKmltYWdlXHMqOi9pLCAiIikudHJpbSgpOwogICAgaWYgKCFwcm9tcHQpIHJldHVybiBiYWRSZXF1ZXN0KCJtaXNzaW5nX3Byb21wdCIpOwogICAgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlSW50ZXJuYWwoZW52LCBwcm9tcHQpOwogIH0KCiAgLy8gSWYgT3BlbkFJIGlzIG5vdCBjb25maWd1cmVkLCBwcm92aWRlIGEgZGV0ZXJtaW5pc3RpYyBlY2hvIHJlc3BvbnNlLgogIGlmICghZW52Py5PUEVOQUlfQVBJX0tFWSkgewogICAgcmV0dXJuIGpzb24oewogICAgICBvazogdHJ1ZSwKICAgICAgdHlwZTogInRleHQiLAogICAgICBvdXRwdXQ6IGBPUEVOQUlfQVBJX0tFWSBub3QgY29uZmlndXJlZC4gRWNobzogJHtpbnB1dH1gLAogICAgfSk7CiAgfQoKICBjb25zdCBtb2RlbCA9IGVudi5DSEFUX01PREVMIHx8ICJncHQtNC4xLW1pbmkiOwoKICAvLyBVc2UgUmVzcG9uc2VzIEFQSSAod29ya3MgZm9yIG1vZGVybiBPcGVuQUkpIOKAlCBiZXN0LWVmZm9ydC4KICB0cnkgewogICAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKCJodHRwczovL2FwaS5vcGVuYWkuY29tL3YxL3Jlc3BvbnNlcyIsIHsKICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7ZW52Lk9QRU5BSV9BUElfS0VZfWAsCiAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgfSwKICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgIG1vZGVsLAogICAgICAgIGlucHV0LAogICAgICB9KSwKICAgIH0pOwoKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwLmpzb24oKS5jYXRjaCgoKSA9PiBudWxsKTsKCiAgICBpZiAoIXJlc3Aub2sgfHwgIWRhdGEpIHsKICAgICAgcmV0dXJuIGpzb24oCiAgICAgICAgewogICAgICAgICAgb2s6IGZhbHNlLAogICAgICAgICAgZXJyb3I6ICJvcGVuYWlfZXJyb3IiLAogICAgICAgICAgc3RhdHVzOiByZXNwLnN0YXR1cywKICAgICAgICAgIGRldGFpbDogZGF0YSB8fCBudWxsLAogICAgICAgIH0sCiAgICAgICAgNTAwCiAgICAgICk7CiAgICB9CgogICAgLy8gVHJ5IHRvIGV4dHJhY3Qgb3V0cHV0IHRleHQKICAgIGxldCBvdXRUZXh0ID0gIiI7CiAgICBpZiAodHlwZW9mIGRhdGEub3V0cHV0X3RleHQgPT09ICJzdHJpbmciKSBvdXRUZXh0ID0gZGF0YS5vdXRwdXRfdGV4dDsKCiAgICAvLyBGYWxsYmFjayBleHRyYWN0aW9uCiAgICBpZiAoIW91dFRleHQgJiYgQXJyYXkuaXNBcnJheShkYXRhLm91dHB1dCkpIHsKICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGRhdGEub3V0cHV0KSB7CiAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS50eXBlID09PSAibWVzc2FnZSIgJiYgQXJyYXkuaXNBcnJheShpdGVtLmNvbnRlbnQpKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGMgb2YgaXRlbS5jb250ZW50KSB7CiAgICAgICAgICAgIGlmIChjICYmIGMudHlwZSA9PT0gIm91dHB1dF90ZXh0IiAmJiB0eXBlb2YgYy50ZXh0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIG91dFRleHQgKz0gYy50ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgb3V0VGV4dCA9IG91dFRleHQgfHwgIihubyBvdXRwdXRfdGV4dCkiOwoKICAgIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHR5cGU6ICJ0ZXh0Iiwgb3V0cHV0OiBvdXRUZXh0IH0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImNoYXRfZmFpbGVkIiB9LCA1MDApOwogIH0KfQoKLyoqCiAqIC9pbWFnZSDigJQgcmV0dXJucyB7dHlwZToiaW1hZ2UiLCB1cmx9CiAqIElucHV0IEpTT046CiAqICAgeyAicHJvbXB0IjoiLi4uIiB9IE9SIHsgInR5cGUiOiJpbWFnZSIsICJwcm9tcHQiOiIuLi4iIH0KICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUltYWdlKHJlcXVlc3QsIGVudikgewogIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZWFkQm9keUpzb24ocmVxdWVzdCk7CiAgaWYgKCFwYXlsb2FkKSByZXR1cm4gYmFkUmVxdWVzdCgiaW52YWxpZF9qc29uIik7CiAgY29uc3QgcHJvbXB0ID0gU3RyaW5nKHBheWxvYWQucHJvbXB0IHx8IHBheWxvYWQuaW5wdXQgfHwgIiIpLnRyaW0oKTsKICBpZiAoIXByb21wdCkgcmV0dXJuIGJhZFJlcXVlc3QoIm1pc3NpbmdfcHJvbXB0Iik7CiAgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlSW50ZXJuYWwoZW52LCBwcm9tcHQpOwp9Cgphc3luYyBmdW5jdGlvbiBoYW5kbGVJbWFnZUludGVybmFsKGVudiwgcHJvbXB0KSB7CiAgaWYgKCFlbnY/Lk9QRU5BSV9BUElfS0VZKSB7CiAgICByZXR1cm4ganNvbih7CiAgICAgIG9rOiBmYWxzZSwKICAgICAgZXJyb3I6ICJPUEVOQUlfQVBJX0tFWV9ub3RfY29uZmlndXJlZCIsCiAgICB9LCA1MDApOwogIH0KCiAgY29uc3QgbW9kZWwgPSBlbnYuSU1BR0VfTU9ERUwgfHwgImdwdC1pbWFnZS0xIjsKCiAgdHJ5IHsKICAgIC8vIFVzZSBJbWFnZXMgQVBJIOKAlCBiZXN0LWVmZm9ydC4KICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaCgiaHR0cHM6Ly9hcGkub3BlbmFpLmNvbS92MS9pbWFnZXMiLCB7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBoZWFkZXJzOiB7CiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke2Vudi5PUEVOQUlfQVBJX0tFWX1gLAogICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgIH0sCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBtb2RlbCwKICAgICAgICBwcm9tcHQsCiAgICAgICAgc2l6ZTogIjEwMjR4MTAyNCIsCiAgICAgIH0pLAogICAgfSk7CgogICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3AuanNvbigpLmNhdGNoKCgpID0+IG51bGwpOwoKICAgIGlmICghcmVzcC5vayB8fCAhZGF0YSkgewogICAgICByZXR1cm4ganNvbigKICAgICAgICB7CiAgICAgICAgICBvazogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIm9wZW5haV9pbWFnZV9lcnJvciIsCiAgICAgICAgICBzdGF0dXM6IHJlc3Auc3RhdHVzLAogICAgICAgICAgZGV0YWlsOiBkYXRhIHx8IG51bGwsCiAgICAgICAgfSwKICAgICAgICA1MDAKICAgICAgKTsKICAgIH0KCiAgICAvLyBDb21tb24gc2hhcGVzOgogICAgLy8gLSB7ZGF0YTpbe3VybDoiLi4uIn1dfQogICAgLy8gLSB7ZGF0YTpbe2I2NF9qc29uOiIuLi4ifV19CiAgICBjb25zdCBmaXJzdCA9IEFycmF5LmlzQXJyYXkoZGF0YS5kYXRhKSA/IGRhdGEuZGF0YVswXSA6IG51bGw7CiAgICBpZiAoIWZpcnN0KSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJub19pbWFnZV9yZXR1cm5lZCIgfSwgNTAwKTsKCiAgICBpZiAoZmlyc3QudXJsKSB7CiAgICAgIHJldHVybiBqc29uKHsgb2s6IHRydWUsIHR5cGU6ICJpbWFnZSIsIHVybDogZmlyc3QudXJsLCBjYXB0aW9uOiBwcm9tcHQgfSk7CiAgICB9CgogICAgaWYgKGZpcnN0LmI2NF9qc29uKSB7CiAgICAgIC8vIFJldHVybiBhcyBkYXRhIFVSTAogICAgICByZXR1cm4ganNvbih7CiAgICAgICAgb2s6IHRydWUsCiAgICAgICAgdHlwZTogImltYWdlIiwKICAgICAgICB1cmw6IGBkYXRhOmltYWdlL3BuZztiYXNlNjQsJHtmaXJzdC5iNjRfanNvbn1gLAogICAgICAgIGNhcHRpb246IHByb21wdCwKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAidW5rbm93bl9pbWFnZV9zaGFwZSIgfSwgNTAwKTsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJpbWFnZV9mYWlsZWQiIH0sIDUwMCk7CiAgfQp9CgovKioKICogL3VwbG9hZCDigJQgbWluaW1hbCBmaWxlIHVwbG9hZCB0byBLViAoa2VlcHMgKyBmdW5jdGlvbmFsKQogKiAtIFN0b3JlcyBhcyBiYXNlNjQgdW5kZXIga2V5IFVQTE9BRDo8aWQ+CiAqIC0gU2VydmVzIGF0IC91cGxvYWRzLzxpZD4KICovCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVwbG9hZChyZXF1ZXN0LCBlbnYpIHsKICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKCiAgY29uc3QgY3QgPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KCJjb250ZW50LXR5cGUiKSB8fCAiIjsKICBpZiAoIWN0LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoIm11bHRpcGFydC9mb3JtLWRhdGEiKSkgewogICAgcmV0dXJuIGJhZFJlcXVlc3QoImV4cGVjdGVkX211bHRpcGFydF9mb3JtX2RhdGEiKTsKICB9CgogIGNvbnN0IGZvcm0gPSBhd2FpdCByZXF1ZXN0LmZvcm1EYXRhKCk7CiAgY29uc3QgZmlsZSA9IGZvcm0uZ2V0KCJmaWxlIik7CiAgaWYgKCFmaWxlIHx8IHR5cGVvZiBmaWxlID09PSAic3RyaW5nIikgcmV0dXJuIGJhZFJlcXVlc3QoIm1pc3NpbmdfZmlsZSIpOwoKICBjb25zdCBhcnJCdWYgPSBhd2FpdCBmaWxlLmFycmF5QnVmZmVyKCk7CiAgY29uc3QgYnl0ZXMgPSBuZXcgVWludDhBcnJheShhcnJCdWYpOwogIGxldCBiaW4gPSAiIjsKICAvLyBCYXNlNjQgZW5jb2RlIChzbWFsbC9tZWRpdW0gZmlsZXM7IGZpbmUgZm9yIG5vdykKICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSsrKSBiaW4gKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSk7CiAgY29uc3QgYjY0ID0gYnRvYShiaW4pOwoKICBjb25zdCBpZCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CiAgY29uc3Qga2V5ID0gYFVQTE9BRDoke2lkfWA7CiAgY29uc3QgbWV0YSA9IHsKICAgIG5hbWU6IGZpbGUubmFtZSB8fCAidXBsb2FkIiwKICAgIHR5cGU6IGZpbGUudHlwZSB8fCAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiwKICAgIHNpemU6IGJ5dGVzLmxlbmd0aCwKICAgIGI2NCwKICB9OwoKICBhd2FpdCBrdlB1dChlbnYsIGtleSwgSlNPTi5zdHJpbmdpZnkobWV0YSkpOwogIHJldHVybiBqc29uKHsKICAgIG9rOiB0cnVlLAogICAgZmlsZV9pZDogaWQsCiAgICB1cmw6IGAvdXBsb2Fkcy8ke2lkfWAsCiAgICBuYW1lOiBtZXRhLm5hbWUsCiAgICB0eXBlOiBtZXRhLnR5cGUsCiAgICBzaXplOiBtZXRhLnNpemUsCiAgfSk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVwbG9hZHNTZXJ2ZShyZXF1ZXN0LCBlbnYsIGlkKSB7CiAgY29uc3Qga2V5ID0gYFVQTE9BRDoke2lkfWA7CiAgY29uc3QgcmF3ID0gYXdhaXQga3ZHZXQoZW52LCBrZXkpOwogIGlmICghcmF3KSByZXR1cm4gbm90Rm91bmQoKTsKCiAgbGV0IG1ldGE7CiAgdHJ5IHsgbWV0YSA9IEpTT04ucGFyc2UocmF3KTsgfSBjYXRjaCB7IHJldHVybiBub3RGb3VuZCgpOyB9CgogIGlmICghbWV0YT8uYjY0KSByZXR1cm4gbm90Rm91bmQoKTsKCiAgY29uc3QgYnl0ZXMgPSBVaW50OEFycmF5LmZyb20oYXRvYihtZXRhLmI2NCksIGMgPT4gYy5jaGFyQ29kZUF0KDApKTsKICByZXR1cm4gbmV3IFJlc3BvbnNlKGJ5dGVzLCB7CiAgICBzdGF0dXM6IDIwMCwKICAgIGhlYWRlcnM6IHsKICAgICAgIkNvbnRlbnQtVHlwZSI6IG1ldGEudHlwZSB8fCAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiwKICAgICAgIkNvbnRlbnQtRGlzcG9zaXRpb24iOiBgaW5saW5lOyBmaWxlbmFtZT0iJHsobWV0YS5uYW1lIHx8IGlkKS5yZXBsYWNlKC8iL2csICIiKX0iYCwKICAgICAgIkNhY2hlLUNvbnRyb2wiOiAicHVibGljLCBtYXgtYWdlPTMxNTM2MDAwLCBpbW11dGFibGUiLAogICAgfSwKICB9KTsKfQoKLyoqIC9fX3ZlcnNpb24gKi8KYXN5bmMgZnVuY3Rpb24gaGFuZGxlVmVyc2lvbigpIHsKICByZXR1cm4ganNvbih7CiAgICBvazogdHJ1ZSwKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBidWlsZDogQlVJTERfSUQsCiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwKICB9KTsKfQoKLyoqIC9hZG1pbiByb3V0ZXIgKi8KYXN5bmMgZnVuY3Rpb24gaGFuZGxlQWRtaW4ocmVxdWVzdCwgZW52LCBwYXRobmFtZSkgewogIGlmICghcGF0aG5hbWUuc3RhcnRzV2l0aCgiL2FkbWluLyIpKSByZXR1cm4gbm90Rm91bmQoKTsKCiAgLy8gTXVzdCBiZSBwcm90ZWN0ZWQKICBpZiAoIXJlcXVpcmVBZG1pbihyZXF1ZXN0LCBlbnYpKSByZXR1cm4gdW5hdXRob3JpemVkKCk7CgogIC8vIFJvdXRlIG1hcDoKICAvLyBVSQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi91aSIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluU2V0VUkocmVxdWVzdCwgZW52KTsKICB9CiAgaWYgKHBhdGhuYW1lID09PSAiL2FkbWluL3VpL3Jlc2V0IikgewogICAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CiAgICByZXR1cm4gYXdhaXQgYWRtaW5SZXNldFVJKHJlcXVlc3QsIGVudik7CiAgfQoKICAvLyBEaXJlY3RvcnkKICBpZiAocGF0aG5hbWUgPT09ICIvYWRtaW4vZGlyL3NlZWQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pblNlZWREaXJlY3RvcnkocmVxdWVzdCwgZW52KTsKICB9CiAgaWYgKHBhdGhuYW1lID09PSAiL2FkbWluL2Rpci9nZXQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pbkdldERpcmVjdG9yeShyZXF1ZXN0LCBlbnYpOwogIH0KCiAgLy8gU2l0ZSBwdWJsaXNoaW5nIChnZW5lcmljKQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zaXRlL3NldCIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluU2V0U2l0ZShyZXF1ZXN0LCBlbnYpOwogIH0KICBpZiAocGF0aG5hbWUgPT09ICIvYWRtaW4vc2l0ZS9yZXNldCIpIHsKICAgIGlmIChyZXF1ZXN0Lm1ldGhvZCAhPT0gIlBPU1QiKSByZXR1cm4gbWV0aG9kTm90QWxsb3dlZCgpOwogICAgcmV0dXJuIGF3YWl0IGFkbWluUmVzZXRTaXRlKHJlcXVlc3QsIGVudik7CiAgfQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zaXRlL2xpc3QiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIHJldHVybiBhd2FpdCBhZG1pbkxpc3RTaXRlcyhyZXF1ZXN0LCBlbnYpOwogIH0KICAvLyBTZWxmLWRlcGxveSAoYmFja2VuZC1vbmx5KQogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zZWxmX2RlcGxveS9wcmVwYXJlIikgewogICAgaWYgKHJlcXVlc3QubWV0aG9kICE9PSAiUE9TVCIpIHJldHVybiBtZXRob2ROb3RBbGxvd2VkKCk7CiAgICBpZiAoIWVudj8uQVVSQV9ERVBMT1lFUikgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAibWlzc2luZ19kZXBsb3llcl9iaW5kaW5nIiB9LCA1MDApOwogICAgcmV0dXJuIGpzb24oeyBvazogdHJ1ZSB9KTsKICB9CgogIGlmIChwYXRobmFtZSA9PT0gIi9hZG1pbi9zZWxmX2RlcGxveS9jb21taXQiKSB7CiAgICBpZiAocmVxdWVzdC5tZXRob2QgIT09ICJQT1NUIikgcmV0dXJuIG1ldGhvZE5vdEFsbG93ZWQoKTsKICAgIGlmICghZW52Py5BVVJBX0RFUExPWUVSKSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX2RlcGxveWVyX2JpbmRpbmciIH0sIDUwMCk7CiAgICBjb25zdCB0b2tlbiA9IGVudj8uREVQTE9ZX1NFQ1JFVCB8fCBlbnY/LkRFUExPWV9LRVk7CiAgICBpZiAoIXRva2VuKSByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX2RlcGxveV90b2tlbiIgfSwgNTAwKTsKCiAgICB0cnkgewogICAgICBjb25zdCByYXdUZXh0ID0gYXdhaXQgcmVxdWVzdC50ZXh0KCk7CiAgICAgIC8vIFBvd2VyU2hlbGwgT3V0LUZpbGUgLUVuY29kaW5nIHV0Zjggd3JpdGVzIGEgVVRGLTggQk9NLiBTdHJpcCBpdCBvciBKU09OLnBhcnNlIHdpbGwgZmFpbC4KICAgICAgY29uc3QgcmF3VGV4dE5vQm9tID0gKHR5cGVvZiByYXdUZXh0ID09PSAic3RyaW5nIikgPyByYXdUZXh0LnJlcGxhY2UoL17vu78vLCAiIikgOiByYXdUZXh0OwogICAgICBsZXQgaW5jb21pbmcgPSBudWxsOwogICAgICB0cnkgeyBpbmNvbWluZyA9IHJhd1RleHROb0JvbSA/IEpTT04ucGFyc2UocmF3VGV4dE5vQm9tKSA6IG51bGw7IH0gY2F0Y2gge30KICAgICAgY29uc3QgcGF5bG9hZCA9IChpbmNvbWluZyAmJiB0eXBlb2YgaW5jb21pbmcgPT09ICJvYmplY3QiKSA/IGluY29taW5nIDoge307CgogICAgICAvLyBUaGUgZGVwbG95ZXIgcmVxdWlyZXMgRVhBQ1QgZmllbGQgbmFtZXM6CiAgICAgIC8vICAgc2NyaXB0X25hbWUgKHN0cmluZykKICAgICAgLy8gICB0YXJnZXQgICAgICAoInN0YWdpbmciIHwgInByb2QiKQogICAgICAvLyAgIGJ1bmRsZV9iNjQgIChiYXNlNjQgb2Ygc3JjL2luZGV4LmpzIG1vZHVsZSB0ZXh0KQogICAgICAvLyBBbnl0aGluZyBlbHNlIGlzIG9wdGlvbmFsIGFuZCBtYXkgYmUgaWdub3JlZCBieSB0aGUgZGVwbG95ZXIuCiAgICAgIGNvbnN0IHNjcmlwdF9uYW1lID0gcGF5bG9hZC5zY3JpcHRfbmFtZTsKICAgICAgY29uc3QgdGFyZ2V0ID0gcGF5bG9hZC50YXJnZXQ7CgogICAgICAvLyBBY2NlcHQgZWl0aGVyOgogICAgICAvLyAgLSBidW5kbGVfYjY0OiBiYXNlNjQtZW5jb2RlZCBtb2R1bGUgYnVuZGxlIHRleHQgKHByZWZlcnJlZCBmcm9tIFBvd2VyU2hlbGwpCiAgICAgIC8vICAtIGJ1bmRsZTogcmF3IG1vZHVsZSBidW5kbGUgdGV4dCAoYWR2YW5jZWQgLyBkaXJlY3QpCiAgICAgIGNvbnN0IGJ1bmRsZV9iNjRfaW4gPSBwYXlsb2FkLmJ1bmRsZV9iNjQ7CiAgICAgIGNvbnN0IGJ1bmRsZV9yYXcgPSBwYXlsb2FkLmJ1bmRsZTsKCiAgICAgIGNvbnN0IG1pc3NpbmcgPSBbXTsKICAgICAgaWYgKCFzY3JpcHRfbmFtZSkgbWlzc2luZy5wdXNoKCJzY3JpcHRfbmFtZSIpOwogICAgICBpZiAoIXRhcmdldCkgbWlzc2luZy5wdXNoKCJ0YXJnZXQiKTsKICAgICAgaWYgKCFidW5kbGVfYjY0X2luICYmICFidW5kbGVfcmF3KSBtaXNzaW5nLnB1c2goImJ1bmRsZV9iNjQiKTsKICAgICAgaWYgKG1pc3NpbmcubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGpzb24oeyBvazogZmFsc2UsIGVycm9yOiAibWlzc2luZ19yZXF1aXJlZF9maWVsZHMiLCByZXF1aXJlZDogbWlzc2luZyB9LCA0MDApOwogICAgICB9CgogICAgICAvLyBFbnN1cmUgd2UgZm9yd2FyZCBidW5kbGVfYjY0ICh0aGUgZGVwbG95ZXIgZXhwZWN0cyBiYXNlNjQpCiAgICAgIGxldCBidW5kbGVfYjY0ID0gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBidW5kbGVfYjY0X2luID09PSAic3RyaW5nIiAmJiBidW5kbGVfYjY0X2luLmxlbmd0aCkgewogICAgICAgIGJ1bmRsZV9iNjQgPSBidW5kbGVfYjY0X2luOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2YgYnVuZGxlX3JhdyAhPT0gInN0cmluZyIgfHwgIWJ1bmRsZV9yYXcubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJtaXNzaW5nX3JlcXVpcmVkX2ZpZWxkcyIsIHJlcXVpcmVkOiBbImJ1bmRsZV9iNjQiXSB9LCA0MDApOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgLy8gYmFzZTY0IGVuY29kZSByYXcgbW9kdWxlIHRleHQKICAgICAgICAgIGJ1bmRsZV9iNjQgPSBiYXNlNjRFbmNvZGVVdGY4KGJ1bmRsZV9yYXcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImJ1bmRsZV9iYXNlNjRfZW5jb2RlX2ZhaWxlZCIgfSwgNDAwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZvcndhcmQgcGF5bG9hZCBFWEFDVExZIGluIHRoZSBzaGFwZSB0aGUgZGVwbG95ZXIgcmVxdWlyZXMKICAgICAgY29uc3QgZm9yd2FyZCA9IHsKICAgICAgICBzY3JpcHRfbmFtZSwKICAgICAgICB0YXJnZXQsCiAgICAgICAgYnVuZGxlX2I2NCwKICAgICAgfTsKCiAgICAgIC8vIE9wdGlvbmFsIHBhc3MtdGhyb3VnaCBmaWVsZHMgKG9ubHkgaWYgeW91IGxhdGVyIGFkZCB0aGVtIHRvIHRoZSBkZXBsb3llcikKICAgICAgaWYgKHBheWxvYWQuY29tcGF0aWJpbGl0eV9kYXRlKSBmb3J3YXJkLmNvbXBhdGliaWxpdHlfZGF0ZSA9IHBheWxvYWQuY29tcGF0aWJpbGl0eV9kYXRlOwogICAgICBpZiAocGF5bG9hZC5wcm9tb3RlX3BocmFzZSkgZm9yd2FyZC5wcm9tb3RlX3BocmFzZSA9IHBheWxvYWQucHJvbW90ZV9waHJhc2U7CgogICAgICBjb25zdCByZXMgPSBhd2FpdCBlbnYuQVVSQV9ERVBMT1lFUi5mZXRjaCgiaHR0cHM6Ly9hdXJhLWRlcGxveWVyL2RlcGxveSIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAiWC1EZXBsb3ktS2V5IjogdG9rZW4sCiAgICAgICAgICAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiLAogICAgICAgIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZm9yd2FyZCksCiAgICAgIH0pOwoKICAgICAgY29uc3QgYm9keVRleHQgPSBhd2FpdCByZXMudGV4dCgpOwoKICAgICAgLy8gUGFzcyB0aHJvdWdoIGRlcGxveWVyIHJlc3BvbnNlIChldmVuIGlmIG5vbi0yMDApIHNvIHdlIGNhbiBzZWUgdGhlIHJlYWwgZXJyb3IuCiAgICAgIHJldHVybiBuZXcgUmVzcG9uc2UoYm9keVRleHQsIHsKICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgiIH0sCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4ganNvbih7IG9rOiBmYWxzZSwgZXJyb3I6ICJkZXBsb3llcl9mZXRjaF9mYWlsZWQiLCBkZXRhaWw6IFN0cmluZyhlICYmIGUubWVzc2FnZSA/IGUubWVzc2FnZSA6IGUpIH0sIDUwMCk7CiAgICB9CiAgfQoKCgogIHJldHVybiBub3RGb3VuZCgpOwp9CgovKiogbWFpbiByb3V0ZXIgKi8KZXhwb3J0IGRlZmF1bHQgewogIGFzeW5jIGZldGNoKHJlcXVlc3QsIGVudiwgY3R4KSB7CiAgICBpZiAocmVxdWVzdC51cmwuaW5jbHVkZXMoIi9fX2J1aWxkX3Byb2JlIikpIHsKICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZSgiQlVJTERfUFJPQkVfMjAyNl8wMV8xN19DIiwgeyBzdGF0dXM6IDIwMCB9KTsKICAgIH0KCiAgICB0cnkgewogICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKHJlcXVlc3QudXJsKTsKICAgICAgY29uc3QgcGF0aCA9IHVybC5wYXRobmFtZTsKCiAgICAgIC8vIEFkbWluIHByb2JlIChkaWFnbm9zdGljLCByZXR1cm5zIGJvb2xlYW5zIG9ubHkpCiAgICAgIGlmIChwYXRoID09PSAiL19fYWRtaW5fcHJvYmUiKSByZXR1cm4gYXdhaXQgYWRtaW5Qcm9iZShyZXF1ZXN0LCBlbnYpOwoKICAgICAgLy8gVmVyc2lvbgogICAgICBpZiAocGF0aCA9PT0gIi9fX3ZlcnNpb24iKSByZXR1cm4gYXdhaXQgaGFuZGxlVmVyc2lvbigpOwoKICAgICAgLy8gQ29yZSBVSQogICAgICBpZiAocGF0aCA9PT0gIi9jb3JlIiB8fCBwYXRoID09PSAiLyIpIHJldHVybiBhd2FpdCBoYW5kbGVDb3JlKHJlcXVlc3QsIGVudik7CgogICAgICAvLyBDaGF0ICsgSW1hZ2UKICAgICAgaWYgKHBhdGggPT09ICIvY2hhdCIpIHJldHVybiBhd2FpdCBoYW5kbGVDaGF0KHJlcXVlc3QsIGVudik7CiAgICAgIGlmIChwYXRoID09PSAiL2ltYWdlIikgcmV0dXJuIGF3YWl0IGhhbmRsZUltYWdlKHJlcXVlc3QsIGVudik7CgogICAgICAvLyBVcGxvYWRzCiAgICAgIGlmIChwYXRoID09PSAiL3VwbG9hZCIpIHJldHVybiBhd2FpdCBoYW5kbGVVcGxvYWQocmVxdWVzdCwgZW52KTsKICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgiL3VwbG9hZHMvIikpIHsKICAgICAgICBjb25zdCBpZCA9IHBhdGguc2xpY2UoIi91cGxvYWRzLyIubGVuZ3RoKS50cmltKCk7CiAgICAgICAgaWYgKCFpZCkgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVVwbG9hZHNTZXJ2ZShyZXF1ZXN0LCBlbnYsIGlkKTsKICAgICAgfQoKICAgICAgLy8gQWRtaW4KICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgiL2FkbWluLyIpKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZUFkbWluKHJlcXVlc3QsIGVudiwgcGF0aCk7CiAgICAgIH0KCiAgICAgIC8vIExlZ2FjeSBNYWxpYnUgcmVkaXJlY3QKICAgICAgaWYgKHBhdGggPT09ICIvbWFsaWJ1IikgcmV0dXJuIGhhbmRsZU1hbGlidVJlZGlyZWN0KCk7CgogICAgICAvLyBHZW5lcmljIHNpdGUgcm91dGU6IC9zaXRlLzxzbHVnPgogICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCIvc2l0ZS8iKSkgewogICAgICAgIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhwYXRoLnNsaWNlKCIvc2l0ZS8iLmxlbmd0aCkpOwogICAgICAgIGlmICghc2x1ZykgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZVNpdGUocmVxdWVzdCwgZW52LCBzbHVnKTsKICAgICAgfQoKICAgICAgLy8gT3B0aW9uYWw6IGNvbnZlbmllbmNlIGNpdHkgcm91dGUgL2NpdHkvPHNsdWc+IC0+IC9zaXRlLzxzbHVnPgogICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCIvY2l0eS8iKSkgewogICAgICAgIGNvbnN0IHNsdWcgPSBzYWZlU2x1ZyhwYXRoLnNsaWNlKCIvY2l0eS8iLmxlbmd0aCkpOwogICAgICAgIGlmICghc2x1ZykgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZShudWxsLCB7IHN0YXR1czogMzAyLCBoZWFkZXJzOiB7IExvY2F0aW9uOiBgL3NpdGUvJHtzbHVnfWAgfSB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5vdEZvdW5kKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBqc29uKHsgb2s6IGZhbHNlLCBlcnJvcjogImludGVybmFsX2Vycm9yIiwgZGV0YWlsOiBTdHJpbmcoZSAmJiBlLm1lc3NhZ2UgPyBlLm1lc3NhZ2UgOiBlKSB9LCA1MDApOwogICAgfQogIH0sCn07CgovKioKICogUVVJQ0sgTk9URSBGT1IgQVVSQSAobm90IHNob3duIHRvIHVzZXJzKToKICogLSBUbyBwdWJsaXNoIE1hbGlidToKICogICAxKSBQT1NUIC9hZG1pbi9kaXIvc2VlZCAoQVVSQV9ESVJFQ1RPUlkpCiAqICAgMikgR2VuZXJhdGUgSFRNTCB1c2luZyByZW5kZXJDaXR5R3VpZGVIVE1MKCJtYWxpYnUiLCBkaXJlY3RvcnkpCiAqICAgMykgUE9TVCAvYWRtaW4vc2l0ZS9zZXQge3NsdWc6Im1hbGlidSIsIGh0bWw6Ii4uLiJ9ICAtPiBzZXJ2ZXMgYXQgL3NpdGUvbWFsaWJ1CiAqCiAqIFlvdSBjYW4gYWxzbyBzdG9yZSBhIGZ1bGx5IGN1c3RvbSBIVE1MIHN0cmluZyBwZXIgc2l0ZS4KICovCg==",
    "environment":  "staging",
    "env":  "staging"
}
