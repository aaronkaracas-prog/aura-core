export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    const cors = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type,Authorization",
      "Access-Control-Max-Age": "86400",
    };

    if (request.method === "OPTIONS") return new Response(null, { status: 204, headers: cors });

    const adminToken = env.AURA_ADMIN_TOKEN || "";
    const auth = request.headers.get("authorization") || "";
    const isAdmin = adminToken && auth === `Bearer ${adminToken}`;

    const json = (obj, status = 200) =>
      new Response(JSON.stringify(obj), { status, headers: { "Content-Type": "application/json", ...cors } });

    const text = (body, status = 200, contentType = "text/plain; charset=utf-8") =>
      new Response(body, { status, headers: { "Content-Type": contentType, ...cors } });

    const requireAdmin = () => (isAdmin ? null : json({ ok: false, error: "unauthorized" }, 401));

    // -------------------------
    // HEALTH
    // -------------------------
    if (request.method === "GET" && url.pathname === "/health") {
      return json({
        ok: true,
        service: "aura-core",
        upload: !!env.AURA_UPLOADS,
        control: true,
        ui: "r2-first",
        assets: "r2",
        memory: "r2",
        launch: "enabled",
        integrations: "enabled",
      });
    }

    // -------------------------
    // UI (R2-first)
    // -------------------------
    if (request.method === "GET" && url.pathname === "/") {
      if (env.AURA_UPLOADS) {
        const obj = await env.AURA_UPLOADS.get("ui/index.html");
        if (obj) return text(await obj.text(), 200, "text/html; charset=utf-8");
      }
      return text("Aura UI missing. POST /ui to set ui/index.html", 200);
    }

    // POST /ui (admin) -> ui/index.html
    if (request.method === "POST" && url.pathname === "/ui") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const html = await request.text();
      if (!html || html.length < 50) return json({ ok: false, error: "UI body too small." }, 400);

      await env.AURA_UPLOADS.put("ui/index.html", html, {
        httpMetadata: { contentType: "text/html; charset=utf-8" },
      });
      return json({ ok: true, saved: "ui/index.html", bytes: html.length });
    }

    // -------------------------
    // ASSETS (R2)
    // -------------------------
    if (request.method === "GET" && url.pathname === "/assets") {
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);
      const obj = await env.AURA_UPLOADS.get("config/assets.json");
      const assets = obj ? JSON.parse(await obj.text()) : [];
      return json({ ok: true, assets });
    }

    if (request.method === "POST" && url.pathname === "/assets") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const body = await request.text();
      let assets;
      try { assets = JSON.parse(body); } catch { return json({ ok: false, error: "Invalid JSON." }, 400); }
      if (!Array.isArray(assets)) return json({ ok: false, error: "Expected an array." }, 400);

      await env.AURA_UPLOADS.put("config/assets.json", JSON.stringify(assets, null, 2), {
        httpMetadata: { contentType: "application/json; charset=utf-8" },
      });

      return json({ ok: true, saved: "config/assets.json", count: assets.length });
    }

    // -------------------------
    // MEMORY (R2) — dump lives here
    // -------------------------
    if (request.method === "POST" && url.pathname === "/memory") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const txtBody = await request.text();
      if (!txtBody || txtBody.length < 20) return json({ ok: false, error: "Memory body too small." }, 400);

      await env.AURA_UPLOADS.put("config/ark_dump.txt", txtBody, {
        httpMetadata: { contentType: "text/plain; charset=utf-8" },
      });

      return json({ ok: true, saved: "config/ark_dump.txt", bytes: txtBody.length });
    }

    // Optional: GET /memory (admin) — read back dump
    if (request.method === "GET" && url.pathname === "/memory") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);
      const obj = await env.AURA_UPLOADS.get("config/ark_dump.txt");
      if (!obj) return json({ ok: false, error: "No memory stored yet." }, 404);
      return text(await obj.text(), 200, "text/plain; charset=utf-8");
    }

    // -------------------------
    // UPLOAD (R2) — your existing file upload
    // -------------------------
    if (request.method === "POST" && url.pathname === "/upload") {
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const ct = request.headers.get("content-type") || "";
      if (!ct.includes("multipart/form-data")) {
        return json({ ok: false, error: "Expected multipart/form-data with field 'file'." }, 400);
      }

      const form = await request.formData();
      const file = form.get("file");
      if (!file || typeof file === "string") return json({ ok: false, error: "Missing field 'file'." }, 400);

      const original = file.name || "upload.bin";
      const safe = original.replace(/[^\w.\-]+/g, "_");
      const key = `${Date.now()}-${crypto.randomUUID()}-${safe}`;

      await env.AURA_UPLOADS.put(key, file.stream(), {
        httpMetadata: { contentType: file.type || "application/octet-stream" },
        customMetadata: { originalName: original },
      });

      return json({ ok: true, key, originalName: original, size: file.size, contentType: file.type || null });
    }

    // -------------------------
    // LAUNCH SHELLS — /launch/<slug>
    // Uses assets.json if present; otherwise generic page.
    // -------------------------
    if (request.method === "GET" && url.pathname.startsWith("/launch/")) {
      const slug = url.pathname.split("/").filter(Boolean)[1] || "";
      const nameGuess = slug.replace(/[-_]+/g, " ").replace(/\b\w/g, m => m.toUpperCase());

      let match = null;
      if (env.AURA_UPLOADS) {
        const obj = await env.AURA_UPLOADS.get("config/assets.json");
        if (obj) {
          const assets = JSON.parse(await obj.text());
          match = assets.find(a => (a.slug && a.slug === slug) || (a.name && a.name.toLowerCase().replace(/\s+/g, "-") === slug));
        }
      }

      const title = (match && match.name) ? match.name : nameGuess;
      const href = (match && match.url) ? match.url : "";

      const html = `<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title>
<style>
body{font-family:system-ui;margin:22px;background:#fafafa}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:16px;box-shadow:0 1px 8px rgba(0,0,0,.04)}
a{color:inherit}
button{padding:10px 12px;border:1px solid #ccc;border-radius:12px;background:#fff;cursor:pointer}
button:hover{background:#f4f4f4}
.muted{color:#666;font-size:12px;margin-top:8px}
</style></head>
<body>
<div class="card">
  <h2 style="margin:0">${title}</h2>
  <div class="muted">ARK Systems • Aura Launch Shell</div>
  ${href ? `<p><a href="${href}" target="_blank" rel="noreferrer">${href}</a></p>` : `<p class="muted">No URL is set yet for this asset.</p>`}
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    ${href ? `<button onclick="window.open('${href}','_blank')">Open</button>` : ``}
    <button onclick="window.location.href='/'">Back to Aura</button>
  </div>
</div>
</body></html>`;
      return text(html, 200, "text/html; charset=utf-8");
    }

    // -------------------------
    // INTEGRATIONS SCAFFOLD (R2)
    // - GET /integrations (admin): list configured integrations json
    // - POST /integrations (admin): set config/integrations.json
    // -------------------------
    if (request.method === "GET" && url.pathname === "/integrations") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const obj = await env.AURA_UPLOADS.get("config/integrations.json");
      const integrations = obj ? JSON.parse(await obj.text()) : [];
      return json({ ok: true, integrations });
    }

    if (request.method === "POST" && url.pathname === "/integrations") {
      const err = requireAdmin();
      if (err) return err;
      if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS binding missing." }, 500);

      const body = await request.text();
      let integrations;
      try { integrations = JSON.parse(body); } catch { return json({ ok: false, error: "Invalid JSON." }, 400); }
      if (!Array.isArray(integrations)) return json({ ok: false, error: "Expected an array." }, 400);

      await env.AURA_UPLOADS.put("config/integrations.json", JSON.stringify(integrations, null, 2), {
        httpMetadata: { contentType: "application/json; charset=utf-8" },
      });

      return json({ ok: true, saved: "config/integrations.json", count: integrations.length });
    }

    // -------------------------
    // SALESFORCE CONNECTOR SLOT (admin)
    // This will work once you set these secrets:
    // - SF_INSTANCE_URL  (e.g. https://yourDomain.my.salesforce.com)
    // - SF_ACCESS_TOKEN  (OAuth access token)
    //
    // GET /salesforce/whoami -> verifies connection
    // -------------------------
    if (request.method === "GET" && url.pathname === "/salesforce/whoami") {
      const err = requireAdmin();
      if (err) return err;

      const instanceUrl = env.SF_INSTANCE_URL || "";
      const token = env.SF_ACCESS_TOKEN || "";
      if (!instanceUrl || !token) {
        return json({ ok: false, error: "Salesforce not configured. Missing SF_INSTANCE_URL or SF_ACCESS_TOKEN." }, 400);
      }

      const r = await fetch(`${instanceUrl}/services/oauth2/userinfo`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      const t = await r.text();
      return new Response(t, { status: r.status, headers: { "Content-Type": r.headers.get("content-type") || "application/json", ...cors } });
    }

    // -------------------------
    // COMMAND LOOP (admin)
    // Minimal for now: acknowledges commands and provides hooks
    // -------------------------
    if (request.method === "POST" && url.pathname === "/command") {
      const err = requireAdmin();
      if (err) return err;

      let body = null;
      try { body = await request.json(); } catch { body = { raw: await request.text() }; }

      // Built-in verbs (starter)
      const txt = (body && body.text) ? String(body.text).trim() : "";
      const lower = txt.toLowerCase();

      if (lower === "ping") return json({ ok: true, aura: "listening", received: body });

      if (lower === "list assets") {
        if (!env.AURA_UPLOADS) return json({ ok: false, error: "AURA_UPLOADS missing." }, 500);
        const obj = await env.AURA_UPLOADS.get("config/assets.json");
        const assets = obj ? JSON.parse(await obj.text()) : [];
        return json({ ok: true, assets });
      }

      if (lower.startsWith("open ")) {
        const name = txt.slice(5).trim();
        return json({ ok: true, action: "open", name, note: "Client UI should open matching asset URL." });
      }

      return json({ ok: true, accepted: true, aura: "listening", received: body });
    }

    return text("Not Found", 404);
  },
};
